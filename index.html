<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PGA League System, By Kamal Dhunna</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* EXTREMELY COMPACT STYLES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #0f2c47;
            color: #e6f2ff;
            padding: 4px;
            font-size: 11px;
            line-height: 1.2;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: #1a4267;
            border-radius: 4px;
            overflow: hidden;
        }
        
        /* ULTRA COMPACT HEADER */
        .app-header {
            background: linear-gradient(135deg, #0a3d2e 0%, #1a6b4f 100%);
            color: white;
            padding: 6px 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 8px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 0;
        }
        
        .logo-section i {
            font-size: 16px;
            color: #d4af37;
        }
        
        .logo-section h1 {
            font-size: 14px;
            font-weight: 700;
            white-space: nowrap;
        }
        
        .app-description {
            font-size: 9px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* SUPER COMPACT TABS (NOW 3 TABS) */
        .tabs {
            display: flex;
            background: linear-gradient(135deg, #1a6b4f 0%, #2a8b6f 100%);
            border-bottom: 1px solid #d4af37;
        }
        
        .tab {
            flex: 1;
            padding: 4px 6px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            font-size: 10px;
            transition: all 0.2s ease;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            min-width: 80px;
            white-space: nowrap;
        }
        
        .tab:last-child {
            border-right: none;
        }
        
        .tab:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }
        
        .tab.active {
            background-color: #d4af37;
            color: #0a3d2e;
            font-weight: 700;
        }
        
        .tab i {
            font-size: 10px;
            margin-right: 3px;
        }
        
        /* TAB CONTENT */
        .tab-content {
            display: none;
            padding: 6px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ULTRA COMPACT SECTION STYLES */
        .section {
            margin-bottom: 8px;
            padding: 8px;
            border: 1px solid #3d6b99;
            border-radius: 3px;
            background-color: #2c4f7c;
        }
        
        .section h2 {
            color: #ffffff;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #4a90e2;
            font-size: 11px;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .section h2 i {
            font-size: 10px;
            color: #d4af37;
        }
        
        /* MICRO BUTTONS */
        button {
            padding: 3px 6px;
            background-color: #4a90e2;
            color: white;
            border: none;
            border-radius: 2px;
            font-weight: 600;
            cursor: pointer;
            font-size: 9px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 3px;
            margin: 2px;
            height: 20px;
        }
        
        button:hover {
            background-color: #357abd;
        }
        
        button.secondary {
            background-color: #6c757d;
        }
        
        button.secondary:hover {
            background-color: #5a6268;
        }
        
        button.danger {
            background-color: #e74c3c;
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        button.success {
            background-color: #28a745;
        }
        
        button.success:hover {
            background-color: #218838;
        }
        
        button.warning {
            background-color: #d4af37;
            color: #0a3d2e;
        }
        
        button.warning:hover {
            background-color: #b8941f;
        }
        
        /* BEST SCORES DROPDOWN STYLES */
        .best-scores-selector {
            position: relative;
            display: inline-block;
        }
        
        .best-scores-button {
            background: #d4af37;
            padding: 3px 6px;
            font-size: 9px;
            height: 20px;
            color: #0a3d2e;
        }
        
        .best-scores-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            background: #2c4f7c;
            border: 1px solid #4a6fa5;
            border-radius: 2px;
            min-width: 100px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: all 0.2s ease;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .best-scores-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .best-scores-option {
            padding: 4px 6px;
            cursor: pointer;
            font-size: 9px;
            transition: background-color 0.2s ease;
            color: #e6f2ff;
            white-space: nowrap;
        }
        
        .best-scores-option:hover {
            background: #3a5a8a;
        }
        
        .best-scores-option.active {
            background-color: #4a90e2;
            font-weight: 600;
        }
        
        /* TINY FORM ELEMENTS */
        input, select, textarea {
            width: 100%;
            padding: 3px 5px;
            margin-top: 2px;
            background-color: #ffffff !important;
            border: 1px solid #ccc !important;
            color: #333333 !important;
            border-radius: 2px;
            font-size: 9px;
            height: 20px;
        }
        
        textarea {
            height: 40px;
            min-height: 40px;
            resize: vertical;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4a90e2 !important;
            box-shadow: 0 0 0 1px rgba(74, 144, 226, 0.2);
            background-color: #ffffff !important;
            color: #333333 !important;
        }
        
        /* MICRO BUTTON GROUP */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 3px;
            margin: 4px 0;
        }
        
        /* LEAGUE STANDINGS - EXTRA COMPACT & RESPONSIVE */
        .league-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
            flex-wrap: wrap;
            gap: 4px;
        }
        
        /* NEW: Dynamic table container */
        .table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            background-color: white;
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            margin-bottom: 6px;
        }
        
        /* NEW: Dynamic table that fits screen */
        #standings-table {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            table-layout: auto;
        }
        
        #standings-table thead {
            background-color: #1a6b4f;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        #standings-table th {
            padding: 4px 2px;
            text-align: center;
            font-weight: 700;
            font-size: 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
            height: 22px;
            overflow: hidden;
            min-width: 22px;
        }
        
        /* Fixed width for first columns */
        #standings-table th:first-child {
            position: sticky;
            left: 0;
            background-color: #1a6b4f;
            color: white;
            z-index: 50;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }
        
        #standings-table th:nth-child(2) {
            position: sticky;
            left: 30px;
            background-color: #1a6b4f;
            color: white;
            z-index: 50;
            text-align: left;
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            padding-left: 4px;
        }
        
        /* Action column */
        #standings-table th:last-child {
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            position: sticky;
            right: 0;
            background-color: #1a6b4f;
            z-index: 50;
        }
        
        #standings-table td:first-child {
            position: sticky;
            left: 0;
            background-color: #1a6b4f;
            color: white;
            z-index: 40;
            font-weight: 700;
            text-align: center;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }
        
        #standings-table td:nth-child(2) {
            position: sticky;
            left: 30px;
            background-color: white;
            z-index: 40;
            text-align: left;
            font-weight: 600;
            color: #0a3d2e;
            padding-left: 4px;
            width: 100px;
            min-width: 100px;
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Action column cell */
        #standings-table td:last-child {
            position: sticky;
            right: 0;
            background-color: white;
            z-index: 40;
            width: 40px;
            min-width: 40px;
            max-width: 40px;
            padding: 0;
            text-align: center;
        }
        
        #standings-table th.wk-header {
            background-color: #0a3d2e;
            font-size: 7px;
            min-width: 22px;
            width: auto;
        }
        
        #standings-table th.total-header {
            background-color: #2a8b6f;
            min-width: 30px;
            width: 30px;
        }
        
        /* Weekly score cells - dynamic width */
        #standings-table td:not(:first-child):not(:nth-child(2)):not(:last-child):not(.total-cell) {
            min-width: 22px;
            width: auto;
        }
        
        #standings-table tbody tr {
            border-bottom: 1px solid #eee;
            height: 22px;
        }
        
        #standings-table tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        #standings-table td {
            padding: 2px;
            text-align: center;
            border-right: 1px solid #eee;
            height: 22px;
            color: #333;
            font-size: 9px;
            overflow: hidden;
        }
        
        #standings-table td input[type="text"] {
            width: 100%;
            height: 16px;
            border: 1px solid #ddd;
            border-radius: 1px;
            padding: 0 2px;
            text-align: center;
            font-size: 8px;
            background-color: #fff;
            color: #333;
            margin: 0;
            box-sizing: border-box;
        }
        
        #standings-table .total-cell {
            font-weight: 800;
            color: #0a3d2e;
            font-size: 9px;
            width: 30px;
            min-width: 30px;
            max-width: 30px;
        }
        
        .delete-btn {
            background-color: #e74c3c;
            padding: 1px 3px;
            font-size: 7px;
            min-width: 20px;
            height: 16px;
            width: 20px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #standings-table tr:hover .delete-btn {
            display: inline-flex;
        }
        
        /* LOW SCORE FORMATTING */
        .low-score {
            color: #e74c3c !important;
            font-weight: 700 !important;
        }
        
        /* TOP SCORES HIGHLIGHT - DYNAMIC BASED ON BEST COUNT */
        .top-score {
            background-color: #d4edda !important; /* Light green */
            color: #155724 !important;
            font-weight: 600 !important;
            border: 1px solid #c3e6cb !important;
        }
        
        /* REMOVED ALL RANKING COLOR CLASSES */
        
        /* HANDICAP EXTRACTOR - COMPACT */
        .upload-box {
            border: 1px dashed #4a90e2;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            border-radius: 2px;
            background-color: rgba(74, 144, 226, 0.1);
            margin-bottom: 4px;
        }
        
        .upload-box p {
            font-size: 9px;
            margin: 2px 0;
            color: inherit;
        }
        
        .upload-box i {
            font-size: 16px;
            margin-bottom: 2px;
            color: inherit;
        }
        
        .stats {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            gap: 4px;
        }
        
        .stats div {
            padding: 6px;
            border-radius: 2px;
            text-align: center;
            flex: 1;
            border: 1px solid currentColor;
        }
        
        .stats strong {
            display: block;
            font-size: 12px;
            margin-bottom: 1px;
            color: inherit;
        }
        
        .stats span {
            font-size: 8px;
            color: inherit;
        }
        
        .checkboxes {
            margin: 4px 0;
            font-size: 9px;
        }
        
        .checkboxes label {
            display: inline-flex;
            align-items: center;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .checkboxes input {
            width: auto;
            margin-right: 3px;
        }
        
        /* DRAW GROUPS - SUPER COMPACT */
        .groups-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 6px;
            margin-top: 8px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .group {
            border: 1px solid currentColor;
            border-radius: 3px;
            padding: 6px;
            min-height: 120px;
        }
        
        .group-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            padding-bottom: 3px;
            border-bottom: 1px solid currentColor;
        }
        
        .group-header h3 {
            font-size: 9px;
            font-weight: 700;
            color: inherit;
        }
        
        .group-size-badge {
            background-color: #4a90e2;
            color: white;
            padding: 1px 4px;
            border-radius: 6px;
            font-size: 7px;
            margin-left: 3px;
        }
        
        .tee-box-input {
            width: 25px;
            text-align: center;
            padding: 1px 2px;
            font-size: 8px;
            height: 18px;
        }
        
        .player-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px;
            margin-bottom: 2px;
            border-radius: 2px;
            border: 1px solid currentColor;
            font-size: 8px;
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        .player-name {
            font-weight: 700;
            font-size: 9px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100px;
            color: inherit;
        }
        
        .player-details {
            font-size: 8px;
            font-weight: 600;
            color: inherit;
            opacity: 0.85;
        }
        
        .delete-player {
            color: #e74c3c;
            cursor: pointer;
            font-size: 8px;
            margin-left: 3px;
            flex-shrink: 0;
        }
        
        /* FORM GROUPS - MICRO */
        .form-group {
            margin-bottom: 6px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 1px;
            font-weight: 600;
            color: #ffffff;
            font-size: 9px;
        }
        
        /* OVERLAY */
        #overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }
        
        /* FOOTER */
        .footer {
            margin-top: 6px;
            text-align: center;
            color: #a0aec0;
            font-size: 8px;
            padding: 4px;
            border-top: 1px solid #4a6fa5;
        }
        
        /* THEME SELECTOR - COMPACT */
        .theme-selector {
            position: relative;
            display: inline-block;
        }
        
        .theme-button {
            background: #4a90e2;
            padding: 3px 6px;
            font-size: 9px;
            height: 20px;
        }
        
        .theme-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: #2c4f7c;
            border: 1px solid #4a6fa5;
            border-radius: 2px;
            min-width: 120px;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-5px);
            transition: all 0.2s ease;
        }
        
        .theme-dropdown.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        
        .theme-option {
            padding: 4px 6px;
            cursor: pointer;
            font-size: 9px;
            transition: background-color 0.2s ease;
            color: #e6f2ff;
        }
        
        .theme-option:hover {
            background: #3a5a8a;
        }
        
        /* SCROLLBAR STYLING */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #2c4f7c;
            border-radius: 1px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #4a90e2;
            border-radius: 1px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #357abd;
        }
        
        /* RESPONSIVE */
        @media (max-width: 768px) {
            .app-header {
                flex-direction: column;
                gap: 4px;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                min-width: 70px;
                padding: 3px 4px;
                font-size: 9px;
            }
            
            .groups-container {
                grid-template-columns: 1fr;
            }
            
            .league-controls {
                flex-direction: column;
                align-items: flex-start;
            }
            
            /* Adjust table for mobile */
            .table-container {
                max-height: 60vh;
            }
            
            #standings-table th:first-child {
                width: 25px;
                min-width: 25px;
                max-width: 25px;
            }
            
            #standings-table th:nth-child(2) {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
                left: 25px;
            }
            
            #standings-table td:first-child {
                width: 25px;
                min-width: 25px;
                max-width: 25px;
            }
            
            #standings-table td:nth-child(2) {
                width: 80px;
                min-width: 80px;
                max-width: 80px;
                left: 25px;
            }
            
            #standings-table th.wk-header, 
            #standings-table td:not(:first-child):not(:nth-child(2)):not(:last-child):not(.total-cell) {
                min-width: 20px;
                width: auto;
                font-size: 6px;
            }
            
            #standings-table th.total-header, 
            #standings-table .total-cell {
                min-width: 25px;
                width: 25px;
                max-width: 25px;
            }
        }
        
        /* UTILITY CLASSES */
        .hidden {
            display: none;
        }
        
        .text-small {
            font-size: 8px;
        }
        
        .text-tiny {
            font-size: 7px;
        }
        
        .mb-2 { margin-bottom: 2px; }
        .mb-4 { margin-bottom: 4px; }
        .mt-2 { margin-top: 2px; }
        .mt-4 { margin-top: 4px; }
        .ml-2 { margin-left: 2px; }
        .mr-2 { margin-right: 2px; }
        
        /* COLUMN SPACING FOR FUTURE TABS */
        .compact-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 6px;
            margin-top: 6px;
        }
        
        .compact-card {
            border: 1px solid currentColor;
            border-radius: 3px;
            padding: 6px;
        }
        
        .compact-card h3 {
            font-size: 10px;
            margin-bottom: 4px;
            padding-bottom: 3px;
            border-bottom: 1px solid currentColor;
            color: inherit;
        }
        
        /* Make table fit screen */
        .table-fit {
            width: 100%;
            overflow-x: auto;
        }
        
        /* PRIZES TABLE STYLING */
        #prizes-table tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        #prizes-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        #prizes-table tbody tr:hover {
            background-color: #e3f2fd;
        }
        
        #prizes-table td {
            padding: 4px 6px;
            text-align: center;
            border-right: 1px solid #eee;
            color: #333;
            font-size: 9px;
        }
        
        #prizes-table td:first-child {
            font-weight: 600;
            background-color: #f5f5f5;
        }
        
        #prizes-table td:last-child {
            font-weight: 700;
            background-color: #e8f5e9;
            color: #2e7d32;
        }
        
        /* Payment cell styling - MATCHING OTHER COLUMNS */
        .paid {
            color: #4CAF50 !important; /* Green for paid */
            font-weight: bold !important;
        }
        
        .not-paid {
            color: #f44336 !important; /* Red for not paid */
        }
        
        .swindle-editable {
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 600;
        }
        
        /* EXTRACTED DATA TABLE - MATCHING SURROUNDING COLORS */
        #extractedTableContainer {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            background-color: #2c4f7c;
            border-radius: 2px;
            border: 1px solid #4a6fa5;
            margin-bottom: 6px;
            max-height: 200px;
        }
        
        #extractedTable {
            width: 100%;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: fixed;
            background-color: #2c4f7c;
        }
        
        #extractedTable thead {
            background-color: #1a6b4f;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        #extractedTable th {
            padding: 6px 4px;
            text-align: center;
            font-weight: 700;
            font-size: 7px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            white-space: normal;
            word-wrap: break-word;
            height: auto;
            overflow: visible;
            line-height: 1.1;
            vertical-align: middle;
        }
        
        #extractedTable tbody tr {
            border-bottom: 1px solid #4a6fa5;
            height: 22px;
        }
        
        #extractedTable tbody tr:hover {
            background-color: #3a5a8a;
        }
        
        #extractedTable td {
            padding: 4px;
            text-align: center;
            border-right: 1px solid #4a6fa5;
            height: 22px;
            color: #e6f2ff;
            font-size: 10px;
            overflow: hidden;
            background-color: #2c4f7c;
        }
        
        #extractedTable .swindle-editable {
            cursor: pointer;
            transition: background-color 0.2s ease;
            font-weight: 600;
            color: #e6f2ff;
        }
        
        #extractedTable .swindle-editable.paid {
            color: #4CAF50 !important;
            font-weight: bold !important;
        }
        
        #extractedTable .swindle-editable.not-paid {
            color: #f44336 !important;
        }
        
        #extractedTable tbody tr:hover .swindle-editable {
            background-color: #3a5a8a !important;
        }
        
        /* Column widths for extracted table - Equal widths */
        #extractedTable th:nth-child(1) { width: 14.28%; } /* Paid */
        #extractedTable th:nth-child(2) { width: 14.28%; text-align: left; padding-left: 8px; } /* Players Name */
        #extractedTable th:nth-child(3) { width: 14.28%; } /* Players New Index */
        #extractedTable th:nth-child(4) { width: 14.28%; } /* Total Adjustment */
        #extractedTable th:nth-child(5) { width: 14.28%; } /* Players Previous Index */
        #extractedTable th:nth-child(6) { width: 14.28%; } /* Course Handicap (White) */
        #extractedTable th:nth-child(7) { width: 14.28%; } /* Course Handicap (Yellow) */
        
        #extractedTable td:nth-child(2) { text-align: left; padding-left: 8px; }
        
        /* Responsive adjustments for extracted table */
        @media (max-width: 768px) {
            #extractedTable {
                font-size: 9px;
            }
            
            #extractedTable th {
                font-size: 8px;
                padding: 4px 2px;
            }
            
            #extractedTable td {
                padding: 3px;
                font-size: 9px;
            }
        }
        
        /* ENHANCED SCORECARD STYLES */
        .scorecard-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-bottom: 8px;
            align-items: center;
        }
        
        .scorecard-table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            background-color: white;
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            margin-bottom: 6px;
            max-height: 70vh;
        }
        
        #scorecard-table {
            width: auto;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            table-layout: auto;
            background-color: white;
        }
        
        #scorecard-table thead {
            background-color: #1a6b4f;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        #scorecard-table th {
            padding: 4px 2px;
            text-align: center;
            font-weight: 700;
            font-size: 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            white-space: nowrap;
            height: 22px;
            overflow: hidden;
            min-width: 25px;
        }
        
        #scorecard-table th.hole-header {
            background-color: #0a3d2e;
            font-size: 7px;
            min-width: 25px;
            width: 25px;
        }
        
        #scorecard-table th.section-header {
            background-color: #2a8b6f;
            font-weight: 800;
            font-size: 8px;
            min-width: 35px;
            width: 35px;
        }
        
        #scorecard-table th.player-header {
            background-color: #4a90e2;
            min-width: 80px;
            width: 80px;
            position: sticky;
            left: 0;
            z-index: 90;
            text-align: left;
            padding-left: 6px;
        }
        
        #scorecard-table th.section-header.countback {
            background-color: #d4af37;
            color: #0a3d2e;
        }
        
        #scorecard-table td {
            padding: 1px;
            text-align: center;
            border-right: 1px solid #eee;
            height: 18px;
            color: #333;
            font-size: 8px;
            overflow: hidden;
        }
        
        #scorecard-table td.hole-cell {
            min-width: 25px;
            width: 25px;
            background-color: #f8f9fa;
        }
        
        #scorecard-table td.player-cell {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 80;
            text-align: left;
            font-weight: 600;
            color: #0a3d2e;
            padding-left: 6px;
            width: 80px;
            min-width: 80px;
            max-width: 80px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            border-right: 2px solid #4a90e2;
            height: 36px;
            vertical-align: top;
            padding-top: 2px;
        }
        
        #scorecard-table td.section-cell {
            font-weight: 700;
            background-color: #f1f8e9;
            min-width: 35px;
            width: 35px;
            border-right: 2px solid #ddd;
        }
        
        #scorecard-table td.section-cell.countback {
            background-color: #fff8e1;
            color: #d4af37;
            font-weight: 800;
        }
        
        /* SCORECARD INPUT STYLES - NO ARROWS */
        #scorecard-table td input[type="number"] {
            width: 100%;
            height: 14px;
            border: 1px solid #ddd;
            border-radius: 1px;
            padding: 0 1px;
            text-align: center;
            font-size: 7px;
            background-color: #fff;
            color: #333;
            margin: 0;
            box-sizing: border-box;
            /* Remove up/down arrows */
            -moz-appearance: textfield;
        }
        
        /* Remove arrows in WebKit browsers */
        #scorecard-table td input[type="number"]::-webkit-outer-spin-button,
        #scorecard-table td input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        #scorecard-table td input[type="number"]:focus {
            border-color: #4a90e2;
            outline: none;
            background-color: #f0f7ff;
        }
        
        #scorecard-table td.par-cell {
            background-color: #e8f5e9;
            font-weight: 600;
            color: #2e7d32;
        }
        
        #scorecard-table td.index-cell {
            background-color: #e3f2fd;
            font-weight: 600;
            color: #1565c0;
        }
        
        #scorecard-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        #scorecard-table tbody tr:nth-child(odd) {
            background-color: white;
        }
        
        #scorecard-table tbody tr:hover {
            background-color: #e3f2fd;
        }
        
        .player-score-row {
            border-bottom: none;
        }
        
        .stableford-row {
            border-bottom: 2px solid #333;
        }
        
        .stableford-row td {
            background-color: #f0f0f0 !important;
        }
        
        .scorecard-delete-btn {
            background-color: #e74c3c;
            padding: 1px 3px;
            font-size: 7px;
            min-width: 20px;
            height: 16px;
            width: 20px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border: none;
            border-radius: 1px;
            cursor: pointer;
        }
        
        .scorecard-delete-btn:hover {
            background-color: #c0392b;
        }
        
        .course-info {
            background-color: #f8f9fa;
            padding: 4px 8px;
            border-radius: 2px;
            font-size: 8px;
            color: #333;
            margin-bottom: 6px;
        }
        
        .course-info label {
            font-weight: 600;
            margin-right: 4px;
        }
        
        .course-info input {
            width: 120px;
            margin-right: 12px;
            font-size: 8px;
            padding: 2px 4px;
            background-color: #ffffff !important;
            color: #333333 !important;
            border: 1px solid #ccc !important;
        }
        
        .course-info select {
            background-color: #ffffff !important;
            color: #333333 !important;
            border: 1px solid #ccc !important;
        }
        
        /* NEW: Stableford points display */
        .stableford-points {
            font-size: 7px;
            font-weight: 700;
            display: block;
            margin-top: 1px;
            padding: 1px;
            border-radius: 1px;
            min-height: 12px;
            color: #333 !important; /* Default text color */
            text-align: center;
            background-color: #ffffff !important; /* Default white background */
        }
        
        /* UPDATED: Color coding for stableford points - YOUR REQUESTED SCHEME */
        /* Par (2 points) */
        .stableford-2 {
            background-color: #000000 !important; /* Black for Par */
            color: #ffffff !important;
        }
        
        /* Birdie (3 points) */
        .stableford-3 {
            background-color: #ff0000 !important; /* Red for Birdie */
            color: #ffffff !important;
        }
        
        /* Eagle (4 points) */
        .stableford-4 {
            background-color: #0000ff !important; /* Blue for Eagle */
            color: #ffffff !important;
        }
        
        /* Bogey (1 point) */
        .stableford-1 {
            background-color: #800080 !important; /* Purple for Bogey */
            color: #ffffff !important;
        }
        
        /* Double Bogey or worse (0 points) - ONLY WHEN ACTUALLY SCORED */
        .stableford-0 {
            background-color: #ff69b4 !important; /* Pink for Double Bogey or worse */
            color: #ffffff !important;
        }
        
        /* Gross score display */
        .gross-score {
            font-weight: 600;
            font-size: 8px;
            display: block;
            min-height: 14px;
            padding-top: 1px;
        }
        
        /* Hole info cell with both scores */
        .hole-score-cell {
            padding: 0 !important;
            vertical-align: top;
        }
        
        /* Total stableford cell */
        .stableford-total {
            background-color: #e8f5e9;
            color: #155724;
            font-weight: 800;
        }
        
        /* Remove arrows from all number inputs */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* LEAGUE TABLE INPUT STYLES - NO ARROWS */
        #standings-table td input[type="text"] {
            -moz-appearance: textfield;
        }
        
        #standings-table td input[type="text"]::-webkit-outer-spin-button,
        #standings-table td input[type="text"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* H'CAP CALCULATOR TABLE STYLES */
        .calculator-table-container {
            width: 100%;
            max-width: 100%;
            overflow-x: auto;
            background-color: white;
            border-radius: 2px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            margin-bottom: 6px;
            max-height: 70vh;
        }
        
        #calculator-table {
            width: 100%;
            min-width: 100%;
            border-collapse: collapse;
            font-size: 9px;
            table-layout: auto;
            background-color: white;
        }
        
        #calculator-table thead {
            background-color: #1a6b4f;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        #calculator-table th {
            padding: 6px 4px;
            text-align: center;
            font-weight: 700;
            font-size: 8px;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            white-space: normal;
            word-wrap: break-word;
            vertical-align: middle;
        }
        
        #calculator-table th:first-child {
            text-align: left;
            padding-left: 8px;
            position: sticky;
            left: 0;
            background-color: #1a6b4f;
            z-index: 110;
        }
        
        #calculator-table tbody tr {
            border-bottom: 1px solid #eee;
        }
        
        #calculator-table tbody tr:hover {
            background-color: #f9f9f9;
        }
        
        #calculator-table tbody tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        #calculator-table td {
            padding: 4px;
            text-align: center;
            border-right: 1px solid #eee;
            color: #333;
            font-size: 9px;
        }
        
        #calculator-table td:first-child {
            text-align: left;
            padding-left: 8px;
            font-weight: 600;
            position: sticky;
            left: 0;
            background-color: inherit;
            z-index: 90;
        }
        
        #calculator-table td input[type="number"] {
            width: 100%;
            height: 18px;
            border: 1px solid #ddd;
            border-radius: 2px;
            padding: 0 4px;
            text-align: center;
            font-size: 9px;
            background-color: #fff;
            color: #333;
            margin: 0;
            box-sizing: border-box;
            -moz-appearance: textfield;
        }
        
        #calculator-table td input[type="number"]::-webkit-outer-spin-button,
        #calculator-table td input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        #calculator-table td input[type="number"]:focus {
            border-color: #4a90e2;
            outline: none;
            background-color: #f0f7ff;
        }
        
        @media (max-width: 768px) {
            #scorecard-table th.player-header,
            #scorecard-table td.player-cell {
                width: 60px;
                min-width: 60px;
                max-width: 60px;
            }
            
            #scorecard-table th.hole-header,
            #scorecard-table td.hole-cell {
                width: 22px;
                min-width: 22px;
                max-width: 22px;
                font-size: 6px;
            }
            
            #scorecard-table th.section-header,
            #scorecard-table td.section-cell {
                width: 30px;
                min-width: 30px;
                max-width: 30px;
                font-size: 7px;
            }
            
            .stableford-points {
                font-size: 6px;
                padding: 0;
            }
            
            .gross-score {
                font-size: 7px;
            }
        }
        
        /* HOW TO MODAL STYLES */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #1a6b4f 0%, #2a8b6f 100%);
            color: white;
            padding: 20px;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .modal-body {
            padding: 30px;
            color: #333;
            line-height: 1.6;
        }
        
        .modal-body h3 {
            color: #1a6b4f;
            font-size: 18px;
            margin-top: 25px;
            margin-bottom: 10px;
            border-bottom: 2px solid #d4af37;
            padding-bottom: 5px;
        }
        
        .modal-body h3:first-child {
            margin-top: 0;
        }
        
        .modal-body h4 {
            color: #2a8b6f;
            font-size: 14px;
            margin-top: 15px;
            margin-bottom: 8px;
        }
        
        .modal-body p {
            margin-bottom: 10px;
            font-size: 13px;
        }
        
        .modal-body ul, .modal-body ol {
            margin-left: 20px;
            margin-bottom: 15px;
        }
        
        .modal-body li {
            margin-bottom: 8px;
            font-size: 13px;
        }
        
        .modal-body strong {
            color: #1a6b4f;
        }
        
        .modal-body code {
            background-color: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }
        
        .guide-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-left: 4px solid #1a6b4f;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .tip-box {
            background-color: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .warning-box {
            background-color: #fff3e0;
            border-left: 4px solid #ff9800;
            padding: 12px;
            margin: 15px 0;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ULTRA COMPACT HEADER -->
        <div class="app-header">
            <div class="logo-section">
                <i class="fas fa-golf-ball"></i>
                <div>
                    <h1>PGA League System, by Kamal Dhunna</h1>
                    <div class="app-description">League Standings ‚Ä¢ Handicap Extractor ‚Ä¢ Scorecard ‚Ä¢ Draw Management</div>
                </div>
            </div>
            
            <div style="display: flex; gap: 8px; align-items: center;">
                <button onclick="backupAllData()" class="warning" style="font-size: 9px; padding: 3px 6px;">
                    <i class="fas fa-download"></i> Backup
                </button>
                <button onclick="document.getElementById('restoreFileInput').click()" class="success" style="font-size: 9px; padding: 3px 6px;">
                    <i class="fas fa-upload"></i> Restore
                </button>
                <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="restoreAllData(event)">
                
                <button onclick="showHowToGuide()" class="secondary" style="font-size: 9px; padding: 3px 6px;">
                    <i class="fas fa-question-circle"></i> HOW TO
                </button>
                
                <div class="theme-selector">
                    <button class="theme-button" onclick="toggleThemeDropdown()">
                        <i class="fas fa-palette"></i> Theme
                    </button>
                    <div class="theme-dropdown" id="themeDropdown">
                        <div class="theme-option" onclick="changeTheme('ocean-breeze')">üåä Ocean Breeze</div>
                        <div class="theme-option" onclick="changeTheme('mint-fresh')">üåø Mint Fresh</div>
                        <div class="theme-option" onclick="changeTheme('sunset-glow')">üåÖ Sunset Glow</div>
                        <div class="theme-option" onclick="changeTheme('lavender-dream')">üíú Lavender Dream</div>
                        <div class="theme-option" onclick="changeTheme('rose-garden')">üåπ Rose Garden</div>
                        <div class="theme-option" onclick="changeTheme('golden-sand')">üèñÔ∏è Golden Sand</div>
                        <div class="theme-option" onclick="changeTheme('sky-blue')">‚òÅÔ∏è Sky Blue</div>
                        <div class="theme-option" onclick="changeTheme('peach-cream')">üçë Peach Cream</div>
                        <div class="theme-option" onclick="changeTheme('forest-mist')">üå≤ Forest Mist</div>
                        <div class="theme-option" onclick="changeTheme('coral-reef')">üê† Coral Reef</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SUPER COMPACT TABS (NOW 6 TABS) -->
        <div class="tabs">
            <div class="tab active" data-tab="league" onclick="switchTab('league')">
                <i class="fas fa-trophy"></i> League
            </div>
            <div class="tab" data-tab="handicap" onclick="switchTab('handicap')">
                <i class="fas fa-file-upload"></i> Handicap
            </div>
            <div class="tab" data-tab="scorecard" onclick="switchTab('scorecard')">
                <i class="fas fa-clipboard-list"></i> Scorecard
            </div>
            <div class="tab" data-tab="winners" onclick="switchTab('winners')">
                <i class="fas fa-calculator"></i> Winners
            </div>
            <div class="tab" data-tab="stats" onclick="switchTab('stats')">
                <i class="fas fa-chart-bar"></i> STATS
            </div>
            <div class="tab" data-tab="prizes" onclick="switchTab('prizes')">
                <i class="fas fa-pound-sign"></i> SWINDLE Prizes
            </div>
        </div>
        
        <!-- LEAGUE STANDINGS TAB -->
        <div id="league-tab" class="tab-content active">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h2 style="margin: 0;"><i class="fas fa-sliders-h"></i> League Controls</h2>
                    <div style="display: flex; gap: 8px; align-items: center; font-size: 9px;">
                        <select id="season-selector" style="padding: 3px 6px; font-size: 9px; border: 1px solid #ccc; border-radius: 3px;">
                            <option value="winter">PGA Winter League</option>
                            <option value="summer">PGA Summer League</option>
                        </select>
                        <span style="color: #666;">Start:</span>
                        <input type="date" id="season-start-date" style="padding: 2px 4px; font-size: 9px; border: 1px solid #ccc; border-radius: 3px;">
                        <span style="color: #666;">End:</span>
                        <input type="date" id="season-end-date" style="padding: 2px 4px; font-size: 9px; border: 1px solid #ccc; border-radius: 3px;">
                    </div>
                </div>
                <div class="league-controls">
                    <div class="button-group">
                        <button id="add-player-btn">
                            <i class="fas fa-user-plus"></i> Add Player
                        </button>
                        <span class="text-small ml-2">Players: <span id="player-count">40</span></span>
                        <span class="text-small ml-2">Weeks: <span id="week-count">25</span></span>
                    </div>
                    <div class="button-group">
                        <!-- Best Scores Dropdown -->
                        <div class="best-scores-selector">
                            <button class="best-scores-button" onclick="toggleBestScoresDropdown()">
                                <i class="fas fa-star"></i> Best <span id="best-count-display">10</span>
                            </button>
                            <div class="best-scores-dropdown" id="bestScoresDropdown">
                                <div class="best-scores-option" onclick="changeBestCount(5)">Best 5</div>
                                <div class="best-scores-option" onclick="changeBestCount(6)">Best 6</div>
                                <div class="best-scores-option" onclick="changeBestCount(7)">Best 7</div>
                                <div class="best-scores-option" onclick="changeBestCount(8)">Best 8</div>
                                <div class="best-scores-option" onclick="changeBestCount(9)">Best 9</div>
                                <div class="best-scores-option active" onclick="changeBestCount(10)">Best 10</div>
                                <div class="best-scores-option" onclick="changeBestCount(11)">Best 11</div>
                                <div class="best-scores-option" onclick="changeBestCount(12)">Best 12</div>
                                <div class="best-scores-option" onclick="changeBestCount(13)">Best 13</div>
                                <div class="best-scores-option" onclick="changeBestCount(14)">Best 14</div>
                                <div class="best-scores-option" onclick="changeBestCount(15)">Best 15</div>
                            </div>
                        </div>
                        
                        <button id="calculate-btn" class="success">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                        <div class="best-scores-selector" style="display: inline-block;">
                            <button class="best-scores-button warning" onclick="toggleLeagueCSVDropdown()" style="background-color: #d4af37; color: #0a3d2e;">
                                <i class="fas fa-file-csv"></i> CSV <i class="fas fa-caret-down"></i>
                            </button>
                            <div class="best-scores-dropdown" id="leagueCSVDropdown">
                                <div class="best-scores-option" onclick="exportLeagueCSV()"><i class="fas fa-download"></i> Export CSV</div>
                                <div class="best-scores-option" onclick="document.getElementById('leagueCSVImportInput').click()"><i class="fas fa-upload"></i> Import CSV</div>
                            </div>
                        </div>
                        <input type="file" id="leagueCSVImportInput" accept=".csv" style="display: none;" onchange="importLeagueCSV(event)">
                        <button id="reset-btn" class="danger">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                        <button id="adjust-weeks-btn" class="secondary">
                            <i class="fas fa-calendar-alt"></i> Weeks
                        </button>
                        <button id="import-scores-btn" class="warning" onclick="importScorecardScores()">
                            <i class="fas fa-clipboard-check"></i> Player Scores
                        </button>
                        <button onclick="captureLeagueTable()" class="secondary">
                            <i class="fas fa-camera"></i> Capture
                        </button>
                    </div>
                </div>
                
                <!-- Color Key / Legend -->
                <div class="legend-box" style="padding: 6px 8px; border-radius: 3px; margin-bottom: 6px; font-size: 8px;">
                    <div style="margin-bottom: 3px;"><strong style="font-size: 9px;">Instructions:</strong> Click scores to edit ‚Ä¢ Click "Player ‚ñ≤" for A-Z ‚Ä¢ Click "B10 ‚ñº" for ranking</div>
                    <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <strong style="font-size: 9px;">Color Key:</strong>
                        <span style="display: inline-flex; align-items: center; gap: 4px;">
                            <span style="display: inline-block; width: 20px; height: 12px; background-color: #e74c3c; border: 1px solid #c0392b;"></span>
                            <span>Low Score (‚â§29)</span>
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 4px;">
                            <span style="display: inline-block; width: 20px; height: 12px; background-color: #d4edda; border: 1px solid #c3e6cb; color: #155724;"></span>
                            <span>Top <span id="highlight-count-key">10</span> Scores</span>
                        </span>
                    </div>
                </div>
                
                <!-- Dynamic table container -->
                <div class="table-container">
                    <table id="standings-table">
                        <thead id="standings-header">
                            <!-- Generated by JS -->
                        </thead>
                        <tbody id="standings-body">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="footer text-tiny">
                    Scroll horizontally for more weeks
                </div>
            </div>
        </div>
        
        <!-- HANDICAP EXTRACTOR TAB -->
        <div id="handicap-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-file-upload"></i> Upload File</h2>
                <div class="upload-box" id="uploadBox">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click to upload handicap file</p>
                    <p class="text-tiny">JPG, PNG, TXT, DOCX, XLSX</p>
                </div>
                <input type="file" id="fileInput" style="display: none;" multiple>
                
                <div class="checkboxes mb-4">
                    <label><input type="checkbox" id="removeQuotes"> Remove quotes</label>
                    <label><input type="checkbox" id="removeDefaultNames"> Remove default names</label>
                </div>
                
                <div class="button-group">
                    <button onclick="extractData()">
                        <i class="fas fa-search"></i> Extract
                    </button>
                    <button onclick="setAllToFive()" class="secondary">
                        <i class="fas fa-pound-sign"></i> All ¬£5
                    </button>
                    <button onclick="setAllToZero()" class="secondary">
                        <i class="fas fa-pound-sign"></i> All ¬£0
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-check-circle"></i> Extracted Data</h2>
                <div class="stats mb-4">
                    <div>
                        <strong id="totalSwindle">¬£0</strong>
                        <span>Total</span>
                    </div>
                    <div>
                        <strong id="totalPlayers">0</strong>
                        <span>Players</span>
                    </div>
                    <div>
                        <strong id="paidPlayers">0</strong>
                        <span>Paid</span>
                    </div>
                </div>
                
                <!-- Table container for extracted data - matching surrounding colors -->
                <div id="extractedTableContainer">
                    <table id="extractedTable">
                        <thead>
                            <tr>
                                <th>Paid</th>
                                <th onclick="sortHandicapTable()" style="cursor: pointer; user-select: none;">Players Name <span id="handicap-sort-indicator">‚ñº</span></th>
                                <th>Players New Index</th>
                                <th>Total Adjustment</th>
                                <th>Players Previous Index</th>
                                <th>Course Handicap (White)</th>
                                <th>Course Handicap (Yellow)</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                
                <div class="button-group mt-4">
                    <button onclick="downloadHandicapCSV()" class="success">
                        <i class="fas fa-download"></i> CSV
                    </button>
                    <button onclick="captureFivePoundPlayers()" class="secondary">
                        <i class="fas fa-camera"></i> ¬£5 Image
                    </button>
                    <button onclick="clearHandicapResults()" class="danger">
                        <i class="fas fa-trash"></i> Clear
                    </button>
                </div>
            </div>
            
            <div class="section">
                <h2><i class="fas fa-random"></i> Draw Management</h2>
                <div class="button-group mb-4">
                    <button onclick="createDraw()">
                        <i class="fas fa-plus-circle"></i> Create
                    </button>
                    <button onclick="reshuffleDraw()" class="secondary">
                        <i class="fas fa-random"></i> Reshuffle
                    </button>
                    <button onclick="captureDrawImage()" class="secondary">
                        <i class="fas fa-camera"></i> Capture
                    </button>
                </div>
                
                <div id="groupsContainer" class="groups-container"></div>
                
                <div class="compact-card mt-4">
                    <h3>Add Player</h3>
                    <div class="compact-grid" style="grid-template-columns: repeat(6, 1fr);">
                        <div class="form-group">
                            <label>Paid</label>
                            <input type="text" id="newPlayerPaid" placeholder="5">
                        </div>
                        <div class="form-group">
                            <label>Players Name</label>
                            <input type="text" id="newPlayerName" placeholder="Name">
                        </div>
                        <div class="form-group">
                            <label>Players New Index</label>
                            <input type="text" id="newPlayerNewIndex" placeholder="8.7">
                        </div>
                        <div class="form-group">
                            <label>Players Previous Index</label>
                            <input type="text" id="newPlayerPreviousIndex" placeholder="8.2">
                        </div>
                        <div class="form-group">
                            <label>Course Handicap (White)</label>
                            <input type="text" id="newPlayerWhiteTees" placeholder="10">
                        </div>
                        <div class="form-group">
                            <label>Course Handicap (Yellow)</label>
                            <input type="text" id="newPlayerYellowTees" placeholder="9">
                        </div>
                    </div>
                    <div class="compact-grid" style="grid-template-columns: 1fr;">
                        <div class="form-group">
                            <label>Group</label>
                            <select id="newPlayerGroup" style="padding: 4px; font-size: 9px;">
                                <option value="auto">Auto</option>
                            </select>
                        </div>
                    </div>
                    <button onclick="addManualPlayer()" class="mt-2" style="width: 100%;">
                        <i class="fas fa-plus"></i> Add to Draw
                    </button>
                </div>
            </div>
        </div>
        
        <!-- WINNERS TAB -->
        <div id="winners-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-award"></i> Winners - Saturday Swindle</h2>
                
                <div class="button-group" style="margin-bottom: 10px; align-items: center;">
                    <label style="font-size: 9px; font-weight: 600; margin-right: 5px;">Select Week:</label>
                    <select id="winnersWeekSelector" onchange="changeWinnersWeek()" style="width: 80px; margin-right: 10px;">
                        <!-- Generated by JS -->
                    </select>
                    <button onclick="importHandicapToWinners()" class="warning">
                        <i class="fas fa-file-import"></i> Import Scorecard Players
                    </button>
                    <button onclick="clearWinnersWeek()" class="danger">
                        <i class="fas fa-eraser"></i> Clear Week
                    </button>
                    <button onclick="clearAllWinnersData()" class="danger" style="font-size: 9px; padding: 4px 8px;">
                        <i class="fas fa-trash-alt"></i> Clear ALL Weeks
                    </button>
                </div>
                
                <!-- Winners Table -->
                <div class="table-container" style="max-height: 70vh;">
                    <table id="winners-table" style="width: 100%; border-collapse: collapse; font-size: 9px; background-color: white;">
                        <thead style="background-color: #1a6b4f; color: white; position: sticky; top: 0; z-index: 100;">
                            <tr>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 80px;">Position</th>
                                <th style="padding: 8px 6px; text-align: left; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1);">Player Name</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 50px;">Total</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 50px;">F9</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 60px;">CB 4-9</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 60px;">CB 7-9</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 60px;">CB 8-9</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 50px;">CB 9</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 50px;">B9</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 60px;">CB 13-18</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 60px;">CB 16-18</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 60px;">CB 17-18</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; border-right: 1px solid rgba(255, 255, 255, 0.1); width: 50px;">CB 18</th>
                                <th style="padding: 8px 6px; text-align: center; font-weight: 700; font-size: 9px; width: 120px;">Prize</th>
                            </tr>
                        </thead>
                        <tbody id="winners-body">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="footer text-tiny">
                    Import players from Scorecard (sorted by Stableford score), then assign prize amounts
                </div>
            </div>
            
            <!-- EMBEDDED GOLF HANDICAP CALCULATOR -->
            <div class="section" id="embedded-golf-calculator">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <h2 style="margin: 0;"><i class="fas fa-calculator"></i> Golf Handicap Cut & Increase Calculator</h2>
                    <button onclick="showCalculationParametersDialog()" class="secondary" style="padding: 4px 10px; font-size: 9px;" title="Edit calculation parameters">
                        <i class="fas fa-cog"></i> Parameters
                    </button>
                </div>
                <div class="season-info" style="text-align: center; font-style: italic; font-size: 9px; margin-bottom: 8px;">Season: Winter 2025-26</div>
                <div style="text-align: center; margin-bottom: 8px;">
                    <span style="font-size: 10px; font-weight: 600; color: #2c5530;">Players Calculated: <span id="golf-player-count">0</span></span>
                    <button onclick="downloadGolfReport()" class="secondary" style="margin-left: 10px; padding: 4px 10px; font-size: 9px;">
                        <i class="fas fa-file-alt"></i> Download TXT
                    </button>
                    <button onclick="downloadGolfReportExcel()" class="success" style="padding: 4px 10px; font-size: 9px;">
                        <i class="fas fa-file-excel"></i> Download Excel
                    </button>
                    <button onclick="clearGolfReport()" class="danger" style="padding: 4px 10px; font-size: 9px;">
                        <i class="fas fa-eraser"></i> Clear
                    </button>
                </div>
                
                <!-- Calculator Input Section -->
                <div style="background-color: white; padding: 12px; border-radius: 3px; margin-bottom: 8px;">
                    <h3 style="color: #2c5530; font-size: 11px; margin-bottom: 8px; border-bottom: 1px solid #2c5530; padding-bottom: 4px;">Enter Player Details</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px;">
                        <div style="grid-column: span 2;">
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">0) Player Name</label>
                            <div style="display: flex; gap: 5px;">
                                <select id="golf-playerNameSelect" onchange="selectGolfPlayer()" style="background-color: #ffecd9 !important; flex: 1; padding: 4px; font-size: 9px; border: 1px solid #ddd; border-radius: 2px;">
                                    <option value="">-- Select Player --</option>
                                    <!-- Players populated dynamically from League data -->
                                </select>
                                <input type="text" id="golf-playerName" placeholder="Or type name" value="" style="background-color: #ffecd9 !important; flex: 1; padding: 4px; font-size: 9px; border: 1px solid #ddd; border-radius: 2px;">
                            </div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">1) Player's Index</label>
                            <input type="number" id="golf-playerIndex" step="0.1" min="-18" max="15.1" value="6.4" style="background-color: #ffecd9 !important; width: 100%; padding: 4px; font-size: 9px; border: 1px solid #ddd; border-radius: 2px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">2) Index Category</label>
                            <div id="golf-indexCategory" style="background-color: #f9f9f9; padding: 4px; border-radius: 2px; border-left: 3px solid #2c5530; font-weight: 600; font-size: 9px; min-height: 20px;">Category 2</div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">3) Prize Money Won (¬£0 if none)</label>
                            <input type="number" id="golf-prizeMoney" min="0" value="0" style="background-color: #ffecd9 !important; width: 100%; padding: 4px; font-size: 9px; border: 1px solid #ddd; border-radius: 2px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">4) Stableford Points Scored</label>
                            <input type="number" id="golf-stablefordPoints" min="0" max="50" value="38" style="background-color: #ffecd9 !important; width: 100%; padding: 4px; font-size: 9px; border: 1px solid #ddd; border-radius: 2px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">5) Swindle Finishing Position</label>
                            <input type="number" id="golf-finishingPosition" min="1" value="" placeholder="Enter if won" style="background-color: #ffecd9 !important; width: 100%; padding: 4px; font-size: 9px; border: 1px solid #ddd; border-radius: 2px;">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">6) LGC Heritage Tees Color</label>
                            <select id="golf-teeColor" style="background-color: #ffecd9 !important; width: 100%; padding: 4px; font-size: 9px; border: 1px solid #ddd; border-radius: 2px;">
                                <option value="White">White</option>
                                <option value="Yellow">Yellow</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">7) Course Par</label>
                            <div id="golf-coursePar" style="background-color: #f9f9f9; padding: 4px; border-radius: 2px; border-left: 3px solid #2c5530; font-weight: 600; font-size: 9px; min-height: 20px;">71</div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">8) Slope Rating</label>
                            <div id="golf-slopeRating" style="background-color: #f9f9f9; padding: 4px; border-radius: 2px; border-left: 3px solid #2c5530; font-weight: 600; font-size: 9px; min-height: 20px;">128</div>
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; font-size: 9px; color: #333; margin-bottom: 2px;">9) Course Rating</label>
                            <div id="golf-courseRating" style="background-color: #f9f9f9; padding: 4px; border-radius: 2px; border-left: 3px solid #2c5530; font-weight: 600; font-size: 9px; min-height: 20px;">71.5</div>
                        </div>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 8px; margin-top: 10px;">
                        <button onclick="calculateGolfHandicap()" style="padding: 6px 15px; background-color: #2c5530; font-size: 9px;">
                            <i class="fas fa-calculator"></i> Calculate Handicap
                        </button>
                        <button onclick="addPlayerToGolfReport()" class="success" style="padding: 6px 15px; font-size: 9px;">
                            <i class="fas fa-plus"></i> Add to Report
                        </button>
                        <button onclick="resetGolfCalculator()" class="danger" style="padding: 6px 15px; font-size: 9px;">
                            <i class="fas fa-undo"></i> Reset Values
                        </button>
                    </div>
                </div>
                
                <!-- Calculation Stages -->
                <div style="background-color: white; padding: 12px; border-radius: 3px; margin-bottom: 8px;">
                    <h3 style="color: #2c5530; font-size: 11px; margin-bottom: 8px; border-bottom: 1px solid #2c5530; padding-bottom: 4px;">Calculation Stages</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px;">
                        <div style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; border-left: 3px solid #4a7c59;">
                            <div style="font-weight: 600; font-size: 9px; color: #2c5530; margin-bottom: 4px;">Stage 1: Index Cut</div>
                            <div id="golf-stage1" style="font-weight: 600; font-size: 11px; text-align: center; padding: 6px; background-color: white; border-radius: 3px; color: #333;">0.00</div>
                            <div style="font-size: 7px; color: #666; margin-top: 4px;">If won money AND scored > 29 points</div>
                        </div>
                        <div style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; border-left: 3px solid #4a7c59;">
                            <div style="font-weight: 600; font-size: 9px; color: #2c5530; margin-bottom: 4px;">Stage 2: Index Increase</div>
                            <div id="golf-stage2" style="font-weight: 600; font-size: 11px; text-align: center; padding: 6px; background-color: white; border-radius: 3px; color: #333;">0.00</div>
                            <div style="font-size: 7px; color: #666; margin-top: 4px;">If no money AND scored < 31 points</div>
                        </div>
                        <div style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; border-left: 3px solid #4a7c59;">
                            <div style="font-weight: 600; font-size: 9px; color: #2c5530; margin-bottom: 4px;">Stage 3: Exceptional Cut</div>
                            <div id="golf-stage3" style="font-weight: 600; font-size: 11px; text-align: center; padding: 6px; background-color: white; border-radius: 3px; color: #333;">0.00</div>
                            <div style="font-size: 7px; color: #666; margin-top: 4px;">If scored > 36 points</div>
                        </div>
                        <div style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; border-left: 3px solid #4a7c59;">
                            <div style="font-weight: 600; font-size: 9px; color: #2c5530; margin-bottom: 4px;">Stage 4: Manual Adjustment</div>
                            <input type="number" id="golf-manualAdjustment" step="0.1" value="0" style="width: 100%; font-weight: 600; font-size: 11px; text-align: center; padding: 6px; background-color: white; border-radius: 3px; border: 1px solid #ddd;">
                            <div style="font-size: 7px; color: #666; margin-top: 4px;">Manual cut/increase (use minus for cut)</div>
                        </div>
                        <div style="background-color: #f9f9f9; padding: 8px; border-radius: 3px; border-left: 3px solid #4a7c59;">
                            <div style="font-weight: 600; font-size: 9px; color: #2c5530; margin-bottom: 4px;">Stage 5: Total Cut/Increase</div>
                            <div id="golf-stage5" style="font-weight: 600; font-size: 11px; text-align: center; padding: 6px; background-color: white; border-radius: 3px; color: #333;">0.00</div>
                            <div style="font-size: 7px; color: #666; margin-top: 4px;">Sum of stages 1-4</div>
                        </div>
                    </div>
                </div>
                
                <!-- Final Results -->
                <div style="background-color: #e8f5e9; padding: 15px; border-radius: 6px; border: 2px solid #2c5530;">
                    <h3 style="text-align: center; font-size: 13px; color: #2c5530; margin-bottom: 6px;">Final Results</h3>
                    <div id="golf-playerNameDisplay" style="text-align: center; font-size: 12px; font-weight: 600; color: #2c5530; margin-bottom: 12px; font-style: italic;"></div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <div style="text-align: center; padding: 10px; background-color: white; border-radius: 4px;">
                            <div style="font-weight: 600; font-size: 9px; color: #555; margin-bottom: 6px;">Player's Previous Index</div>
                            <div id="golf-prevIndex" style="font-size: 16px; font-weight: 700; color: #2c5530;">6.4</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: white; border-radius: 4px;">
                            <div style="font-weight: 600; font-size: 9px; color: #555; margin-bottom: 6px;">Total Adjustment</div>
                            <div id="golf-totalAdjustment" style="font-size: 16px; font-weight: 700; color: #2c5530;">0.00</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: white; border-radius: 4px;">
                            <div style="font-weight: 600; font-size: 9px; color: #555; margin-bottom: 6px;">Player's New Index</div>
                            <div id="golf-newIndex" style="font-size: 16px; font-weight: 700; color: #2c5530;">6.4</div>
                        </div>
                        <div style="text-align: center; padding: 10px; background-color: white; border-radius: 4px;">
                            <div style="font-weight: 600; font-size: 9px; color: #555; margin-bottom: 6px;">Course Handicap</div>
                            <div id="golf-courseHandicap" style="font-size: 16px; font-weight: 700; color: #2c5530;">8</div>
                        </div>
                    </div>
                </div>
                
                <!-- HCAP BATCH CALCULATOR -->
                <div style="background-color: white; padding: 12px; border-radius: 3px; margin-top: 12px;">
                    <h3 style="color: #2c5530; font-size: 11px; margin-bottom: 8px; border-bottom: 1px solid #2c5530; padding-bottom: 4px; display:flex; align-items:center; justify-content:space-between;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <span>HCAP Batch Calculator</span>
                            <label style="font-size:9px; font-weight:600; margin-left:8px;">Week:</label>
                            <select id="batchWeekSelector" onchange="changeBatchWeek()" style="width:70px; font-size:9px; padding:3px; border:2px solid #1a6b4f; border-radius:3px;">
                                <!-- Generated by JS -->
                            </select>
                            <span id="batch-last-import-label" style="font-size:10px; color:#1a6b4f; font-weight:600; background-color:#e8f5e9; padding:3px 8px; border-radius:3px; display:none;"></span>
                            <span id="batch-player-count-label" style="font-size:10px; color:#d4af37; font-weight:600; background-color:#fffbf0; padding:3px 8px; border-radius:3px; display:none;"></span>
                        </div>
                        <div style="display:flex; gap:6px;">
                            <button class="secondary" style="margin-left:8px;" onclick="showImportStblfdScoreDialog()"><i class="fas fa-file-import"></i> Import STBLFD Score</button>
                            <button class="warning" onclick="showCopyWeekDataDialog()" style="margin-left:4px;" title="Copy Players New Index from one week to Players Index of another week"><i class="fas fa-copy"></i> Copy Week Data</button>
                            <button class="warning" style="margin-left:4px;" onclick="recalcAllBatchRows()"><i class="fas fa-sync-alt"></i> Calculate Batch</button>
                            <div class="best-scores-selector" style="display: inline-block;">
                                <button class="best-scores-button danger" onclick="toggleResetWeeksDropdown()" style="background-color: #e74c3c; color: white; margin-left:4px;">
                                    <i class="fas fa-trash-alt"></i> Reset <i class="fas fa-caret-down"></i>
                                </button>
                                <div class="best-scores-dropdown" id="resetWeeksDropdown">
                                    <div class="best-scores-option" onclick="resetBatchWeeks('current')"><i class="fas fa-eraser"></i> Reset Current Week</div>
                                    <div class="best-scores-option" onclick="resetBatchWeeks('all')"><i class="fas fa-trash"></i> Reset ALL Weeks</div>
                                    <div class="best-scores-option" onclick="resetBatchWeeks('range')"><i class="fas fa-list"></i> Reset Week Range...</div>
                                </div>
                            </div>
                            <div class="best-scores-selector" style="display: inline-block;">
                                <button class="best-scores-button warning" onclick="toggleBatchCSVDropdown()" style="background-color: #d4af37; color: #0a3d2e; margin-left:4px;">
                                    <i class="fas fa-file-csv"></i> CSV <i class="fas fa-caret-down"></i>
                                </button>
                                <div class="best-scores-dropdown" id="batchCSVDropdown">
                                    <div class="best-scores-option" onclick="showBatchReportDialog()"><i class="fas fa-download"></i> Export CSV</div>
                                    <div class="best-scores-option" onclick="document.getElementById('batchCSVImportInput').click()"><i class="fas fa-upload"></i> Import CSV</div>
                                </div>
                            </div>
                            <input type="file" id="batchCSVImportInput" accept=".csv" style="display: none;" onchange="importBatchCalculatorCSV(event)">
                        </div>
                    </h3>
                    
                    <div class="calculator-table-container">
                        <table id="batch-calculator-table" style="width: 100%; min-width: 100%; border-collapse: collapse; font-size: 9px; table-layout: auto; background-color: white;">
                            <thead style="background-color: #1a6b4f; color: white; position: sticky; top: 0; z-index: 100;">
                                <tr>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(0)">No <span id="batch-sort-0"></span></th>
                                    <th style="padding: 6px 4px; text-align: left; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; padding-left: 8px; cursor: pointer;" onclick="sortBatchTable(1)">Player Name <span id="batch-sort-1"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(2)">Players Index <span id="batch-sort-2"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(3)">Index Category <span id="batch-sort-3"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(4)">Prize Money Won <span id="batch-sort-4"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(5)">Stableford Points Scored <span id="batch-sort-5"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(6)">Swindle Finishing Position <span id="batch-sort-6"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle;">LGC Heritage Tees Colour (White)</th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle;">LGC Heritage Tees Colour (Yellow)</th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(9)">Players Previous Index <span id="batch-sort-9"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(10)">Total Adjustment <span id="batch-sort-10"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(11)">Players New Index <span id="batch-sort-11"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(12)">Course Handicap (White) <span id="batch-sort-12"></span></th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; white-space: normal; word-wrap: break-word; vertical-align: middle; cursor: pointer;" onclick="sortBatchTable(13)">Course Handicap (Yellow) <span id="batch-sort-13"></span></th>
                                </tr>
                            </thead>
                            <tbody id="batch-calculator-body">
                                <!-- Generated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- STATS TAB -->
        <div id="stats-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-chart-bar"></i> Player Statistics</h2>
                <div style="margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center;">
                    <div style="font-size: 9px; color: #666;">
                        <strong>Season Overview:</strong> Comprehensive statistics for all players across all weeks
                    </div>
                    <button onclick="refreshStats()" class="success" style="padding: 4px 10px; font-size: 9px;">
                        <i class="fas fa-sync-alt"></i> Refresh Stats
                    </button>
                </div>
                
                <div class="table-container" style="max-height: 75vh;">
                    <table id="stats-table" style="width: 100%; border-collapse: collapse; font-size: 9px; background-color: white;">
                        <thead style="background-color: #1a6b4f; color: white; position: sticky; top: 0; z-index: 100;">
                            <tr>
                                <th style="padding: 6px 4px; text-align: left; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Player Name</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Rounds Played</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Avg Stableford</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Best Score</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Worst Score</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Total Wins</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Total Won (¬£)</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Total Lost (¬£)</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Net P/L (¬£)</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1); white-space: nowrap;">Current Index</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; white-space: nowrap;">League Position</th>
                            </tr>
                        </thead>
                        <tbody id="stats-body">
                            <!-- Generated by JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <div class="footer text-tiny">
                    Statistics calculated from League, Scorecard, and Winners data
                </div>
            </div>
        </div>
        
        <!-- SWINDLE PRIZES TAB -->
        <div id="prizes-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-pound-sign"></i> SWINDLE Prize Distribution</h2>
                
                <div style="margin-bottom: 8px; font-size: 9px; color: inherit;">
                    <p style="margin-bottom: 4px;"><strong>Prize distribution based on number of players:</strong></p>
                    <p style="font-size: 8px; opacity: 0.8;">Each player contributes ¬£5 to the prize pot</p>
                </div>
                
                <!-- Prizes Table -->
                <div class="table-container" style="max-height: 70vh;">
                    <table id="prizes-table" style="width: 100%; border-collapse: collapse; font-size: 9px; background-color: white;">
                        <thead style="background-color: #1a6b4f; color: white; position: sticky; top: 0; z-index: 100;">
                            <tr>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1);">No. of Players</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1);">Prize Pot</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1);">1st</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1);">2nd</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1);">3rd</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1);">4th</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; border-right: 1px solid rgba(255, 255, 255, 0.1);">5th</th>
                                <th style="padding: 6px 4px; text-align: center; font-weight: 700; font-size: 8px; background-color: #2a8b6f;">Total</th>
                            </tr>
                        </thead>
                        <tbody id="prizes-body">
                            <tr><td>2</td><td>¬£10</td><td>¬£6</td><td>¬£4</td><td>-</td><td>-</td><td>-</td><td>¬£10</td></tr>
                            <tr><td>3</td><td>¬£15</td><td>¬£9</td><td>¬£6</td><td>-</td><td>-</td><td>-</td><td>¬£15</td></tr>
                            <tr><td>4</td><td>¬£20</td><td>¬£12</td><td>¬£8</td><td>-</td><td>-</td><td>-</td><td>¬£20</td></tr>
                            <tr><td>5</td><td>¬£25</td><td>¬£15</td><td>¬£10</td><td>-</td><td>-</td><td>-</td><td>¬£25</td></tr>
                            <tr><td>6</td><td>¬£30</td><td>¬£18</td><td>¬£12</td><td>-</td><td>-</td><td>-</td><td>¬£30</td></tr>
                            <tr><td>7</td><td>¬£35</td><td>¬£21</td><td>¬£14</td><td>-</td><td>-</td><td>-</td><td>¬£35</td></tr>
                            <tr><td>8</td><td>¬£40</td><td>¬£24</td><td>¬£16</td><td>-</td><td>-</td><td>-</td><td>¬£40</td></tr>
                            <tr><td>9</td><td>¬£45</td><td>¬£27</td><td>¬£18</td><td>-</td><td>-</td><td>-</td><td>¬£45</td></tr>
                            <tr><td>10</td><td>¬£50</td><td>¬£25</td><td>¬£15</td><td>¬£10</td><td>-</td><td>-</td><td>¬£50</td></tr>
                            <tr><td>11</td><td>¬£55</td><td>¬£28</td><td>¬£17</td><td>¬£10</td><td>-</td><td>-</td><td>¬£55</td></tr>
                            <tr><td>12</td><td>¬£60</td><td>¬£30</td><td>¬£18</td><td>¬£12</td><td>-</td><td>-</td><td>¬£60</td></tr>
                            <tr><td>13</td><td>¬£65</td><td>¬£33</td><td>¬£20</td><td>¬£12</td><td>-</td><td>-</td><td>¬£65</td></tr>
                            <tr><td>14</td><td>¬£70</td><td>¬£35</td><td>¬£21</td><td>¬£14</td><td>-</td><td>-</td><td>¬£70</td></tr>
                            <tr><td>15</td><td>¬£75</td><td>¬£38</td><td>¬£23</td><td>¬£14</td><td>-</td><td>-</td><td>¬£75</td></tr>
                            <tr><td>16</td><td>¬£80</td><td>¬£40</td><td>¬£24</td><td>¬£16</td><td>-</td><td>-</td><td>¬£80</td></tr>
                            <tr><td>17</td><td>¬£85</td><td>¬£43</td><td>¬£26</td><td>¬£16</td><td>-</td><td>-</td><td>¬£85</td></tr>
                            <tr><td>18</td><td>¬£90</td><td>¬£45</td><td>¬£27</td><td>¬£18</td><td>-</td><td>-</td><td>¬£90</td></tr>
                            <tr><td>19</td><td>¬£95</td><td>¬£43</td><td>¬£26</td><td>¬£16</td><td>¬£10</td><td>-</td><td>¬£95</td></tr>
                            <tr><td>20</td><td>¬£100</td><td>¬£45</td><td>¬£27</td><td>¬£17</td><td>¬£11</td><td>-</td><td>¬£100</td></tr>
                            <tr><td>21</td><td>¬£105</td><td>¬£47</td><td>¬£28</td><td>¬£18</td><td>¬£12</td><td>-</td><td>¬£105</td></tr>
                            <tr><td>22</td><td>¬£110</td><td>¬£50</td><td>¬£30</td><td>¬£19</td><td>¬£11</td><td>-</td><td>¬£110</td></tr>
                            <tr><td>23</td><td>¬£115</td><td>¬£52</td><td>¬£31</td><td>¬£20</td><td>¬£12</td><td>-</td><td>¬£115</td></tr>
                            <tr><td>24</td><td>¬£120</td><td>¬£54</td><td>¬£32</td><td>¬£20</td><td>¬£14</td><td>-</td><td>¬£120</td></tr>
                            <tr><td>25</td><td>¬£125</td><td>¬£56</td><td>¬£34</td><td>¬£21</td><td>¬£14</td><td>-</td><td>¬£125</td></tr>
                            <tr><td>26</td><td>¬£130</td><td>¬£59</td><td>¬£35</td><td>¬£22</td><td>¬£14</td><td>-</td><td>¬£130</td></tr>
                            <tr><td>27</td><td>¬£135</td><td>¬£61</td><td>¬£36</td><td>¬£23</td><td>¬£15</td><td>-</td><td>¬£135</td></tr>
                            <tr><td>28</td><td>¬£140</td><td>¬£59</td><td>¬£35</td><td>¬£22</td><td>¬£15</td><td>¬£9</td><td>¬£140</td></tr>
                            <tr><td>29</td><td>¬£145</td><td>¬£61</td><td>¬£36</td><td>¬£22</td><td>¬£15</td><td>¬£11</td><td>¬£145</td></tr>
                            <tr><td>30</td><td>¬£150</td><td>¬£63</td><td>¬£38</td><td>¬£23</td><td>¬£16</td><td>¬£10</td><td>¬£150</td></tr>
                            <tr><td>31</td><td>¬£155</td><td>¬£65</td><td>¬£39</td><td>¬£24</td><td>¬£16</td><td>¬£11</td><td>¬£155</td></tr>
                            <tr><td>32</td><td>¬£160</td><td>¬£67</td><td>¬£40</td><td>¬£25</td><td>¬£17</td><td>¬£11</td><td>¬£160</td></tr>
                            <tr><td>33</td><td>¬£165</td><td>¬£69</td><td>¬£41</td><td>¬£26</td><td>¬£17</td><td>¬£12</td><td>¬£165</td></tr>
                            <tr><td>34</td><td>¬£170</td><td>¬£71</td><td>¬£43</td><td>¬£26</td><td>¬£18</td><td>¬£12</td><td>¬£170</td></tr>
                            <tr><td>35</td><td>¬£175</td><td>¬£74</td><td>¬£44</td><td>¬£27</td><td>¬£18</td><td>¬£12</td><td>¬£175</td></tr>
                            <tr><td>36</td><td>¬£180</td><td>¬£76</td><td>¬£45</td><td>¬£28</td><td>¬£19</td><td>¬£12</td><td>¬£180</td></tr>
                            <tr><td>37</td><td>¬£185</td><td>¬£78</td><td>¬£46</td><td>¬£29</td><td>¬£19</td><td>¬£13</td><td>¬£185</td></tr>
                            <tr><td>38</td><td>¬£190</td><td>¬£80</td><td>¬£48</td><td>¬£29</td><td>¬£20</td><td>¬£13</td><td>¬£190</td></tr>
                            <tr><td>39</td><td>¬£195</td><td>¬£82</td><td>¬£49</td><td>¬£30</td><td>¬£20</td><td>¬£14</td><td>¬£195</td></tr>
                            <tr><td>40</td><td>¬£200</td><td>¬£84</td><td>¬£50</td><td>¬£31</td><td>¬£21</td><td>¬£14</td><td>¬£200</td></tr>
                            <tr><td>41</td><td>¬£205</td><td>¬£85</td><td>¬£51</td><td>¬£32</td><td>¬£22</td><td>¬£15</td><td>¬£205</td></tr>
                            <tr><td>42</td><td>¬£210</td><td>¬£86</td><td>¬£52</td><td>¬£33</td><td>¬£23</td><td>¬£16</td><td>¬£210</td></tr>
                            <tr><td>43</td><td>¬£215</td><td>¬£87</td><td>¬£53</td><td>¬£34</td><td>¬£24</td><td>¬£17</td><td>¬£215</td></tr>
                            <tr><td>44</td><td>¬£220</td><td>¬£88</td><td>¬£54</td><td>¬£35</td><td>¬£25</td><td>¬£18</td><td>¬£220</td></tr>
                            <tr><td>45</td><td>¬£225</td><td>¬£89</td><td>¬£55</td><td>¬£36</td><td>¬£26</td><td>¬£19</td><td>¬£225</td></tr>
                            <tr><td>46</td><td>¬£230</td><td>¬£90</td><td>¬£56</td><td>¬£37</td><td>¬£27</td><td>¬£20</td><td>¬£230</td></tr>
                            <tr><td>47</td><td>¬£235</td><td>¬£91</td><td>¬£57</td><td>¬£38</td><td>¬£28</td><td>¬£21</td><td>¬£235</td></tr>
                            <tr><td>48</td><td>¬£240</td><td>¬£92</td><td>¬£58</td><td>¬£39</td><td>¬£29</td><td>¬£22</td><td>¬£240</td></tr>
                            <tr><td>49</td><td>¬£245</td><td>¬£93</td><td>¬£59</td><td>¬£40</td><td>¬£30</td><td>¬£23</td><td>¬£245</td></tr>
                            <tr><td>50</td><td>¬£250</td><td>¬£94</td><td>¬£60</td><td>¬£41</td><td>¬£31</td><td>¬£24</td><td>¬£250</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="footer text-tiny">
                    Prize distribution is calculated based on ¬£5 per player
                </div>
            </div>
        </div>
    </div>
        <!-- ENHANCED SCORECARD TAB -->
        <div id="scorecard-tab" class="tab-content">
            <div class="section">
                <h2><i class="fas fa-clipboard-list"></i> Scorecard</h2>
                
                <!-- Course Information -->
                <div class="course-info">
                    <label>Week:</label>
                    <select id="weekSelector" onchange="changeWeek()">
                        <!-- Generated by JS -->
                    </select>
                    <label>Course Name:</label>
                    <input type="text" id="courseName" placeholder="Enter course name" value="Default Course">
                    <label>Date:</label>
                    <input type="date" id="scorecardDate" value="">
                    <label>Competition:</label>
                    <input type="text" id="competitionName" placeholder="PGA SWINDLE">
                    <button onclick="saveCourseInformation()" class="success" style="margin-left: 8px;">
                        <i class="fas fa-save"></i> Save Course Info
                    </button>
                </div>
                
                <!-- Scorecard Controls -->
                <div class="scorecard-controls">
                    <div class="button-group">
                        <button onclick="addScorecardPlayer()">
                            <i class="fas fa-user-plus"></i> Add Player
                        </button>
                        <button onclick="retrieveDrawData()" class="warning">
                            <i class="fas fa-users"></i> Retrieve Draw Data
                        </button>
                        <button onclick="fixScorecardIndexes()" class="warning" style="font-size: 9px; padding: 4px 8px;">
                            <i class="fas fa-wrench"></i> Fix Index Data
                        </button>
                        <button onclick="calculateScorecardTotals()" class="success">
                            <i class="fas fa-calculator"></i> Calculate
                        </button>
                        <button onclick="clearScorecard()" class="secondary">
                            <i class="fas fa-eraser"></i> Clear All
                        </button>
                    </div>
                    <div class="button-group">
                        <div class="best-scores-selector" style="display: inline-block;">
                            <button class="best-scores-button warning" onclick="toggleScorecardCSVDropdown()" style="background-color: #d4af37; color: #0a3d2e;">
                                <i class="fas fa-file-csv"></i> CSV <i class="fas fa-caret-down"></i>
                            </button>
                            <div class="best-scores-dropdown" id="scorecardCSVDropdown">
                                <div class="best-scores-option" onclick="exportScorecardCSV()"><i class="fas fa-download"></i> Export CSV</div>
                                <div class="best-scores-option" onclick="document.getElementById('scorecardCSVImportInput').click()"><i class="fas fa-upload"></i> Import CSV</div>
                            </div>
                        </div>
                        <input type="file" id="scorecardCSVImportInput" accept=".csv" style="display: none;" onchange="importScorecardCSV(event)">
                        <button onclick="captureScorecardImage()" class="secondary">
                            <i class="fas fa-camera"></i> Capture
                        </button>
                    </div>
                </div>
                
                <!-- Scorecard Table -->
                <div class="scorecard-table-container">
                    <table id="scorecard-table">
                        <thead id="scorecard-header">
                            <!-- Generated by JS -->
                        </thead>
                        <tbody id="scorecard-body">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
                
                <div class="footer text-tiny">
                    Enter gross scores ‚Ä¢ Stableford points calculated automatically below each hole ‚Ä¢ Colors: Par=Black, Birdie=Red, Eagle=Blue, Bogey=Purple, Double+=Pink
                </div>
            </div>
        </div>
    </div>

    <!-- OVERLAY -->
    <div id="overlay"></div>

    <!-- SCRIPTS -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // ============================================
        // GLOBAL VARIABLES
        // ============================================
        
        // League Data
        let leaguePlayers = [
            { id: 1, name: "Chris Powell" }, { id: 2, name: "Darren Sunter" },
            { id: 3, name: "Craig Palmer" }, { id: 4, name: "Daljit Basra" },
            { id: 5, name: "Dan Breeze" }, { id: 6, name: "Daren Davey" },
            { id: 7, name: "David Park" }, { id: 8, name: "David Quinlan" },
            { id: 9, name: "Duane Hayden" }, { id: 10, name: "Gamma Basra" },
            { id: 11, name: "Ian Hamilton" }, { id: 12, name: "James Andrews" },
            { id: 13, name: "James Ellis" }, { id: 14, name: "Jamie Dixon" },
            { id: 15, name: "Jeet Sohal" }, { id: 16, name: "Joe Ciampa" },
            { id: 17, name: "Johnathan Conlon" }, { id: 18, name: "Josh Eaton" },
            { id: 19, name: "Josh Kinnear" }, { id: 20, name: "Josh Roseberry" },
            { id: 21, name: "Julian Pennie" }, { id: 22, name: "Kamal Dhunna" },
            { id: 23, name: "Mark Hickman" }, { id: 24, name: "Mark Saunders" },
            { id: 25, name: "Michael Pacekmeyer" }, { id: 26, name: "Nick Eaton" },
            { id: 27, name: "Paul Bentley" }, { id: 28, name: "Peter Ramsden" },
            { id: 29, name: "Rich Moore" }, { id: 30, name: "Ringo Theara" },
            { id: 31, name: "Robert Brown" }, { id: 32, name: "Ryan Brown" },
            { id: 33, name: "Ryan Conlon" }, { id: 34, name: "Sean Casey" },
            { id: 35, name: "Stephen De Fraine" }, { id: 36, name: "Steve Cornwell" },
            { id: 37, name: "Stuart Kinge" }, { id: 38, name: "Tom McCarthy" },
            { id: 39, name: "Tony Chapman" }, { id: 40, name: "Tony Semple" }
        ];
        
        let playerData = [];
        let nextPlayerId = 41;
        let bestCount = 10; // Default to 10
        let totalWeeks = 25; // Can be adjusted
        
        // Handicap Data
        let uploadedFiles = [];
        let handicapPlayerData = [];
        let groups = [];
        
        // Enhanced Scorecard Data - Now stores data for all weeks
        let allWeeksScorecardData = {}; // Stores scorecard data for each week
        let currentWeek = 1; // Currently selected week
        let scorecardSortDescending = true; // true = highest to lowest stableford
        
        // H'CAP Calculator Data
        let calculatorData = [];
        let calculatorSortDescending = true; // true = highest to lowest, false = lowest to highest
        let showAllCalculatorPlayers = false; // false = only show scorecard players, true = show all 40 players
        
        // Winners Data - Stores winner data for each week
        let allWeeksWinnersData = {}; // Format: { week1: [{name, stableford, prize}, ...], week2: [...], ... }
        let currentWinnersWeek = 1;
        
        // Global PAR and INDEX values (shared across all weeks)
        let globalParValues = [4, 4, 3, 5, 4, 4, 3, 4, 5, 4, 3, 5, 4, 4, 3, 4, 5, 4];
        let globalIndexValues = [15, 5, 17, 3, 9, 11, 13, 7, 1, 16, 8, 4, 10, 6, 18, 12, 2, 14];
        
        let scorecardData = {
            players: [],
            courseName: "Default Course",
            date: "",
            competitionName: ""
        };
        let nextScorecardPlayerId = 1;
        
        // ============================================
        // TAB SWITCHING
        // ============================================
        
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab content
            const tabContent = document.getElementById(`${tabName}-tab`);
            if (tabContent) {
                tabContent.classList.add('active');
            }
            
            // Activate selected tab
            const selectedTab = document.querySelector(`.tab[data-tab="${tabName}"]`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Save to localStorage
            localStorage.setItem('activeTab', tabName);
            
            // Adjust table width if on league tab
            if (tabName === 'league') {
                setTimeout(() => {
                    adjustTableWidth();
                }, 100);
            }
            
            // Refresh calculator table when switching to winners tab
            if (tabName === 'winners') {
                initializeCalculatorWeekSelector();
                renderCalculatorTable();
                // Initialize Golf Handicap Calculator if not already initialized
                if (!window.golfCalcInitialized) {
                    initializeGolfCalculator();
                    window.golfCalcInitialized = true;
                }
            // Load and render HCAP Batch Calculator table
                if (!window.batchCalcInitialized) {
                    loadBatchCalculatorData(); // Load data first (restores saved week)
                    initializeBatchWeekSelector(); // Then initialize selector with loaded week
                    window.batchCalcInitialized = true;
                }
                renderBatchCalculatorTable();
            }
            
            // Refresh stats when switching to stats tab
            if (tabName === 'stats') {
                refreshStats();
            }
        }
        
        // ============================================
        // KEYBOARD NAVIGATION FUNCTIONS
        // ============================================
        
        function setupKeyboardNavigation() {
            // League table navigation
            document.querySelectorAll('#standings-table input[type="text"]').forEach(input => {
                input.addEventListener('keydown', handleLeagueKeyNavigation);
            });
            
            // Scorecard navigation
            document.querySelectorAll('#scorecard-table .score-input').forEach(input => {
                input.addEventListener('keydown', handleScorecardKeyNavigation);
            });
            
            // PAR and INDEX inputs navigation
            document.querySelectorAll('#scorecard-table .par-input, #scorecard-table .index-input').forEach(input => {
                input.addEventListener('keydown', handleParIndexKeyNavigation);
            });
        }
        
        function handleLeagueKeyNavigation(e) {
            if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                
                const currentInput = e.target;
                const currentCell = currentInput.parentElement;
                const currentRow = currentCell.parentElement;
                const currentIndex = Array.from(currentRow.cells).indexOf(currentCell);
                
                // Find the next input cell
                let nextCell;
                let nextRow = currentRow;
                
                // First try next cell in same row
                if (currentIndex < currentRow.cells.length - 6) { // -6 to skip last columns (PLD, Best, Total, Action)
                    nextCell = currentRow.cells[currentIndex + 1];
                } 
                // If at end of row, go to next row first cell
                else {
                    nextRow = currentRow.nextElementSibling;
                    if (nextRow && nextRow.classList.contains('player-score-row')) {
                        nextCell = nextRow.cells[2]; // First score cell is at index 2
                    }
                }
                
                // Focus on next input
                if (nextCell && nextCell.querySelector('input')) {
                    const nextInput = nextCell.querySelector('input');
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }
        
        function handleScorecardKeyNavigation(e) {
            if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                
                const currentInput = e.target;
                const playerIndex = parseInt(currentInput.dataset.player);
                const holeIndex = parseInt(currentInput.dataset.hole);
                
                // Find next hole input
                let nextHole = holeIndex + 1;
                let nextPlayer = playerIndex;
                
                // If at last hole (17), go to next player
                if (nextHole > 17) {
                    nextHole = 0;
                    nextPlayer = playerIndex + 1;
                    
                    // If at last player, wrap to first player
                    if (nextPlayer >= scorecardData.players.length) {
                        nextPlayer = 0;
                    }
                }
                
                // Find and focus next input
                const nextInput = document.querySelector(`.score-input[data-player="${nextPlayer}"][data-hole="${nextHole}"]`);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }
        
        function handleParIndexKeyNavigation(e) {
            if (e.key === 'Enter' || e.key === 'Tab') {
                e.preventDefault();
                
                const currentInput = e.target;
                const isParInput = currentInput.classList.contains('par-input');
                const holeIndex = parseInt(currentInput.dataset.hole);
                
                // Find next hole input of same type
                let nextHole = holeIndex + 1;
                
                // If at last hole (17), wrap to first hole
                if (nextHole > 17) {
                    nextHole = 0;
                }
                
                // Find and focus next input
                const nextSelector = isParInput ? `.par-input[data-hole="${nextHole}"]` : `.index-input[data-hole="${nextHole}"]`;
                const nextInput = document.querySelector(nextSelector);
                if (nextInput) {
                    nextInput.focus();
                    nextInput.select();
                }
            }
        }
        
        // ============================================
        // ENHANCED SCORECARD FUNCTIONS
        // ============================================
        
        function loadScorecardData() {
            // Load all weeks data
            const savedAllWeeks = localStorage.getItem('allWeeksScorecardData');
            if (savedAllWeeks) {
                allWeeksScorecardData = JSON.parse(savedAllWeeks);
            }
            
            // Load current week
            const savedCurrentWeek = localStorage.getItem('currentScorecardWeek');
            if (savedCurrentWeek) {
                currentWeek = parseInt(savedCurrentWeek);
            }
            
            // Load global PAR and INDEX values
            const savedParValues = localStorage.getItem('globalParValues');
            if (savedParValues) {
                globalParValues = JSON.parse(savedParValues);
            }
            
            const savedIndexValues = localStorage.getItem('globalIndexValues');
            if (savedIndexValues) {
                globalIndexValues = JSON.parse(savedIndexValues);
            }
            
            // Load data for current week
            if (allWeeksScorecardData[`week${currentWeek}`]) {
                scorecardData = allWeeksScorecardData[`week${currentWeek}`];
                nextScorecardPlayerId = scorecardData.players.length > 0 ? 
                    Math.max(...scorecardData.players.map(p => p.id)) + 1 : 1;
                
                // Update form fields
                document.getElementById('courseName').value = scorecardData.courseName || "";
                document.getElementById('scorecardDate').value = scorecardData.date || "";
                document.getElementById('competitionName').value = scorecardData.competitionName || "";
                
                return true;
            }
            return false;
        }
        
        function saveScorecardData() {
            // Update scorecardData from form fields
            scorecardData.courseName = document.getElementById('courseName').value;
            scorecardData.date = document.getElementById('scorecardDate').value;
            scorecardData.competitionName = document.getElementById('competitionName').value;
            
            // Save current week's data with deep copy to avoid reference issues
            allWeeksScorecardData[`week${currentWeek}`] = JSON.parse(JSON.stringify(scorecardData));
            
            // Save to localStorage
            localStorage.setItem('allWeeksScorecardData', JSON.stringify(allWeeksScorecardData));
            localStorage.setItem('currentScorecardWeek', currentWeek.toString());
            
            // Save global PAR and INDEX values
            localStorage.setItem('globalParValues', JSON.stringify(globalParValues));
            localStorage.setItem('globalIndexValues', JSON.stringify(globalIndexValues));
        }
        
        function initializeWeekSelector() {
            const selector = document.getElementById('weekSelector');
            if (!selector) return;
            
            // Clear existing options
            selector.innerHTML = '';
            
            // Add WK1 to WK25 options
            for (let i = 1; i <= 25; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `WK${i}`;
                if (i === currentWeek) {
                    option.selected = true;
                }
                selector.appendChild(option);
            }
        }
        
        function changeWeek() {
            const selector = document.getElementById('weekSelector');
            const newWeek = parseInt(selector.value);
            
            if (newWeek === currentWeek) return;
            
            // Save current week's data before switching (no need to save PAR/INDEX - they're global)
            saveScorecardData();
            
            // Switch to new week
            currentWeek = newWeek;
            localStorage.setItem('currentScorecardWeek', currentWeek.toString());
            
            // Reload all weeks data from localStorage to ensure we have fresh data
            const savedAllWeeks = localStorage.getItem('allWeeksScorecardData');
            if (savedAllWeeks) {
                allWeeksScorecardData = JSON.parse(savedAllWeeks);
            }
            
            // Load the new week's data (or create empty if doesn't exist)
            if (allWeeksScorecardData[`week${currentWeek}`]) {
                // Deep clone to avoid reference issues
                scorecardData = JSON.parse(JSON.stringify(allWeeksScorecardData[`week${currentWeek}`]));
                
                // Update next player ID
                if (scorecardData.players && scorecardData.players.length > 0) {
                    nextScorecardPlayerId = Math.max(...scorecardData.players.map(p => p.id || 0)) + 1;
                } else {
                    nextScorecardPlayerId = 1;
                }
            } else {
                // Create new empty scorecard for this week
                scorecardData = {
                    players: [],
                    courseName: "Default Course",
                    date: "",
                    competitionName: ""
                };
                nextScorecardPlayerId = 1;
            }
            
            // Update form fields
            document.getElementById('courseName').value = scorecardData.courseName || "Default Course";
            document.getElementById('scorecardDate').value = scorecardData.date || "";
            document.getElementById('competitionName').value = scorecardData.competitionName || "";
            
            // Save the current week to localStorage
            localStorage.setItem('currentScorecardWeek', currentWeek.toString());
            
            // Re-render the scorecard (PAR and INDEX will use global values)
            // renderScorecard() already sets up all event listeners and calculates totals
            renderScorecard();
            
            // Update calculator week selector and table
            initializeCalculatorWeekSelector();
            renderCalculatorTable();
        }
        
        function toggleScorecardSort() {
            scorecardSortDescending = !scorecardSortDescending;
            
            // Update sort indicator
            const indicator = document.getElementById('scorecard-sort-indicator');
            if (indicator) {
                indicator.textContent = scorecardSortDescending ? '\u25bc' : '\u25b2';
            }
            
            // Sort players by stableford total with countback tiebreakers
            scorecardData.players.sort((a, b) => {
                // Calculate stableford for each player
                const aHandicap = parseFloat(a.whiteTees) || a.handicap || 0;
                const bHandicap = parseFloat(b.whiteTees) || b.handicap || 0;
                
                const aPoints = [];
                const bPoints = [];
                
                for (let hole = 0; hole < 18; hole++) {
                    const aGross = parseInt(a.scores[hole]) || 0;
                    const bGross = parseInt(b.scores[hole]) || 0;
                    
                    let aHolePoints = 0;
                    if (aGross > 0) {
                        const par = globalParValues[hole] || 4;
                        const holeIndex = globalIndexValues[hole] || (hole + 1);
                        const strokesReceived = calculateStrokesForHole(aHandicap, holeIndex);
                        const adjustedPar = par + strokesReceived;
                        const diff = aGross - adjustedPar;
                        
                        if (diff <= -2) aHolePoints = 4;
                        else if (diff === -1) aHolePoints = 3;
                        else if (diff === 0) aHolePoints = 2;
                        else if (diff === 1) aHolePoints = 1;
                    }
                    aPoints.push(aHolePoints);
                    
                    let bHolePoints = 0;
                    if (bGross > 0) {
                        const par = globalParValues[hole] || 4;
                        const holeIndex = globalIndexValues[hole] || (hole + 1);
                        const strokesReceived = calculateStrokesForHole(bHandicap, holeIndex);
                        const adjustedPar = par + strokesReceived;
                        const diff = bGross - adjustedPar;
                        
                        if (diff <= -2) bHolePoints = 4;
                        else if (diff === -1) bHolePoints = 3;
                        else if (diff === 0) bHolePoints = 2;
                        else if (diff === 1) bHolePoints = 1;
                    }
                    bPoints.push(bHolePoints);
                }
                
                // Calculate all countback values
                const aTotal = aPoints.reduce((sum, p) => sum + p, 0);
                const bTotal = bPoints.reduce((sum, p) => sum + p, 0);
                const aBack9 = aPoints.slice(9, 18).reduce((sum, p) => sum + p, 0);
                const bBack9 = bPoints.slice(9, 18).reduce((sum, p) => sum + p, 0);
                const aBack6 = aPoints.slice(12, 18).reduce((sum, p) => sum + p, 0); // Holes 13-18
                const bBack6 = bPoints.slice(12, 18).reduce((sum, p) => sum + p, 0);
                const aBack3 = aPoints.slice(15, 18).reduce((sum, p) => sum + p, 0); // Holes 16,17,18
                const bBack3 = bPoints.slice(15, 18).reduce((sum, p) => sum + p, 0);
                const aBack2 = aPoints.slice(16, 18).reduce((sum, p) => sum + p, 0); // Holes 17,18
                const bBack2 = bPoints.slice(16, 18).reduce((sum, p) => sum + p, 0);
                const aBack1 = aPoints[17]; // Hole 18
                const bBack1 = bPoints[17];
                const aFront9 = aPoints.slice(0, 9).reduce((sum, p) => sum + p, 0);
                const bFront9 = bPoints.slice(0, 9).reduce((sum, p) => sum + p, 0);
                const aFront6 = aPoints.slice(3, 9).reduce((sum, p) => sum + p, 0); // Holes 4-9
                const bFront6 = bPoints.slice(3, 9).reduce((sum, p) => sum + p, 0);
                const aFront3 = aPoints.slice(6, 9).reduce((sum, p) => sum + p, 0); // Holes 7,8,9
                const bFront3 = bPoints.slice(6, 9).reduce((sum, p) => sum + p, 0);
                const aFront2 = aPoints.slice(7, 9).reduce((sum, p) => sum + p, 0); // Holes 8,9
                const bFront2 = bPoints.slice(7, 9).reduce((sum, p) => sum + p, 0);
                const aFront1 = aPoints[8]; // Hole 9
                const bFront1 = bPoints[8];
                
                // Apply full 11-level countback
                if (aTotal !== bTotal) return scorecardSortDescending ? bTotal - aTotal : aTotal - bTotal;
                if (aBack9 !== bBack9) return scorecardSortDescending ? bBack9 - aBack9 : aBack9 - bBack9;
                if (aBack6 !== bBack6) return scorecardSortDescending ? bBack6 - aBack6 : aBack6 - bBack6;
                if (aBack3 !== bBack3) return scorecardSortDescending ? bBack3 - aBack3 : aBack3 - bBack3;
                if (aBack2 !== bBack2) return scorecardSortDescending ? bBack2 - aBack2 : aBack2 - bBack2;
                if (aBack1 !== bBack1) return scorecardSortDescending ? bBack1 - aBack1 : aBack1 - bBack1;
                if (aFront9 !== bFront9) return scorecardSortDescending ? bFront9 - aFront9 : aFront9 - bFront9;
                if (aFront6 !== bFront6) return scorecardSortDescending ? bFront6 - aFront6 : aFront6 - bFront6;
                if (aFront3 !== bFront3) return scorecardSortDescending ? bFront3 - aFront3 : aFront3 - bFront3;
                if (aFront2 !== bFront2) return scorecardSortDescending ? bFront2 - aFront2 : aFront2 - bFront2;
                return scorecardSortDescending ? bFront1 - aFront1 : aFront1 - bFront1;
            });
            
            // Save and re-render
            saveScorecardData();
            renderScorecard();
        }
        
        function renderScorecard() {
            const header = document.getElementById('scorecard-header');
            const body = document.getElementById('scorecard-body');
            
            // Clear existing table
            header.innerHTML = '';
            body.innerHTML = '';
            
            // Create header
            let headerHTML = `
                <tr>
                    <th class="player-header">Player<br><span style="font-size:6px;font-weight:normal;">(Handicap)</span></th>
            `;
            
            // Add hole headers (1-18)
            for (let i = 1; i <= 18; i++) {
                headerHTML += `<th class="hole-header">${i}</th>`;
            }
            
            // Add section headers
            headerHTML += `
                    <th class="section-header">F9</th>
                    <th class="section-header">B9</th>
                    <th class="section-header">GROSS</th>
                    <th class="section-header" onclick="toggleScorecardSort()" style="cursor: pointer; user-select: none;">STBLFD <span id="scorecard-sort-indicator">‚ñº</span></th>
                    <th class="section-header countback">CB 13-18</th>
                    <th class="section-header countback">CB 16-18</th>
                    <th class="hole-header">Action</th>
                </tr>
            `;
            
            header.innerHTML = headerHTML;
            
            // Create PAR row
            const parRow = document.createElement('tr');
            parRow.className = 'par-row';
            let parHTML = '<td class="player-cell" style="background-color: #e8f5e9; font-weight: 800; color: #2e7d32;">PAR</td>';
            
            for (let i = 0; i < 18; i++) {
                parHTML += `<td class="hole-cell par-cell"><input type="number" value="${globalParValues[i] || 4}" min="1" max="10" data-hole="${i}" class="par-input"></td>`;
            }
            
            parHTML += '<td class="section-cell" id="par-front9">0</td>';
            parHTML += '<td class="section-cell" id="par-back9">0</td>';
            parHTML += '<td class="section-cell" id="par-gross">0</td>';
            parHTML += '<td class="section-cell" id="par-stableford">0</td>';
            parHTML += '<td class="section-cell countback" id="par-countback">0</td>';
            parHTML += '<td class="section-cell countback" id="par-countback2">0</td>';
            parHTML += '<td class="hole-cell"></td>';
            
            parRow.innerHTML = parHTML;
            body.appendChild(parRow);
            
            // Create INDEX row
            const indexRow = document.createElement('tr');
            indexRow.className = 'index-row';
            let indexHTML = '<td class="player-cell" style="background-color: #e3f2fd; font-weight: 800; color: #1565c0;">INDEX</td>';
            
            for (let i = 0; i < 18; i++) {
                indexHTML += `<td class="hole-cell index-cell"><input type="number" value="${globalIndexValues[i] || (i+1)}" min="1" max="18" data-hole="${i}" class="index-input"></td>`;
            }
            
            indexHTML += '<td class="section-cell">-</td>';
            indexHTML += '<td class="section-cell">-</td>';
            indexHTML += '<td class="section-cell">-</td>';
            indexHTML += '<td class="section-cell">-</td>';
            indexHTML += '<td class="section-cell countback">-</td>';
            indexHTML += '<td class="section-cell countback">-</td>';
            indexHTML += '<td class="hole-cell"></td>';
            
            indexRow.innerHTML = indexHTML;
            body.appendChild(indexRow);
            
            // Add player rows
            scorecardData.players.forEach((player, playerIndex) => {
                // GROSS SCORE ROW
                const grossRow = document.createElement('tr');
                grossRow.className = 'player-score-row';
                grossRow.dataset.playerId = player.id;
                
                let grossHTML = `<td class="player-cell" rowspan="2">${player.name}<br><span style="font-size:6px;color:#666;">Index: ${player.pgaIndex !== undefined && player.pgaIndex !== null && player.pgaIndex !== '' ? player.pgaIndex : 'N/A'} | White: ${player.whiteTees !== undefined && player.whiteTees !== null && player.whiteTees !== '' ? player.whiteTees : 'N/A'} | Yellow: ${player.yellowTees !== undefined && player.yellowTees !== null && player.yellowTees !== '' ? player.yellowTees : 'N/A'}</span></td>`;
                
                // Add hole gross score input cells
                for (let hole = 0; hole < 18; hole++) {
                    const score = player.scores[hole] || '';
                    grossHTML += `
                        <td class="hole-cell hole-score-cell">
                            <input type="number" 
                                   value="${score}" 
                                   min="1" max="15" 
                                   data-player="${playerIndex}" 
                                   data-hole="${hole}" 
                                   class="score-input">
                        </td>
                    `;
                }
                
                // Add gross total columns
                grossHTML += `<td class="section-cell" id="front9-${player.id}">0</td>`;
                grossHTML += `<td class="section-cell" id="back9-${player.id}">0</td>`;
                grossHTML += `<td class="section-cell" id="gross-${player.id}">0</td>`;
                grossHTML += `<td class="section-cell">-</td>`; // Empty for stableford on gross row
                grossHTML += `<td class="section-cell" id="countback-${player.id}">0</td>`;
                grossHTML += `<td class="section-cell" id="countback2-${player.id}">0</td>`;
                grossHTML += `<td class="hole-cell" rowspan="2">
                    <button class="scorecard-delete-btn" onclick="editScorecardPlayer(${player.id})" style="background-color: #4a90e2; margin-bottom: 2px;" title="Edit Player">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="scorecard-delete-btn" onclick="removeScorecardPlayer(${player.id})" title="Delete Player">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>`;
                
                grossRow.innerHTML = grossHTML;
                body.appendChild(grossRow);
                
                // STABLEFORD ROW
                const stablefordRow = document.createElement('tr');
                stablefordRow.className = 'stableford-row';
                stablefordRow.dataset.playerId = player.id;
                
                let stablefordHTML = '';
                
                // Add stableford points cells for each hole
                for (let hole = 0; hole < 18; hole++) {
                    const score = player.scores[hole] || '';
                    const stableford = calculateStablefordForHole(playerIndex, hole);
                    const stablefordClass = score && stableford !== null ? `stableford-${stableford}` : '';
                    
                    stablefordHTML += `
                        <td class="hole-cell">
                            <span class="stableford-points ${stablefordClass}" id="stableford-${player.id}-${hole}">
                                ${score && stableford !== null ? stableford : ''}
                            </span>
                        </td>
                    `;
                }
                
                // Add stableford total columns
                stablefordHTML += `<td class="section-cell" id="stableford-front9-${player.id}">0</td>`;
                stablefordHTML += `<td class="section-cell" id="stableford-back9-${player.id}">0</td>`;
                stablefordHTML += `<td class="section-cell">-</td>`; // Empty for gross on stableford row
                stablefordHTML += `<td class="section-cell stableford-total" id="stableford-total-${player.id}">0</td>`;
                stablefordHTML += `<td class="section-cell" id="stableford-countback-${player.id}">0</td>`;
                stablefordHTML += `<td class="section-cell" id="stableford-countback2-${player.id}">0</td>`;
                
                stablefordRow.innerHTML = stablefordHTML;
                body.appendChild(stablefordRow);
            });
            
            // Add event listeners for PAR inputs
            document.querySelectorAll('.par-input').forEach(input => {
                input.addEventListener('change', function() {
                    const hole = parseInt(this.dataset.hole);
                    const value = parseInt(this.value) || 4;
                    globalParValues[hole] = value;
                    calculateScorecardTotals();
                });
                input.addEventListener('blur', function() {
                    const hole = parseInt(this.dataset.hole);
                    const value = parseInt(this.value) || 4;
                    globalParValues[hole] = value;
                    saveScorecardData();
                });
            });
            
            // Add event listeners for INDEX inputs
            document.querySelectorAll('.index-input').forEach(input => {
                input.addEventListener('change', function() {
                    const hole = parseInt(this.dataset.hole);
                    const value = parseInt(this.value) || (hole + 1);
                    globalIndexValues[hole] = value;
                    calculateScorecardTotals();
                });
                input.addEventListener('blur', function() {
                    const hole = parseInt(this.dataset.hole);
                    const value = parseInt(this.value) || (hole + 1);
                    globalIndexValues[hole] = value;
                    saveScorecardData();
                });
            });
            
            // Add event listeners for handicap inputs
            document.querySelectorAll('.handicap-input').forEach(input => {
                input.addEventListener('input', function() {
                    const playerIndex = parseInt(this.dataset.player);
                    const value = parseFloat(this.value) || 0;
                    
                    scorecardData.players[playerIndex].handicap = value;
                    saveScorecardData();
                    calculateScorecardTotals();
                });
            });
            
            // Add event listeners for score inputs
            document.querySelectorAll('.score-input').forEach(input => {
                input.addEventListener('input', function() {
                    const playerIndex = parseInt(this.dataset.player);
                    const hole = parseInt(this.dataset.hole);
                    const value = this.value.trim() === '' ? '' : parseInt(this.value) || 0;
                    
                    scorecardData.players[playerIndex].scores[hole] = value;
                    saveScorecardData();
                    
                    // Update the stableford points display for this hole
                    updateStablefordForHole(playerIndex, hole);
                    
                    // Calculate all totals for this player
                    calculatePlayerTotalsScorecard(playerIndex);
                });
                
                // Add keyboard navigation
                input.addEventListener('keydown', handleScorecardKeyNavigation);
            });
            
            // Setup keyboard navigation for PAR and INDEX inputs
            document.querySelectorAll('.par-input, .index-input').forEach(input => {
                input.addEventListener('keydown', handleParIndexKeyNavigation);
            });
            
            // Calculate initial totals
            calculateScorecardTotals();
        }
        
        // Helper function to calculate strokes for a hole (handles plus handicaps correctly)
        function calculateStrokesForHole(playerHandicap, holeIndex) {
            if (playerHandicap < 0) {
                // Minus/plus handicap players: give strokes back on EASIEST holes (highest index numbers)
                const absHandicap = Math.abs(playerHandicap);
                const strokesPerHole = Math.floor(absHandicap / 18);
                const extraStrokesCount = Math.round(absHandicap % 18);
                // Give back stroke if hole index is in the easiest holes (18 down to 18-extraStrokesCount+1)
                const extraStroke = holeIndex > (18 - extraStrokesCount) ? 1 : 0;
                return -(strokesPerHole + extraStroke);
            } else {
                // Regular handicap: receive strokes on hardest holes
                const strokesPerHole = Math.floor(playerHandicap / 18);
                const extraStrokesCount = Math.round(playerHandicap % 18);
                const extraStroke = holeIndex <= extraStrokesCount ? 1 : 0;
                return strokesPerHole + extraStroke;
            }
        }
        
        function calculateStablefordForHole(playerIndex, hole) {
            const player = scorecardData.players[playerIndex];
            if (!player) return null; // Return null instead of 0 for no score
            
            const score = parseInt(player.scores[hole]) || 0;
            if (score <= 0) return null; // Return null for no score or zero
            
            const par = globalParValues[hole] || 4;
            // Use White Tees playing handicap instead of Index
            const playerHandicap = (player.whiteTees !== undefined && player.whiteTees !== null && player.whiteTees !== '') 
                ? parseFloat(player.whiteTees) 
                : (parseFloat(player.handicap) || 0);
            const holeIndex = globalIndexValues[hole] || (hole + 1);
            
            // Calculate strokes received on this hole
            const strokesReceived = calculateStrokesForHole(playerHandicap, holeIndex);
            
            // Adjust par for handicap
            const adjustedPar = par + strokesReceived;
            
            // Calculate stableford points
            const diff = score - adjustedPar;
            let points = 0;
            
            if (diff <= -2) points = 4; // Eagle or better (2+ under adjusted par)
            else if (diff === -1) points = 3; // Birdie (1 under adjusted par)
            else if (diff === 0) points = 2; // Par (on adjusted par)
            else if (diff === 1) points = 1; // Bogey (1 over adjusted par)
            // 0 points for double bogey or worse
            
            // COMPREHENSIVE DEBUG LOGGING FOR ALL PLAYERS AND HOLES
            console.log(`===== HOLE ${hole + 1} - ${player.name} =====`);
            console.log(`Raw values: whiteTees='${player.whiteTees}', handicap='${player.handicap}'`);
            console.log(`playerHandicap used: ${playerHandicap}`);
            console.log(`Par: ${par}, Hole Index: ${holeIndex}, Gross Score: ${score}`);
            console.log(`Strokes Received: ${strokesReceived}`);
            console.log(`Adjusted Par: ${adjustedPar}`);
            console.log(`Diff (Score - Adj Par): ${diff}`);
            console.log(`Stableford Points: ${points}`);
            console.log(`==========================================`);
            
            return points;
        }
        
        function updateStablefordForHole(playerIndex, hole) {
            const player = scorecardData.players[playerIndex];
            if (!player) return;
            
            const score = player.scores[hole];
            const stableford = calculateStablefordForHole(playerIndex, hole);
            const stablefordElement = document.getElementById(`stableford-${player.id}-${hole}`);
            
            if (stablefordElement) {
                // Only apply color class if there's a score and stableford is calculated
                if (score && stableford !== null) {
                    const stablefordClass = `stableford-${stableford}`;
                    stablefordElement.className = `stableford-points ${stablefordClass}`;
                    stablefordElement.textContent = stableford;
                } else {
                    // No score - use default white background
                    stablefordElement.className = 'stableford-points';
                    stablefordElement.textContent = '';
                }
            }
        }
        
        function calculateScorecardTotals() {
            // Calculate PAR totals
            const parFront9 = globalParValues.slice(0, 9).reduce((sum, val) => sum + (val || 0), 0);
            const parBack9 = globalParValues.slice(9, 18).reduce((sum, val) => sum + (val || 0), 0);
            const parGross = parFront9 + parBack9;
            
            document.getElementById('par-front9').textContent = parFront9;
            document.getElementById('par-back9').textContent = parBack9;
            document.getElementById('par-gross').textContent = parGross;
            document.getElementById('par-stableford').textContent = parGross * 2; // Assuming 2 points per par
            document.getElementById('par-countback').textContent = globalParValues.slice(12, 18).reduce((sum, val) => sum + (val || 0), 0);
            document.getElementById('par-countback2').textContent = globalParValues.slice(15, 18).reduce((sum, val) => sum + (val || 0), 0); // Holes 16-18
            
            // Calculate each player's totals
            scorecardData.players.forEach((player, index) => {
                calculatePlayerTotalsScorecard(index);
            });
        }
        
        function calculatePlayerTotalsScorecard(playerIndex) {
            const player = scorecardData.players[playerIndex];
            if (!player) return;
            
            // Calculate front 9 gross (holes 1-9) - only count valid scores
            const front9Scores = player.scores.slice(0, 9).filter(s => s !== '' && s !== null && s !== undefined);
            const front9Gross = front9Scores.reduce((sum, val) => sum + (parseInt(val) || 0), 0);
            
            // Calculate back 9 gross (holes 10-18) - only count valid scores
            const back9Scores = player.scores.slice(9, 18).filter(s => s !== '' && s !== null && s !== undefined);
            const back9Gross = back9Scores.reduce((sum, val) => sum + (parseInt(val) || 0), 0);
            
            // Calculate gross total
            const grossTotal = front9Gross + back9Gross;
            
            // Calculate stableford points for front 9
            let stablefordFront9 = 0;
            for (let hole = 0; hole < 9; hole++) {
                const points = calculateStablefordForHole(playerIndex, hole);
                if (points !== null) {
                    stablefordFront9 += points;
                }
            }
            
            // Calculate stableford points for back 9
            let stablefordBack9 = 0;
            for (let hole = 9; hole < 18; hole++) {
                const points = calculateStablefordForHole(playerIndex, hole);
                if (points !== null) {
                    stablefordBack9 += points;
                }
            }
            
            // Calculate total stableford points
            const totalStableford = stablefordFront9 + stablefordBack9;
            
            // Calculate countback gross (holes 13-18)
            const countbackGrossScores = player.scores.slice(12, 18).filter(s => s !== '' && s !== null && s !== undefined);
            const countbackGross = countbackGrossScores.reduce((sum, val) => sum + (parseInt(val) || 0), 0);
            
            // Calculate countback stableford (holes 13-18)
            let countbackStableford = 0;
            for (let hole = 12; hole < 18; hole++) {
                const points = calculateStablefordForHole(playerIndex, hole);
                if (points !== null) {
                    countbackStableford += points;
                }
            }
            
            // Calculate countback2 gross (holes 16-18)
            const countback2GrossScores = player.scores.slice(15, 18).filter(s => s !== '' && s !== null && s !== undefined);
            const countback2Gross = countback2GrossScores.reduce((sum, val) => sum + (parseInt(val) || 0), 0);
            
            // Calculate countback2 stableford (holes 16-18)
            let countback2Stableford = 0;
            for (let hole = 15; hole < 18; hole++) {
                const points = calculateStablefordForHole(playerIndex, hole);
                if (points !== null) {
                    countback2Stableford += points;
                }
            }
            
            // Update the gross row
            const front9El = document.getElementById(`front9-${player.id}`);
            const back9El = document.getElementById(`back9-${player.id}`);
            const grossEl = document.getElementById(`gross-${player.id}`);
            const countbackEl = document.getElementById(`countback-${player.id}`);
            const countback2El = document.getElementById(`countback2-${player.id}`);
            
            if (front9El) front9El.textContent = front9Gross || 0;
            if (back9El) back9El.textContent = back9Gross || 0;
            if (grossEl) grossEl.textContent = grossTotal || 0;
            if (countbackEl) countbackEl.textContent = countbackGross || 0;
            if (countback2El) countback2El.textContent = countback2Gross || 0;
            
            // Update the stableford row
            const stablefordFront9El = document.getElementById(`stableford-front9-${player.id}`);
            const stablefordBack9El = document.getElementById(`stableford-back9-${player.id}`);
            const stablefordTotalEl = document.getElementById(`stableford-total-${player.id}`);
            const stablefordCountbackEl = document.getElementById(`stableford-countback-${player.id}`);
            const stablefordCountback2El = document.getElementById(`stableford-countback2-${player.id}`);
            
            if (stablefordFront9El) stablefordFront9El.textContent = stablefordFront9 || 0;
            if (stablefordBack9El) stablefordBack9El.textContent = stablefordBack9 || 0;
            if (stablefordTotalEl) stablefordTotalEl.textContent = totalStableford || 0;
            if (stablefordCountbackEl) stablefordCountbackEl.textContent = countbackStableford || 0;
            if (stablefordCountback2El) stablefordCountback2El.textContent = countback2Stableford || 0;
            
            // Update all stableford point displays
            for (let hole = 0; hole < 18; hole++) {
                updateStablefordForHole(playerIndex, hole);
            }
        }
        
        function addScorecardPlayer() {
            const name = prompt("Enter player name:");
            if (!name || name.trim() === '') return;
            
            const handicapStr = prompt("Enter player handicap (default: 0):", "0");
            const handicap = parseFloat(handicapStr) || 0;
            
            const indexStr = prompt("Enter player index (default: 0):", "0");
            const pgaIndex = parseFloat(indexStr) || 0;
            
            const whiteTeesStr = prompt("Enter White Tees handicap (default: 0):", "0");
            const whiteTees = parseFloat(whiteTeesStr) || 0;
            
            const yellowTeesStr = prompt("Enter Yellow Tees handicap (default: 0):", "0");
            const yellowTees = parseFloat(yellowTeesStr) || 0;
            
            if (scorecardData.players.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Player already exists in scorecard');
                return;
            }
            
            const newPlayer = {
                id: nextScorecardPlayerId++,
                name: name.trim(),
                handicap: handicap,
                pgaIndex: pgaIndex,
                whiteTees: whiteTees,
                yellowTees: yellowTees,
                scores: Array(18).fill('')
            };
            
            scorecardData.players.push(newPlayer);
            saveScorecardData();
            renderScorecard();
        }
        
        function editScorecardPlayer(playerId) {
            const playerIndex = scorecardData.players.findIndex(p => p.id === playerId);
            if (playerIndex === -1) return;
            
            const player = scorecardData.players[playerIndex];
            
            // Prompt for new values, showing current values as defaults
            const newName = prompt("Edit player name:", player.name);
            if (newName === null) return; // User cancelled
            if (newName.trim() === '') {
                alert('Player name cannot be empty');
                return;
            }
            
            // Check if new name already exists (excluding current player)
            if (newName.toLowerCase() !== player.name.toLowerCase() && 
                scorecardData.players.some(p => p.name.toLowerCase() === newName.toLowerCase())) {
                alert('A player with this name already exists in the scorecard');
                return;
            }
            
            const newHandicap = prompt("Edit player handicap:", player.handicap || 0);
            if (newHandicap === null) return;
            
            const newIndex = prompt("Edit player index:", player.pgaIndex || 0);
            if (newIndex === null) return;
            
            const newWhiteTees = prompt("Edit White Tees handicap:", player.whiteTees || 0);
            if (newWhiteTees === null) return;
            
            const newYellowTees = prompt("Edit Yellow Tees handicap:", player.yellowTees || 0);
            if (newYellowTees === null) return;
            
            // Update player data
            player.name = newName.trim();
            player.handicap = parseFloat(newHandicap) || 0;
            player.pgaIndex = parseFloat(newIndex) || 0;
            player.whiteTees = parseFloat(newWhiteTees) || 0;
            player.yellowTees = parseFloat(newYellowTees) || 0;
            
            // Save and re-render
            saveScorecardData();
            renderScorecard();
            alert('Player details updated successfully!');
        }
        
        function removeScorecardPlayer(playerId) {
            if (confirm('Remove player from scorecard?')) {
                const index = scorecardData.players.findIndex(p => p.id === playerId);
                if (index !== -1) {
                    scorecardData.players.splice(index, 1);
                    saveScorecardData();
                    renderScorecard();
                }
            }
        }
        
        function clearScorecard() {
            if (confirm(`Clear scorecard data for WK${currentWeek}? This will remove all players and reset the scorecard.`)) {
                scorecardData.players = [];
                scorecardData.courseName = "Default Course";
                scorecardData.date = "";
                scorecardData.competitionName = "";
                
                document.getElementById('courseName').value = scorecardData.courseName;
                document.getElementById('scorecardDate').value = scorecardData.date;
                document.getElementById('competitionName').value = "";
                
                saveScorecardData();
                renderScorecard();
            }
        }
        
        function saveCourseInformation() {
            // Update scorecardData from form fields
            scorecardData.courseName = document.getElementById('courseName').value;
            scorecardData.date = document.getElementById('scorecardDate').value;
            scorecardData.competitionName = document.getElementById('competitionName').value;
            
            // Save global PAR and INDEX values from the table
            document.querySelectorAll('.par-input').forEach(input => {
                const hole = parseInt(input.dataset.hole);
                const value = parseInt(input.value) || 4;
                globalParValues[hole] = value;
            });
            
            document.querySelectorAll('.index-input').forEach(input => {
                const hole = parseInt(input.dataset.hole);
                const value = parseInt(input.value) || (parseInt(input.dataset.hole) + 1);
                globalIndexValues[hole] = value;
            });
            
            saveScorecardData();
            alert(`Course information saved (PAR/INDEX apply to all weeks)`);
        }
        
        function fixScorecardIndexes() {
            // Reload handicap data to ensure we have the latest draw
            loadHandicapData();
            
            if (!groups || groups.length === 0) {
                alert('No draw data found in Handicap tab.');
                return;
            }
            
            if (scorecardData.players.length === 0) {
                alert('No players in current scorecard.');
                return;
            }
            
            // Build a map of player names to their handicap data
            const handicapMap = new Map();
            groups.forEach(group => {
                if (group.players && Array.isArray(group.players)) {
                    group.players.forEach(player => {
                        if (player && player.name) {
                            const key = player.name.toLowerCase().trim();
                            handicapMap.set(key, {
                                newIndex: player.newIndex,
                                pgaIndex: player.pgaIndex,
                                whiteTees: player.whiteTees,
                                yellowTees: player.yellowTees
                            });
                        }
                    });
                }
            });
            
            let fixedCount = 0;
            
            // Update scorecard players with handicap data
            scorecardData.players.forEach(player => {
                const key = player.name.toLowerCase().trim();
                if (handicapMap.has(key)) {
                    const hData = handicapMap.get(key);
                    const indexValue = hData.newIndex || hData.pgaIndex;
                    
                    // Fix pgaIndex
                    if (indexValue && indexValue !== 'N/A') {
                        player.pgaIndex = indexValue;
                        fixedCount++;
                    }
                    
                    // Fix whiteTees
                    if (hData.whiteTees !== undefined && hData.whiteTees !== null && hData.whiteTees !== '') {
                        player.whiteTees = hData.whiteTees;
                    }
                    
                    // Fix yellowTees
                    if (hData.yellowTees !== undefined && hData.yellowTees !== null && hData.yellowTees !== '') {
                        player.yellowTees = hData.yellowTees;
                    }
                }
            });
            
            if (fixedCount > 0) {
                saveScorecardData();
                renderScorecard();
                alert(`Fixed Index/Tees data for ${fixedCount} player(s) in Week ${currentWeek} from Handicap draw.`);
            } else {
                alert('No matching players found between scorecard and handicap draw.');
            }
        }
        
        function retrieveDrawData() {
            // Reload handicap data to ensure we have the latest draw
            loadHandicapData();
            
            // Check if there are groups in the draw
            if (!groups || groups.length === 0) {
                alert('No draw data found. Please create a draw in the Handicap tab first.');
                return;
            }
            
            // Collect all players from all groups
            const drawPlayers = [];
            let totalPlayersInGroups = 0;
            
            groups.forEach((group, groupIndex) => {
                if (group.players && Array.isArray(group.players)) {
                    totalPlayersInGroups += group.players.length;
                    group.players.forEach(player => {
                        // Only add if player has a name
                        if (player && player.name) {
                            drawPlayers.push(player);
                        }
                    });
                }
            });
            
            console.log(`Total groups: ${groups.length}`);
            console.log(`Total players found in groups: ${totalPlayersInGroups}`);
            console.log(`Valid players to retrieve: ${drawPlayers.length}`);
            
            if (drawPlayers.length === 0) {
                alert('No players found in the draw.');
                return;
            }
            
            // Ask user if they want to replace existing players or add to them
            let replaceMode = false;
            if (scorecardData.players.length > 0) {
                const response = confirm(
                    `Found ${drawPlayers.length} player(s) in draw.\n` +
                    `Scorecard currently has ${scorecardData.players.length} player(s).\n\n` +
                    `Click OK to REPLACE all scorecard players with draw players.\n` +
                    `Click Cancel to ADD draw players (skip duplicates).`
                );
                replaceMode = response;
            }
            
            let addedCount = 0;
            let skippedCount = 0;
            
            // If replace mode, clear existing players first
            if (replaceMode) {
                scorecardData.players = [];
            }
            
            drawPlayers.forEach(drawPlayer => {
                // Check if player already exists in scorecard (only in add mode)
                if (!replaceMode) {
                    const exists = scorecardData.players.some(p => 
                        p.name.toLowerCase() === drawPlayer.name.toLowerCase()
                    );
                    
                    if (exists) {
                        skippedCount++;
                        return; // Skip duplicate
                    }
                }
                
                // Parse handicap from PGA Index or newIndex
                let handicap = 0;
                const indexValue = drawPlayer.newIndex || drawPlayer.pgaIndex;
                if (indexValue && indexValue !== 'N/A') {
                    handicap = parseFloat(indexValue) || 0;
                }
                
                console.log(`Retrieving player: ${drawPlayer.name}`);
                console.log(`  - newIndex: ${drawPlayer.newIndex}`);
                console.log(`  - pgaIndex: ${drawPlayer.pgaIndex}`);
                console.log(`  - whiteTees: ${drawPlayer.whiteTees}`);
                console.log(`  - yellowTees: ${drawPlayer.yellowTees}`);
                
                const newPlayer = {
                    id: nextScorecardPlayerId++,
                    name: drawPlayer.name,
                    handicap: handicap,
                    pgaIndex: (drawPlayer.newIndex !== undefined && drawPlayer.newIndex !== null && drawPlayer.newIndex !== '' && drawPlayer.newIndex !== 'N/A') ? drawPlayer.newIndex : ((drawPlayer.pgaIndex !== undefined && drawPlayer.pgaIndex !== null && drawPlayer.pgaIndex !== '' && drawPlayer.pgaIndex !== 'N/A') ? drawPlayer.pgaIndex : 'N/A'),
                    whiteTees: (drawPlayer.whiteTees !== undefined && drawPlayer.whiteTees !== null && drawPlayer.whiteTees !== '') ? drawPlayer.whiteTees : 'N/A',
                    yellowTees: (drawPlayer.yellowTees !== undefined && drawPlayer.yellowTees !== null && drawPlayer.yellowTees !== '') ? drawPlayer.yellowTees : 'N/A',
                    scores: Array(18).fill('')
                };
                
                console.log(`  -> Scorecard pgaIndex: ${newPlayer.pgaIndex}`);
                
                scorecardData.players.push(newPlayer);
                addedCount++;
            });
            
            // Save and re-render
            saveScorecardData();
            renderScorecard();
            
            // Show summary
            let message = `Retrieved ${addedCount} player(s) from draw.`;
            if (skippedCount > 0) {
                message += `\n${skippedCount} duplicate(s) skipped.`;
            }
            alert(message);
        }
        
        function exportScorecardCSV() {
            if (scorecardData.players.length === 0) {
                alert('No player data to export');
                return;
            }
            
            let csv = `Course: ${scorecardData.courseName},Date: ${scorecardData.date},Competition: ${scorecardData.competitionName}\n`;
            csv += "Player,Handicap," + Array.from({length: 18}, (_, i) => `Hole ${i+1}`).join(',') + ",Front 9,Back 9,Gross,Stableford,Countback 13-18\n";
            
            // Add PAR row
            csv += `PAR,-,${globalParValues.join(',')},${globalParValues.slice(0, 9).reduce((a, b) => a + b, 0)},${globalParValues.slice(9, 18).reduce((a, b) => a + b, 0)},${globalParValues.reduce((a, b) => a + b, 0)},${globalParValues.reduce((a, b) => a + b, 0) * 2},${globalParValues.slice(12, 18).reduce((a, b) => a + b, 0)}\n`;
            
            // Add INDEX row
            csv += `INDEX,-,${globalIndexValues.join(',')},-,-,-,-,-\n`;
            
            // Add player rows
            scorecardData.players.forEach(player => {
                const front9 = player.scores.slice(0, 9).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
                const back9 = player.scores.slice(9, 18).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
                const gross = front9 + back9;
                const countback = player.scores.slice(12, 18).reduce((sum, val) => sum + (parseInt(val) || 0), 0);
                
                // Calculate stableford
                let stableford = 0;
                for (let hole = 0; hole < 18; hole++) {
                    const score = parseInt(player.scores[hole]) || 0;
                    if (score > 0) {
                        const points = calculateStablefordForHole(scorecardData.players.indexOf(player), hole);
                        if (points !== null) {
                            stableford += points;
                        }
                    }
                }
                
                csv += `${player.name},${player.handicap || 0},${player.scores.map(s => s || '').join(',')},${front9},${back9},${gross},${stableford},${countback}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scorecard_${scorecardData.date || 'export'}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('scorecardCSVDropdown').classList.remove('show');
        }
        
        function importScorecardCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 4) {
                        alert('Invalid scorecard CSV format');
                        return;
                    }
                    
                    // Clear existing players
                    scorecardData.players = [];
                    nextScorecardPlayerId = 1;
                    
                    let importedCount = 0;
                    
                    // Parse each player row (skip header, PAR, and INDEX rows)
                    for (let i = 3; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim());
                        if (values.length < 20) continue;
                        
                        const playerName = values[0];
                        const handicap = parseFloat(values[1]) || 0;
                        const scores = values.slice(2, 20); // 18 holes
                        
                        const newPlayer = {
                            id: nextScorecardPlayerId++,
                            name: playerName,
                            handicap: handicap,
                            pgaIndex: handicap,
                            whiteTees: '',
                            yellowTees: '',
                            scores: scores.map(s => s || '')
                        };
                        
                        scorecardData.players.push(newPlayer);
                        importedCount++;
                    }
                    
                    if (importedCount > 0) {
                        saveScorecardData();
                        renderScorecard();
                        alert(`Successfully imported ${importedCount} player(s) to Week ${currentWeek}!`);
                    } else {
                        alert('No player data found in CSV file.');
                    }
                } catch (error) {
                    console.error('Scorecard import error:', error);
                    alert('Error importing scorecard CSV: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
            document.getElementById('scorecardCSVDropdown').classList.remove('show');
        }
        
        // ============================================
        // H'CAP CALCULATOR FUNCTIONS
        // ============================================
        
        function initializeCalculatorData() {
            calculatorData = [
                { name: "Chris Powell", pgaIndex: 8.2, newPgaIndex: 8.2, changeSinceLastRound: 0, whiteTeesHandicap: 10, yellowTeesHandicap: 8 },
                { name: "Darren Sunter", pgaIndex: 8.6, changeSinceLastRound: 0, whiteTeesHandicap: 10, yellowTeesHandicap: 8 },
                { name: "Craig Palmer", pgaIndex: 5.2, changeSinceLastRound: 0, whiteTeesHandicap: 6, yellowTeesHandicap: 5 },
                { name: "Daljit Basra", pgaIndex: 13.7, changeSinceLastRound: 0, whiteTeesHandicap: 16, yellowTeesHandicap: 14 },
                { name: "Dan Breeze", pgaIndex: 7.4, changeSinceLastRound: 0, whiteTeesHandicap: 9, yellowTeesHandicap: 7 },
                { name: "Daren Davey", pgaIndex: 6.8, changeSinceLastRound: 0.4, whiteTeesHandicap: 8, yellowTeesHandicap: 7 },
                { name: "David Park", pgaIndex: 6.3, changeSinceLastRound: 0.4, whiteTeesHandicap: 8, yellowTeesHandicap: 6 },
                { name: "David Quinlan", pgaIndex: 10.2, changeSinceLastRound: 0, whiteTeesHandicap: 12, yellowTeesHandicap: 10 },
                { name: "Duane Hayden", pgaIndex: 11.4, changeSinceLastRound: -1.1, whiteTeesHandicap: 13, yellowTeesHandicap: 12 },
                { name: "Gamma Basra", pgaIndex: 13.6, changeSinceLastRound: 0, whiteTeesHandicap: 16, yellowTeesHandicap: 14 },
                { name: "Ian Hamilton", pgaIndex: 12.9, changeSinceLastRound: 0, whiteTeesHandicap: 15, yellowTeesHandicap: 13 },
                { name: "James Andrews", pgaIndex: -1.1, changeSinceLastRound: 0, whiteTeesHandicap: -1, yellowTeesHandicap: -2 },
                { name: "James Ellis", pgaIndex: 5.6, changeSinceLastRound: 0, whiteTeesHandicap: 7, yellowTeesHandicap: 5 },
                { name: "Jamie Dixon", pgaIndex: 7.5, changeSinceLastRound: 0, whiteTeesHandicap: 9, yellowTeesHandicap: 7 },
                { name: "Jeet Sohal", pgaIndex: 13.3, changeSinceLastRound: 0, whiteTeesHandicap: 16, yellowTeesHandicap: 14 },
                { name: "Joe Ciampa", pgaIndex: 6.4, changeSinceLastRound: 0, whiteTeesHandicap: 8, yellowTeesHandicap: 6 },
                { name: "Johnathan Conlon", pgaIndex: 1.1, changeSinceLastRound: 0, whiteTeesHandicap: 2, yellowTeesHandicap: 0 },
                { name: "Josh Eaton", pgaIndex: 9.4, changeSinceLastRound: 0.5, whiteTeesHandicap: 11, yellowTeesHandicap: 9 },
                { name: "Josh Kinnear", pgaIndex: 2.4, changeSinceLastRound: 0, whiteTeesHandicap: 3, yellowTeesHandicap: 2 },
                { name: "Josh Roseberry", pgaIndex: 5.6, changeSinceLastRound: 0.4, whiteTeesHandicap: 7, yellowTeesHandicap: 5 },
                { name: "Julian Pennie", pgaIndex: 9, changeSinceLastRound: 0.5, whiteTeesHandicap: 11, yellowTeesHandicap: 9 },
                { name: "Kamal Dhunna", pgaIndex: 12.1, changeSinceLastRound: 0, whiteTeesHandicap: 14, yellowTeesHandicap: 12 },
                { name: "Mark Hickman", pgaIndex: 9.1, changeSinceLastRound: 0, whiteTeesHandicap: 11, yellowTeesHandicap: 9 },
                { name: "Mark Saunders", pgaIndex: 5.6, changeSinceLastRound: 0.4, whiteTeesHandicap: 7, yellowTeesHandicap: 5 },
                { name: "Michael Paeckmeyer", pgaIndex: 5.1, changeSinceLastRound: 0, whiteTeesHandicap: 6, yellowTeesHandicap: 5 },
                { name: "Nick Eaton", pgaIndex: -0.3, changeSinceLastRound: 0, whiteTeesHandicap: 0, yellowTeesHandicap: -1 },
                { name: "Paul Bentley", pgaIndex: 8.1, changeSinceLastRound: 0.5, whiteTeesHandicap: 10, yellowTeesHandicap: 8 },
                { name: "Peter Ramsden", pgaIndex: 13.2, changeSinceLastRound: 0, whiteTeesHandicap: 15, yellowTeesHandicap: 13 },
                { name: "Rich Moore", pgaIndex: 9.5, changeSinceLastRound: 0, whiteTeesHandicap: 11, yellowTeesHandicap: 9 },
                { name: "Ringo Theara", pgaIndex: 4.7, changeSinceLastRound: -0.5, whiteTeesHandicap: 6, yellowTeesHandicap: 4 },
                { name: "Robert Brown", pgaIndex: 11, changeSinceLastRound: 0, whiteTeesHandicap: 13, yellowTeesHandicap: 11 },
                { name: "Ryan Brown", pgaIndex: 6.6, changeSinceLastRound: 0, whiteTeesHandicap: 8, yellowTeesHandicap: 6 },
                { name: "Ryan Conlon", pgaIndex: -1.5, changeSinceLastRound: 0, whiteTeesHandicap: -1, yellowTeesHandicap: -3 },
                { name: "Sean Casey", pgaIndex: 8.2, changeSinceLastRound: 0, whiteTeesHandicap: 10, yellowTeesHandicap: 8 },
                { name: "Stephen De_Fraine", pgaIndex: 11.7, changeSinceLastRound: 0.6, whiteTeesHandicap: 14, yellowTeesHandicap: 12 },
                { name: "Steve Cornwell", pgaIndex: 7.2, changeSinceLastRound: 0, whiteTeesHandicap: 9, yellowTeesHandicap: 7 },
                { name: "Stuart Kinge", pgaIndex: 2.4, changeSinceLastRound: 0, whiteTeesHandicap: 3, yellowTeesHandicap: 2 },
                { name: "Tom McCarthy", pgaIndex: 10.4, changeSinceLastRound: 0, whiteTeesHandicap: 12, yellowTeesHandicap: 10 },
                { name: "Tony Chapman", pgaIndex: 7.9, changeSinceLastRound: -0.3, whiteTeesHandicap: 9, yellowTeesHandicap: 8 },
                { name: "Tony Semple", pgaIndex: 14.2, changeSinceLastRound: 0.6, whiteTeesHandicap: 17, yellowTeesHandicap: 15 }
            ];
        }
        
        function loadCalculatorData() {
            const saved = localStorage.getItem('calculatorData');
            if (saved) {
                calculatorData = JSON.parse(saved);
            } else {
                initializeCalculatorData();
            }
            
            // Ensure all players have newPgaIndex field (initialize to current pgaIndex if missing)
            calculatorData.forEach(player => {
                if (player.newPgaIndex === undefined || player.newPgaIndex === null) {
                    player.newPgaIndex = player.pgaIndex;
                }
            });
        }
        
        function saveCalculatorData() {
            localStorage.setItem('calculatorData', JSON.stringify(calculatorData));
        }
        
        function initializeCalculatorWeekSelector() {
            const selector = document.getElementById('calculatorWeekSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            for (let i = 1; i <= 25; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `WK${i}`;
                if (i === currentWeek) {
                    option.selected = true;
                }
                selector.appendChild(option);
            }
        }
        
        function changeCalculatorWeek() {
            const selector = document.getElementById('calculatorWeekSelector');
            currentWeek = parseInt(selector.value);
            renderCalculatorTable();
        }
        
        function toggleCalculatorSort() {
            calculatorSortDescending = !calculatorSortDescending;
            
            // Update sort indicator
            const indicator = document.getElementById('sort-indicator');
            if (indicator) {
                indicator.textContent = calculatorSortDescending ? '\u25bc' : '\u25b2';
            }
            
            renderCalculatorTable();
        }
        
        function toggleShowAllPlayers() {
            showAllCalculatorPlayers = !showAllCalculatorPlayers;
            
            // Update button text
            const buttonText = document.getElementById('show-all-text');
            if (buttonText) {
                buttonText.textContent = showAllCalculatorPlayers ? 'Show Scorecard Players' : 'Show All Players';
            }
            
            renderCalculatorTable();
        }
        
        function getCategory(pgaIndex) {
            const index = parseFloat(pgaIndex);
            if (index <= -0.1) return 1;
            if (index >= 0.0 && index <= 4.9) return 2;
            if (index >= 5.0 && index <= 9.9) return 3;
            if (index >= 10.0) return 4;
            return 4; // Default to Category 4 for any edge cases
        }
        
        function renderCalculatorTable() {
            const tbody = document.getElementById('calculator-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get current week's scorecard data (same as scorecard tab)
            const weekKey = `week${currentWeek || 1}`;
            const weekScorecardData = allWeeksScorecardData[weekKey];
            
            // Check if we have handicap data
            const hasHandicapData = handicapPlayerData && handicapPlayerData.length > 0;
            
            // Build array of players with their calculated data
            const playersWithScores = [];
            
            if (showAllCalculatorPlayers) {
                // Show all players from handicapPlayerData (Handicap tab extracted data)
                if (!hasHandicapData) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">No handicap data available. Please extract handicap data in the Handicap tab.</td></tr>';
                    return;
                }
                
                handicapPlayerData.forEach((handicapPlayer) => {
                    // Try to find matching scorecard player for this week
                    let stablefordTotal = 0;
                    let hasScorecard = false;
                    
                    if (weekScorecardData && weekScorecardData.players) {
                        const scorecardPlayer = weekScorecardData.players.find(sp => 
                            sp.name.toLowerCase().trim() === handicapPlayer.name.toLowerCase().trim()
                        );
                        
                        if (scorecardPlayer) {
                            hasScorecard = true;
                            // Calculate stableford score
                            for (let hole = 0; hole < 18; hole++) {
                                const score = parseInt(scorecardPlayer.scores[hole]) || 0;
                                if (score > 0) {
                                    const par = globalParValues[hole] || 4;
                                    const playerHandicap = (scorecardPlayer.whiteTees !== undefined && scorecardPlayer.whiteTees !== null && scorecardPlayer.whiteTees !== '') 
                                        ? parseFloat(scorecardPlayer.whiteTees) 
                                        : (parseFloat(scorecardPlayer.handicap) || 0);
                                    const holeIndex = globalIndexValues[hole] || (hole + 1);
                                    
                                    const strokesReceived = calculateStrokesForHole(playerHandicap, holeIndex);
                                    const adjustedPar = par + strokesReceived;
                                    const diff = score - adjustedPar;
                                    
                                    let points = 0;
                                    if (diff <= -2) points = 4;
                                    else if (diff === -1) points = 3;
                                    else if (diff === 0) points = 2;
                                    else if (diff === 1) points = 1;
                                    
                                    stablefordTotal += points;
                                }
                            }
                        }
                    }
                    
                    const pgaIndex = parseFloat(handicapPlayer.pgaIndex) || 0;
                    const category = getCategory(pgaIndex);
                    
                    // Get calculated newIndex from latest handicap calculations if available
                    let newIndex = pgaIndex;
                    let change = 0;
                    let whiteHandicap = parseInt(handicapPlayer.whiteTees) || 0;
                    let yellowHandicap = parseInt(handicapPlayer.yellowTees) || 0;
                    
                    if (window.latestHandicapCalculations && window.latestHandicapCalculations.has(handicapPlayer.name)) {
                        const calc = window.latestHandicapCalculations.get(handicapPlayer.name);
                        newIndex = calc.newIndex;
                        change = Math.round(calc.change * 10) / 10;  // Round to 1 decimal
                        
                        // Recalculate course handicaps from new index
                        whiteHandicap = Math.round((newIndex * golfCourses.White.slope / 113) + (golfCourses.White.rating - golfCourses.White.par));
                        yellowHandicap = Math.round((newIndex * golfCourses.Yellow.slope / 113) + (golfCourses.Yellow.rating - golfCourses.Yellow.par));
                    } else {
                        // If no calculation available and player didn't play, show 0 change
                        change = hasScorecard ? (parseFloat(handicapPlayer.changeSinceLastRound) || 0) : 0;
                    }
                    
                    playersWithScores.push({
                        name: handicapPlayer.name,
                        category: category,
                        stableford: hasScorecard ? stablefordTotal : '-',
                        pgaIndex: pgaIndex,
                        newPgaIndex: newIndex,  // Shows calculated new index from report
                        changeSinceLastRound: change,
                        whiteTeesHandicap: whiteHandicap,
                        yellowTeesHandicap: yellowHandicap,
                        calcPlayerIndex: -1 // No editing when using handicap data directly
                    });
                });
            } else {
                // Show only players in current week's scorecard
                if (!weekScorecardData || !weekScorecardData.players || weekScorecardData.players.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 20px; color: #666;">No players in scorecard for this week. Add players in the Scorecard tab.</td></tr>';
                    return;
                }
                
                weekScorecardData.players.forEach((scorecardPlayer, playerIndex) => {
                // Find matching player data from handicapPlayerData (Handicap tab)
                const handicapPlayer = hasHandicapData ? handicapPlayerData.find(hp => 
                    hp.name.toLowerCase().trim() === scorecardPlayer.name.toLowerCase().trim()
                ) : null;
                
                // Use handicap data if found, otherwise show N/A
                const pgaIndex = handicapPlayer ? (parseFloat(handicapPlayer.pgaIndex) || 0) : 'N/A';
                const changeSinceLastRound = handicapPlayer ? (parseFloat(handicapPlayer.changeSinceLastRound) || 0) : 'N/A';
                const whiteTeesHandicap = handicapPlayer ? (parseInt(handicapPlayer.whiteTees) || 0) : 'N/A';
                const yellowTeesHandicap = handicapPlayer ? (parseInt(handicapPlayer.yellowTees) || 0) : 'N/A';
                
                const category = getCategory(pgaIndex);
                
                // Calculate stableford score
                let stablefordTotal = 0;
                for (let hole = 0; hole < 18; hole++) {
                    const score = parseInt(scorecardPlayer.scores[hole]) || 0;
                    if (score > 0) {
                        const par = globalParValues[hole] || 4;
                        const playerHandicap = (scorecardPlayer.whiteTees !== undefined && scorecardPlayer.whiteTees !== null && scorecardPlayer.whiteTees !== '') 
                            ? parseFloat(scorecardPlayer.whiteTees) 
                            : (parseFloat(scorecardPlayer.handicap) || 0);
                        const holeIndex = globalIndexValues[hole] || (hole + 1);
                        
                        const strokesReceived = calculateStrokesForHole(playerHandicap, holeIndex);
                        const adjustedPar = par + strokesReceived;
                        const diff = score - adjustedPar;
                        
                        let points = 0;
                        if (diff <= -2) points = 4;
                        else if (diff === -1) points = 3;
                        else if (diff === 0) points = 2;
                        else if (diff === 1) points = 1;
                        
                        stablefordTotal += points;
                    }
                }
                
                const newPgaIndex = pgaIndex;
                const calcPlayerIndex = -1; // No editing when using handicap data
                
                playersWithScores.push({
                    name: scorecardPlayer.name,
                    category: category,
                    stableford: stablefordTotal,
                    pgaIndex: pgaIndex,
                    newPgaIndex: newPgaIndex,
                    changeSinceLastRound: changeSinceLastRound,
                    whiteTeesHandicap: whiteTeesHandicap,
                    yellowTeesHandicap: yellowTeesHandicap,
                    calcPlayerIndex: calcPlayerIndex
                });
            });
            }
            
            // Sort by stableford score (handle '-' as no score)
            playersWithScores.sort((a, b) => {
                const aScore = a.stableford === '-' ? -999 : a.stableford;
                const bScore = b.stableford === '-' ? -999 : b.stableford;
                
                if (calculatorSortDescending) {
                    return bScore - aScore; // Highest to lowest (players with '-' go to bottom)
                } else {
                    // For ascending, put '-' at bottom still
                    if (aScore === -999 && bScore === -999) return 0;
                    if (aScore === -999) return 1;
                    if (bScore === -999) return -1;
                    return aScore - bScore; // Lowest to highest
                }
            });
            
            // Render sorted players
            playersWithScores.forEach((player, index) => {
                const row = document.createElement('tr');
                const isEditable = player.calcPlayerIndex >= 0;
                const newPgaIndexHTML = isEditable 
                    ? `<input type="number" step="0.1" value="${player.newPgaIndex}" data-calc-index="${player.calcPlayerIndex}" style="width: 60px; text-align: center;" onchange="updateNewPgaIndex(${player.calcPlayerIndex}, this.value)">`
                    : player.newPgaIndex;
                
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td style="font-weight: 700; color: #1a6b4f;" id="cat-${index}">${player.category}</td>
                    <td style="font-weight: 700; color: #e67e22; text-align: center;">${player.stableford}</td>
                    <td>${player.pgaIndex}</td>
                    <td style="text-align: center;">${newPgaIndexHTML}</td>
                    <td>${player.changeSinceLastRound}</td>
                    <td>${player.whiteTeesHandicap}</td>
                    <td>${player.yellowTeesHandicap}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateNewPgaIndex(calcPlayerIndex, value) {
            if (calcPlayerIndex >= 0 && calcPlayerIndex < calculatorData.length) {
                calculatorData[calcPlayerIndex].newPgaIndex = parseFloat(value) || 0;
                saveCalculatorData();
            }
        }
        
        // ============================================
        // WINNERS TAB FUNCTIONS
        // ============================================
        
        function initializeWinnersWeekSelector() {
            const selector = document.getElementById('winnersWeekSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            for (let i = 1; i <= 25; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `WK${i}`;
                if (i === currentWinnersWeek) {
                    option.selected = true;
                }
                selector.appendChild(option);
            }
        }
        
        function changeWinnersWeek() {
            const selector = document.getElementById('winnersWeekSelector');
            currentWinnersWeek = parseInt(selector.value);
            localStorage.setItem('currentWinnersWeek', currentWinnersWeek.toString());
            renderWinnersTable();
            // Auto-update Profit & Loss when week changes
            calculateProfitLoss();
        }
        
        function getPositionSymbol(position) {
            if (position === 1) return 'ü•á';
            if (position === 2) return 'ü•à';
            if (position === 3) return 'ü•â';
            if (position === 4) return 'üèÜ';
            return position;
        }
        
        // Prize matrix - based on number of players, returns [1st, 2nd, 3rd, 4th, 5th]
        function getPrizesForPlayerCount(playerCount) {
            const prizeMatrix = {
                2: [6, 4, 0, 0, 0],
                3: [9, 6, 0, 0, 0],
                4: [12, 8, 0, 0, 0],
                5: [15, 10, 0, 0, 0],
                6: [18, 12, 0, 0, 0],
                7: [21, 14, 0, 0, 0],
                8: [24, 16, 0, 0, 0],
                9: [27, 18, 0, 0, 0],
                10: [25, 15, 10, 0, 0],
                11: [28, 17, 10, 0, 0],
                12: [30, 18, 12, 0, 0],
                13: [33, 20, 12, 0, 0],
                14: [35, 21, 14, 0, 0],
                15: [38, 23, 14, 0, 0],
                16: [40, 24, 16, 0, 0],
                17: [43, 26, 16, 0, 0],
                18: [45, 27, 18, 0, 0],
                19: [43, 26, 16, 10, 0],
                20: [45, 27, 17, 11, 0],
                21: [47, 28, 18, 12, 0],
                22: [50, 30, 19, 11, 0],
                23: [52, 31, 20, 12, 0],
                24: [54, 32, 20, 14, 0],
                25: [56, 34, 21, 14, 0],
                26: [59, 35, 22, 14, 0],
                27: [61, 36, 23, 15, 0],
                28: [59, 35, 22, 15, 9],
                29: [61, 36, 22, 15, 11],
                30: [63, 38, 23, 16, 10],
                31: [65, 39, 24, 16, 11],
                32: [67, 40, 25, 17, 11],
                33: [69, 41, 26, 17, 12],
                34: [71, 43, 26, 18, 12],
                35: [74, 44, 27, 18, 12],
                36: [76, 45, 28, 19, 12],
                37: [78, 46, 29, 19, 13],
                38: [80, 48, 29, 20, 13],
                39: [82, 49, 30, 20, 14],
                40: [84, 50, 31, 21, 14],
                41: [85, 51, 32, 22, 15],
                42: [86, 52, 33, 23, 16],
                43: [87, 53, 34, 24, 17],
                44: [88, 54, 35, 25, 18],
                45: [89, 55, 36, 26, 19],
                46: [90, 56, 37, 27, 20],
                47: [91, 57, 38, 28, 21],
                48: [92, 58, 39, 29, 22],
                49: [93, 59, 40, 30, 23],
                50: [94, 60, 41, 31, 24]
            };
            
            return prizeMatrix[playerCount] || [0, 0, 0, 0, 0];
        }
        
        // Countback calculation function
        function calculateCountback(player, handicap) {
            const stablefordPoints = [];
            
            // Calculate Stableford points for each hole
            for (let hole = 0; hole < 18; hole++) {
                const score = parseInt(player.scores[hole]) || 0;
                let points = 0;
                
                if (score > 0) {
                    const par = globalParValues[hole] || 4;
                    const holeIndex = globalIndexValues[hole] || (hole + 1);
                    const strokesReceived = calculateStrokesForHole(handicap, holeIndex);
                    const adjustedPar = par + strokesReceived;
                    const diff = score - adjustedPar;
                    
                    if (diff <= -2) points = 4;
                    else if (diff === -1) points = 3;
                    else if (diff === 0) points = 2;
                    else if (diff === 1) points = 1;
                }
                
                stablefordPoints.push(points);
            }
            
            // Countback order based on specification:
            // 1. Back 9 (holes 9-17, indices 9-17)
            // 2. Last 6 of back 9 (holes 13-18, indices 12-17)
            // 3. Last 3 of back 9 (holes 10-12, indices 9-11)
            // 4. Last 2 of back 9 (holes 11-12, indices 10-11)
            // 5. Last 1 of back 9 (hole 10, index 9)
            // 6. Front 9 (holes 1-9, indices 0-8)
            // 7. Last 6 of front 9 (holes 4-9, indices 3-8)
            // 8. Last 3 of front 9 (holes 1-3, indices 0-2)
            // 9. Last 2 of front 9 (holes 2-3, indices 1-2)
            // 10. Last 1 of front 9 (hole 1, index 0)
            
            const back9 = stablefordPoints.slice(9, 18).reduce((a, b) => a + b, 0);
            const back6 = stablefordPoints.slice(12, 18).reduce((a, b) => a + b, 0); // Holes 13-18
            const back3 = stablefordPoints.slice(15, 18).reduce((a, b) => a + b, 0); // Holes 16,17,18
            const back2 = stablefordPoints.slice(16, 18).reduce((a, b) => a + b, 0); // Holes 17,18
            const back1 = stablefordPoints[17]; // Hole 18
            
            const front9 = stablefordPoints.slice(0, 9).reduce((a, b) => a + b, 0);
            const front6 = stablefordPoints.slice(3, 9).reduce((a, b) => a + b, 0); // Holes 4-9
            const front3 = stablefordPoints.slice(6, 9).reduce((a, b) => a + b, 0); // Holes 7,8,9
            const front2 = stablefordPoints.slice(7, 9).reduce((a, b) => a + b, 0); // Holes 8,9
            const front1 = stablefordPoints[8]; // Hole 9
            
            return {
                back9,
                back6,
                back3,
                back2,
                back1,
                front9,
                front6,
                front3,
                front2,
                front1
            };
        }
        
        // Compare two players using countback rules
        function comparePlayersCountback(playerA, playerB) {
            // First compare by total Stableford score
            if (playerB.stableford !== playerA.stableford) {
                return playerB.stableford - playerA.stableford;
            }
            
            // If tied, apply countback rules in order
            const cb = playerA.countback;
            const cbB = playerB.countback;
            
            if (cb.back9 !== cbB.back9) return cbB.back9 - cb.back9;
            if (cb.back6 !== cbB.back6) return cbB.back6 - cb.back6;
            if (cb.back3 !== cbB.back3) return cbB.back3 - cb.back3;
            if (cb.back2 !== cbB.back2) return cbB.back2 - cb.back2;
            if (cb.back1 !== cbB.back1) return cbB.back1 - cb.back1;
            if (cb.front9 !== cbB.front9) return cbB.front9 - cb.front9;
            if (cb.front6 !== cbB.front6) return cbB.front6 - cb.front6;
            if (cb.front3 !== cbB.front3) return cbB.front3 - cb.front3;
            if (cb.front2 !== cbB.front2) return cbB.front2 - cb.front2;
            if (cb.front1 !== cbB.front1) return cbB.front1 - cb.front1;
            
            return 0; // Still tied after all countback
        }
        
        function importHandicapToWinners() {
            // Get scorecard data for the current winners week
            const weekKey = `week${currentWinnersWeek}`;
            const weekScorecardData = allWeeksScorecardData[weekKey];
            
            if (!weekScorecardData || !weekScorecardData.players || weekScorecardData.players.length === 0) {
                alert(`No players found in Scorecard for Week ${currentWinnersWeek}.\n\nPlease add players to the Scorecard tab for this week first.`);
                return;
            }
            
            const playersData = [];
            
            // Calculate stableford and countback for each player
            const playersWithScores = weekScorecardData.players.map(player => {
                let stablefordTotal = 0;
                const playerHandicap = (player.whiteTees !== undefined && player.whiteTees !== null && player.whiteTees !== '') 
                    ? parseFloat(player.whiteTees) 
                    : (parseFloat(player.handicap) || 0);
                
                // Calculate total stableford score
                for (let hole = 0; hole < 18; hole++) {
                    const score = parseInt(player.scores[hole]) || 0;
                    if (score > 0) {
                        const par = globalParValues[hole] || 4;
                        const holeIndex = globalIndexValues[hole] || (hole + 1);
                        
                        const strokesReceived = calculateStrokesForHole(playerHandicap, holeIndex);
                        const adjustedPar = par + strokesReceived;
                        const diff = score - adjustedPar;
                        
                        let points = 0;
                        if (diff <= -2) points = 4;
                        else if (diff === -1) points = 3;
                        else if (diff === 0) points = 2;
                        else if (diff === 1) points = 1;
                        
                        stablefordTotal += points;
                    }
                }
                
                // Calculate countback values
                const countback = calculateCountback(player, playerHandicap);
                
                return {
                    name: player.name,
                    stableford: stablefordTotal,
                    countback: countback
                };
            });
            
            // Sort by stableford score with countback tiebreaker (same 11-level logic as Scorecard)
            playersWithScores.sort((a, b) => {
                const cb = a.countback;
                const cbB = b.countback;
                
                // 1. Total Stableford
                if (a.stableford !== b.stableford) return b.stableford - a.stableford;
                // 2. Back 9 (holes 10-18)
                if (cb.back9 !== cbB.back9) return cbB.back9 - cb.back9;
                // 3. Holes 13-18
                if (cb.back6 !== cbB.back6) return cbB.back6 - cb.back6;
                // 4. Holes 10-12
                if (cb.back3 !== cbB.back3) return cbB.back3 - cb.back3;
                // 5. Holes 11-12
                if (cb.back2 !== cbB.back2) return cbB.back2 - cb.back2;
                // 6. Hole 10
                if (cb.back1 !== cbB.back1) return cbB.back1 - cb.back1;
                // 7. Front 9 (holes 1-9)
                if (cb.front9 !== cbB.front9) return cbB.front9 - cb.front9;
                // 8. Holes 4-9
                if (cb.front6 !== cbB.front6) return cbB.front6 - cb.front6;
                // 9. Holes 1-3
                if (cb.front3 !== cbB.front3) return cbB.front3 - cb.front3;
                // 10. Holes 2-3
                if (cb.front2 !== cbB.front2) return cbB.front2 - cb.front2;
                // 11. Hole 1
                return cbB.front1 - cb.front1;
            });
            
            // Get prizes based on player count
            const playerCount = playersWithScores.length;
            const prizes = getPrizesForPlayerCount(playerCount);
            
            // Create winners data with sorted players and auto-filled prizes
            playersWithScores.forEach((player, index) => {
                // index 0 = 1st place (prizes[0]), index 1 = 2nd place (prizes[1]), etc.
                const prizeAmount = prizes[index] || 0;
                const cb = player.countback;
                playersData.push({
                    name: player.name,
                    stableford: player.stableford,
                    prize: prizeAmount > 0 ? `¬£${prizeAmount}` : '¬£0',
                    back9: cb.back9,
                    back6: cb.back6,
                    back3: cb.back3,
                    back2: cb.back2,
                    back1: cb.back1,
                    front9: cb.front9,
                    front6: cb.front6,
                    front3: cb.front3,
                    front2: cb.front2,
                    front1: cb.front1
                });
            });
            
            if (playersData.length === 0) {
                alert('No player data found to import.');
                return;
            }
            
            // Save to winners data
            allWeeksWinnersData[weekKey] = playersData;
            saveWinnersData();
            renderWinnersTable();
            // Auto-update Profit & Loss after import
            calculateProfitLoss();
            
            alert(`Imported ${playersData.length} players from Scorecard Week ${currentWinnersWeek}.\n\nPlayers are sorted by Stableford score (highest to lowest).`);
        }
        
        function renderWinnersTable() {
            const tbody = document.getElementById('winners-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const weekKey = `week${currentWinnersWeek}`;
            const weekWinners = allWeeksWinnersData[weekKey] || [];
            
            if (weekWinners.length === 0) {
                tbody.innerHTML = '<tr><td colspan="13" style="text-align: center; padding: 20px; color: #666;">No data for this week. Import from Handicap tab to get started.</td></tr>';
                return;
            }
            
            weekWinners.forEach((player, index) => {
                const position = index + 1;
                const positionDisplay = getPositionSymbol(position);
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                if (index % 2 === 1) {
                    row.style.backgroundColor = '#f9f9f9';
                }
                
                row.innerHTML = `
                    <td style="text-align: center; font-size: 20px; padding: 10px;">${positionDisplay}</td>
                    <td style="text-align: left; font-weight: 600; padding: 10px; color: #333; font-size: 10px;">${player.name || ''}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.stableford || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.front9 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.front6 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.front3 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.front2 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.front1 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.back9 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.back6 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.back3 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.back2 || 0}</td>
                    <td style="text-align: center; padding: 5px; font-size: 10px;">${player.back1 || 0}</td>
                    <td style="text-align: center; padding: 10px;"><input type="text" value="${player.prize || '¬£0'}" data-index="${index}" style="width: 100px; text-align: center; font-weight: 600; font-size: 10px; padding: 4px;" onchange="updateWinnerPrize(${index}, this.value)"></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function updateWinnerPrize(index, value) {
            const weekKey = `week${currentWinnersWeek}`;
            if (!allWeeksWinnersData[weekKey]) return;
            
            // Ensure value starts with ¬£
            let prizeValue = value.trim();
            if (!prizeValue.startsWith('¬£')) {
                prizeValue = '¬£' + prizeValue.replace(/[^0-9]/g, '');
            }
            
            allWeeksWinnersData[weekKey][index].prize = prizeValue;
            saveWinnersData();
            // Auto-update Profit & Loss when prize changes
            calculateProfitLoss();
        }
        
        function clearWinnersWeek() {
            if (!confirm(`Clear all winner data for Week ${currentWinnersWeek}?`)) return;
            
            const weekKey = `week${currentWinnersWeek}`;
            delete allWeeksWinnersData[weekKey];
            saveWinnersData();
            renderWinnersTable();
            // Auto-update Profit & Loss when week is cleared
            calculateProfitLoss();
        }
        
        function clearAllWinnersData() {
            if (!confirm('WARNING: This will delete ALL winners data for ALL weeks!\n\nAre you sure?')) return;
            
            allWeeksWinnersData = {};
            saveWinnersData();
            renderWinnersTable();
            // Auto-update Profit & Loss when all data is cleared
            calculateProfitLoss();
            alert('All winners data cleared successfully!');
        }
        
        function saveWinnersData() {
            localStorage.setItem('allWeeksWinnersData', JSON.stringify(allWeeksWinnersData));
        }
        
        function loadWinnersData() {
            const saved = localStorage.getItem('allWeeksWinnersData');
            if (saved) {
                allWeeksWinnersData = JSON.parse(saved);
            }
            // Load last selected week
            const savedWeek = localStorage.getItem('currentWinnersWeek');
            if (savedWeek) {
                currentWinnersWeek = parseInt(savedWeek);
            }
        }
        
        // ============================================
        // PROFIT & LOSS FUNCTIONS
        // ============================================
        
        function showProfitLoss() {
            // Legacy function - P&L section is now always visible
            calculateProfitLoss();
            // Scroll to the P&L section
            document.getElementById('profit-loss-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        function hideProfitLoss() {
            // Legacy function - no longer used (P&L section is always visible)
        }
        
        function calculateProfitLoss() {
            const playerStats = {};
            
            // Loop through all weeks and all players
            Object.keys(allWeeksWinnersData).forEach(weekKey => {
                const weekPlayers = allWeeksWinnersData[weekKey] || [];
                
                weekPlayers.forEach(player => {
                    const name = player.name;
                    if (!name) return;
                    
                    // Initialize player if not exists
                    if (!playerStats[name]) {
                        playerStats[name] = {
                            weeksPlayed: 0,
                            totalProfit: 0
                        };
                    }
                    
                    // Increment weeks played (each week = ¬£5 loss)
                    playerStats[name].weeksPlayed++;
                    
                    // Parse prize amount and add to profit
                    const prizeStr = player.prize || '¬£0';
                    const prizeAmount = parseFloat(prizeStr.replace('¬£', '')) || 0;
                    playerStats[name].totalProfit += prizeAmount;
                });
            });
            
            // Convert to array and calculate net P&L
            const playersArray = Object.keys(playerStats).map(name => {
                const stats = playerStats[name];
                const totalLoss = stats.weeksPlayed * 5;
                const netPL = stats.totalProfit - totalLoss;
                
                return {
                    name: name,
                    weeksPlayed: stats.weeksPlayed,
                    totalLoss: totalLoss,
                    totalProfit: stats.totalProfit,
                    netPL: netPL
                };
            });
            
            // Sort by net P&L (highest to lowest)
            playersArray.sort((a, b) => b.netPL - a.netPL);
            
            // Render table
            renderProfitLossTable(playersArray);
        }
        
        function renderProfitLossTable(playersArray) {
            const tbody = document.getElementById('profit-loss-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (playersArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #666;">No data available. Import players in Winners section first.</td></tr>';
                return;
            }
            
            playersArray.forEach((player, index) => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #eee';
                if (index % 2 === 1) {
                    row.style.backgroundColor = '#f9f9f9';
                }
                
                // Color code the net P&L
                const netPLColor = player.netPL > 0 ? '#27ae60' : player.netPL < 0 ? '#e74c3c' : '#666';
                const netPLPrefix = player.netPL > 0 ? '+' : '';
                
                row.innerHTML = `
                    <td style="text-align: left; padding: 10px; font-weight: 600; font-size: 10px;">${player.name}</td>
                    <td style="text-align: center; padding: 10px; font-size: 10px;">${player.weeksPlayed}</td>
                    <td style="text-align: center; padding: 10px; font-size: 10px; color: #e74c3c;">¬£${player.totalLoss}</td>
                    <td style="text-align: center; padding: 10px; font-size: 10px; color: #27ae60;">¬£${player.totalProfit}</td>
                    <td style="text-align: center; padding: 10px; font-size: 11px; font-weight: 700; color: ${netPLColor};">${netPLPrefix}¬£${player.netPL}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function downloadProfitLossCSV() {
            const playerStats = {};
            
            // Calculate stats (same as calculateProfitLoss)
            Object.keys(allWeeksWinnersData).forEach(weekKey => {
                const weekPlayers = allWeeksWinnersData[weekKey] || [];
                
                weekPlayers.forEach(player => {
                    const name = player.name;
                    if (!name) return;
                    
                    if (!playerStats[name]) {
                        playerStats[name] = {
                            weeksPlayed: 0,
                            totalProfit: 0
                        };
                    }
                    
                    playerStats[name].weeksPlayed++;
                    
                    const prizeStr = player.prize || '¬£0';
                    const prizeAmount = parseFloat(prizeStr.replace('¬£', '')) || 0;
                    playerStats[name].totalProfit += prizeAmount;
                });
            });
            
            // Convert to array
            const playersArray = Object.keys(playerStats).map(name => {
                const stats = playerStats[name];
                const totalLoss = stats.weeksPlayed * 5;
                const netPL = stats.totalProfit - totalLoss;
                
                return {
                    name: name,
                    weeksPlayed: stats.weeksPlayed,
                    totalLoss: totalLoss,
                    totalProfit: stats.totalProfit,
                    netPL: netPL
                };
            });
            
            // Sort by net P&L
            playersArray.sort((a, b) => b.netPL - a.netPL);
            
            // Create CSV
            let csv = 'Player Name,Weeks Played,Total Loss,Total Profit,Net P&L\n';
            playersArray.forEach(player => {
                csv += `${player.name},${player.weeksPlayed},${player.totalLoss},${player.totalProfit},${player.netPL}\n`;
            });
            
            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 10);
            a.download = `Profit_Loss_${timestamp}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        function captureScorecardImage() {
            if (typeof html2canvas === 'undefined') {
                alert('Image capture not available');
                return;
            }
            
            if (!scorecardData.players || scorecardData.players.length === 0) {
                alert('No players in scorecard to capture');
                return;
            }
            
            // Create temporary container
            const tempDiv = document.createElement('div');
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.backgroundColor = '#ffffff';
            tempDiv.style.padding = '20px';
            tempDiv.style.width = 'auto';
            tempDiv.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            document.body.appendChild(tempDiv);
            
            // Get course info
            const courseName = document.getElementById('courseName').value || 'Default Course';
            const date = document.getElementById('scorecardDate').value || new Date().toLocaleDateString();
            const competition = document.getElementById('competitionName').value || '';
            const weekNum = currentWeek || 1;
            
            // Add title
            const title = document.createElement('h2');
            title.textContent = `Scorecard - Week ${weekNum}`;
            title.style.textAlign = 'center';
            title.style.marginBottom = '8px';
            title.style.color = '#1a6b4f';
            title.style.fontSize = '16px';
            tempDiv.appendChild(title);
            
            // Add course info
            const infoDiv = document.createElement('div');
            infoDiv.style.textAlign = 'center';
            infoDiv.style.fontSize = '10px';
            infoDiv.style.marginBottom = '12px';
            infoDiv.style.color = '#666';
            infoDiv.innerHTML = `<strong>Course:</strong> ${courseName} | <strong>Date:</strong> ${date}${competition ? ` | <strong>Competition:</strong> ${competition}` : ''}`;
            tempDiv.appendChild(infoDiv);
            
            // Clone and style the scorecard table
            const originalTable = document.getElementById('scorecard-table');
            const tableClone = originalTable.cloneNode(true);
            
            // Remove sticky positioning
            tableClone.style.position = 'static';
            tableClone.style.width = 'auto';
            tableClone.style.tableLayout = 'auto';
            tableClone.style.fontSize = '8px';
            
            // Fix header styles
            const headerCells = tableClone.querySelectorAll('thead th');
            headerCells.forEach(th => {
                th.style.position = 'static';
                th.style.backgroundColor = '#1a6b4f';
                th.style.color = 'white';
                th.style.padding = '4px 2px';
                th.style.fontSize = '7px';
                th.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                th.style.textAlign = 'center';
                th.style.whiteSpace = 'nowrap';
            });
            
            // Fix body cells
            const bodyCells = tableClone.querySelectorAll('tbody td');
            bodyCells.forEach(td => {
                td.style.position = 'static';
                td.style.padding = '3px 2px';
                td.style.fontSize = '7px';
                td.style.border = '1px solid #eee';
                td.style.textAlign = 'center';
            });
            
            // Replace inputs with their values
            const inputs = tableClone.querySelectorAll('input');
            inputs.forEach(input => {
                const span = document.createElement('span');
                span.textContent = input.value || '';
                span.className = input.className;
                span.style.display = 'block';
                span.style.fontSize = '7px';
                span.style.textAlign = 'center';
                input.parentNode.replaceChild(span, input);
            });
            
            // Remove delete buttons
            const deleteButtons = tableClone.querySelectorAll('.scorecard-delete-btn');
            deleteButtons.forEach(btn => btn.remove());
            
            // Add table to temp div
            const tableWrapper = document.createElement('div');
            tableWrapper.style.overflowX = 'visible';
            tableWrapper.style.width = 'auto';
            tableWrapper.appendChild(tableClone);
            tempDiv.appendChild(tableWrapper);
            
            // Add footer with player count
            const footer = document.createElement('div');
            footer.textContent = `Total Players: ${scorecardData.players.length}`;
            footer.style.textAlign = 'center';
            footer.style.fontSize = '9px';
            footer.style.marginTop = '10px';
            footer.style.color = '#666';
            tempDiv.appendChild(footer);
            
            // Capture the image
            html2canvas(tempDiv, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                scrollX: 0,
                scrollY: 0,
                windowWidth: tempDiv.scrollWidth + 40,
                windowHeight: tempDiv.scrollHeight + 40
            }).then(canvas => {
                document.body.removeChild(tempDiv);
                
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                link.download = `Scorecard_Week${weekNum}_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                document.body.removeChild(tempDiv);
                console.error('Capture error:', error);
                alert('Error capturing scorecard: ' + error.message);
            });
        }
        
        // ============================================
        // STATS TAB FUNCTIONS
        // ============================================
        
        function refreshStats() {
            const tbody = document.getElementById('stats-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Gather all player data
            const playerStatsMap = {};
            
            // Get league data
            playerData.forEach((player, index) => {
                const name = player.name;
                if (!playerStatsMap[name]) {
                    playerStatsMap[name] = {
                        name: name,
                        roundsPlayed: player.pld || 0,
                        leagueScores: player.weekScores.filter(s => s && parseInt(s) > 0).map(s => parseInt(s)),
                        totalWins: 0,
                        totalWon: 0,
                        totalLost: 0,
                        leaguePosition: index + 1,
                        currentIndex: 0
                    };
                }
            });
            
            // Get winners/profit-loss data
            Object.keys(allWeeksWinnersData).forEach(weekKey => {
                const weekPlayers = allWeeksWinnersData[weekKey] || [];
                weekPlayers.forEach((player, position) => {
                    const name = player.name;
                    if (!name) return;
                    
                    if (!playerStatsMap[name]) {
                        playerStatsMap[name] = {
                            name: name,
                            roundsPlayed: 0,
                            leagueScores: [],
                            totalWins: 0,
                            totalWon: 0,
                            totalLost: 0,
                            leaguePosition: '-',
                            currentIndex: 0
                        };
                    }
                    
                    // Count as played
                    if (!playerStatsMap[name].weeksInWinners) playerStatsMap[name].weeksInWinners = [];
                    playerStatsMap[name].weeksInWinners.push(weekKey);
                    
                    // Parse prize
                    const prizeStr = player.prize || '¬£0';
                    const prizeAmount = parseFloat(prizeStr.replace('¬£', '')) || 0;
                    
                    if (prizeAmount > 0) {
                        playerStatsMap[name].totalWins++;
                        playerStatsMap[name].totalWon += prizeAmount;
                    }
                });
            });
            
            // Get current indexes from handicap data
            if (handicapPlayerData && handicapPlayerData.length > 0) {
                handicapPlayerData.forEach(hp => {
                    if (playerStatsMap[hp.name]) {
                        playerStatsMap[hp.name].currentIndex = parseFloat(hp.newIndex) || parseFloat(hp.pgaIndex) || 0;
                    }
                });
            }
            
            // Calculate totals
            const playersArray = Object.values(playerStatsMap).map(stats => {
                // Calculate rounds from winners data
                const winnersRounds = stats.weeksInWinners ? stats.weeksInWinners.length : 0;
                const actualRounds = Math.max(stats.roundsPlayed, winnersRounds);
                
                stats.totalLost = actualRounds * 5;
                const netPL = stats.totalWon - stats.totalLost;
                
                // Calculate average, best, worst from league scores
                let avgStableford = 0;
                let bestScore = 0;
                let worstScore = 0;
                
                if (stats.leagueScores.length > 0) {
                    const sum = stats.leagueScores.reduce((a, b) => a + b, 0);
                    avgStableford = (sum / stats.leagueScores.length).toFixed(1);
                    bestScore = Math.max(...stats.leagueScores);
                    worstScore = Math.min(...stats.leagueScores);
                }
                
                return {
                    name: stats.name,
                    roundsPlayed: actualRounds,
                    avgStableford: avgStableford || '-',
                    bestScore: bestScore || '-',
                    worstScore: worstScore || '-',
                    totalWins: stats.totalWins,
                    totalWon: stats.totalWon.toFixed(0),
                    totalLost: stats.totalLost.toFixed(0),
                    netPL: netPL.toFixed(0),
                    netPLNum: netPL,
                    currentIndex: stats.currentIndex ? stats.currentIndex.toFixed(1) : '-',
                    leaguePosition: stats.leaguePosition
                };
            });
            
            // Sort by rounds played (descending)
            playersArray.sort((a, b) => b.roundsPlayed - a.roundsPlayed);
            
            // Render rows
            playersArray.forEach((player, index) => {
                const row = document.createElement('tr');
                if (index % 2 === 1) row.style.backgroundColor = '#f9f9f9';
                
                // Color for P/L
                let plColor = '#333';
                if (player.netPLNum > 0) plColor = '#2e7d32';
                else if (player.netPLNum < 0) plColor = '#d32f2f';
                
                row.innerHTML = `
                    <td style="padding: 6px 8px; border-bottom: 1px solid #eee; font-weight: 600;">${player.name}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee;">${player.roundsPlayed}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee;">${player.avgStableford}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee; font-weight: 600; color: #2e7d32;">${player.bestScore}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee; font-weight: 600; color: #d32f2f;">${player.worstScore}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee;">${player.totalWins}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee;">¬£${player.totalWon}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee;">¬£${player.totalLost}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee; font-weight: 700; color: ${plColor};">¬£${player.netPL}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee;">${player.currentIndex}</td>
                    <td style="padding: 6px 4px; text-align: center; border-bottom: 1px solid #eee; font-weight: 600;">${player.leaguePosition}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (playersArray.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" style="text-align: center; padding: 20px; color: #666;">No statistics available. Add player data in League, Scorecard, or Winners tabs.</td></tr>';
            }
        }
        
        // ============================================
        // SEASON MANAGEMENT FUNCTIONS
        // ============================================
        
        let seasonData = {
            season: 'winter',
            startDate: '',
            endDate: ''
        };
        
        function saveSeasonData() {
            localStorage.setItem('seasonData', JSON.stringify(seasonData));
        }
        
        function loadSeasonData() {
            const saved = localStorage.getItem('seasonData');
            if (saved) {
                seasonData = JSON.parse(saved);
                document.getElementById('season-selector').value = seasonData.season || 'winter';
                document.getElementById('season-start-date').value = seasonData.startDate || '';
                document.getElementById('season-end-date').value = seasonData.endDate || '';
            }
        }
        
        // ============================================
        // EXISTING FUNCTIONS (LEAGUE AND HANDICAP)
        // ============================================
        
        function identifyTopScoresForPlayer(player) {
            const scoresWithWeeks = player.weekScores.map((score, weekIndex) => ({
                score: parseInt(score) || 0,
                weekIndex: weekIndex,
                isTopScore: false
            }));
            
            const validScores = scoresWithWeeks.filter(item => item.score > 0);
            validScores.sort((a, b) => b.score - a.score);
            
            const topCount = Math.min(bestCount, validScores.length);
            for (let i = 0; i < topCount; i++) {
                validScores[i].isTopScore = true;
            }
            
            const topScoreWeeks = Array(totalWeeks).fill(false);
            validScores.forEach(item => {
                if (item.isTopScore) {
                    topScoreWeeks[item.weekIndex] = true;
                }
            });
            
            return topScoreWeeks;
        }
        
        function toggleBestScoresDropdown() {
            document.getElementById('bestScoresDropdown').classList.toggle('show');
        }
        
        function changeBestCount(count) {
            bestCount = count;
            document.getElementById('best-count-display').textContent = count;
            // Update both the key and old footer reference
            const keyElement = document.getElementById('highlight-count-key');
            if (keyElement) keyElement.textContent = count;
            
            document.querySelectorAll('.best-scores-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const selectedOption = Array.from(document.querySelectorAll('.best-scores-option'))
                .find(option => option.textContent === `Best ${count}`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
            
            calculateAllTotals();
            updateAllTopScoreHighlighting();
            document.getElementById('bestScoresDropdown').classList.remove('show');
            saveBestCountSetting();
        }
        
        function updateAllTopScoreHighlighting() {
            playerData.forEach((player, playerIndex) => {
                updateTopScoreHighlighting(playerIndex);
            });
        }
        
        function saveBestCountSetting() {
            localStorage.setItem('bestCount', bestCount);
        }
        
        function loadBestCountSetting() {
            const saved = localStorage.getItem('bestCount');
            if (saved) {
                bestCount = parseInt(saved);
                document.getElementById('best-count-display').textContent = bestCount;
                // Update the color key count
                const keyElement = document.getElementById('highlight-count-key');
                if (keyElement) keyElement.textContent = bestCount;
                
                document.querySelectorAll('.best-scores-option').forEach(option => {
                    option.classList.remove('active');
                    if (option.textContent === `Best ${bestCount}`) {
                        option.classList.add('active');
                    }
                });
            }
        }
        
        function loadLeagueData() {
            const saved = localStorage.getItem('pgaLeagueData');
            if (saved) {
                const data = JSON.parse(saved);
                if (data.totalWeeks) {
                    totalWeeks = data.totalWeeks;
                }
                return data.players || null;
            }
            return null;
        }
        
        function saveLeagueData() {
            const data = {
                players: playerData,
                totalWeeks: totalWeeks,
                bestCount: bestCount
            };
            localStorage.setItem('pgaLeagueData', JSON.stringify(data));
            document.getElementById('player-count').textContent = playerData.length;
            document.getElementById('week-count').textContent = totalWeeks;
        }
        
        function generatePlayerData() {
            const savedData = loadLeagueData();
            if (savedData) {
                nextPlayerId = Math.max(...savedData.map(p => p.id)) + 1;
                return savedData;
            }
            
            // Sort players alphabetically by name
            const sortedPlayers = [...leaguePlayers].sort((a, b) => 
                a.name.localeCompare(b.name)
            );
            
            return sortedPlayers.map(player => ({
                ...player,
                weekScores: Array(totalWeeks).fill(''),
                pld: 0,
                totalPoints: 0,
                bestPoints: 0
            }));
        }
        
        function calculatePlayerTotalsLeague(player) {
            const validScores = player.weekScores
                .map(score => score.trim() === '' ? 0 : parseInt(score) || 0)
                .filter(score => score > 0);
            
            player.pld = validScores.length;
            player.totalPoints = validScores.reduce((sum, score) => sum + score, 0);
            
            const sortedScores = [...validScores].sort((a, b) => b - a);
            player.bestPoints = sortedScores.slice(0, bestCount).reduce((sum, score) => sum + score, 0);
            
            return player;
        }
        
        function calculateAllTotals() {
            playerData.forEach(player => calculatePlayerTotalsLeague(player));
            
            playerData.sort((a, b) => {
                if (b.bestPoints !== a.bestPoints) return b.bestPoints - a.bestPoints;
                return b.totalPoints - a.totalPoints;
            });
            
            renderLeagueTable();
            saveLeagueData();
        }
        
        function sortByBestPoints() {
            // Sort by best points (highest first), then by total points
            playerData.sort((a, b) => {
                if (b.bestPoints !== a.bestPoints) return b.bestPoints - a.bestPoints;
                return b.totalPoints - a.totalPoints;
            });
            
            renderLeagueTable();
            saveLeagueData();
        }
        
        function sortByPlayerName() {
            // Sort alphabetically by player name
            playerData.sort((a, b) => a.name.localeCompare(b.name));
            
            renderLeagueTable();
            saveLeagueData();
        }
        
        function sortByWeek(weekIndex) {
            // Sort by specific week score (highest to lowest)
            playerData.sort((a, b) => {
                const scoreA = parseInt(a.weekScores[weekIndex]) || 0;
                const scoreB = parseInt(b.weekScores[weekIndex]) || 0;
                
                // Sort by week score (highest first)
                if (scoreB !== scoreA) return scoreB - scoreA;
                
                // If same score, sort by best points as tiebreaker
                if (b.bestPoints !== a.bestPoints) return b.bestPoints - a.bestPoints;
                
                // If still same, sort by total points
                return b.totalPoints - a.totalPoints;
            });
            
            renderLeagueTable();
            saveLeagueData();
        }
        
        function renderLeagueTable() {
            const header = document.getElementById('standings-header');
            const body = document.getElementById('standings-body');
            
            header.innerHTML = '';
            body.innerHTML = '';
            
            const screenWidth = window.innerWidth;
            const isMobile = screenWidth <= 768;
            const weekColWidth = isMobile ? '20px' : '22px';
            
            let headerHTML = `
                <tr>
                    <th>No</th>
                    <th onclick="sortByPlayerName()" style="cursor: pointer; user-select: none;" title="Click to sort alphabetically">Player ‚ñ≤</th>
            `;
            
            for (let i = 0; i < totalWeeks; i++) {
                headerHTML += `<th class="wk-header" onclick="sortByWeek(${i})" style="min-width: ${weekColWidth}; width: ${weekColWidth}; cursor: pointer; user-select: none;" title="Click to sort by Week ${i+1}">WK${i+1}</th>`;
            }
            
            headerHTML += `
                    <th class="total-header">PLD</th>
                    <th class="total-header" onclick="sortByBestPoints()" style="cursor: pointer; user-select: none;" title="Click to sort by highest">B${bestCount} ‚ñº</th>
                    <th class="total-header">TOT</th>
                    <th>Action</th>
                </tr>
            `;
            
            header.innerHTML = headerHTML;
            
            playerData.forEach((player, index) => {
                const topScoreWeeks = identifyTopScoresForPlayer(player);
                
                const row = document.createElement('tr');
                row.dataset.playerId = player.id;
                
                let rowHTML = `
                    <td>${index + 1}</td>
                    <td><input type="text" value="${player.name}" class="player-name-edit" data-player-index="${index}" style="width: 110px; border: 1px solid #ddd; padding: 2px 4px; font-size: 10px;" title="${player.name}"></td>
                `;
                
                for (let weekIndex = 0; weekIndex < totalWeeks; weekIndex++) {
                    const score = player.weekScores[weekIndex] || '';
                    const isLowScore = parseInt(score) > 0 && parseInt(score) <= 29;
                    const isTopScore = topScoreWeeks[weekIndex];
                    const lowScoreClass = isLowScore ? 'low-score' : '';
                    const topScoreClass = isTopScore ? 'top-score' : '';
                    
                    rowHTML += `
                        <td><input type="text" value="${score}" class="${lowScoreClass} ${topScoreClass}" data-p="${index}" data-w="${weekIndex}" maxlength="2"></td>
                    `;
                }
                
                rowHTML += `
                    <td class="total-cell">${player.pld}</td>
                    <td class="total-cell">${player.bestPoints}</td>
                    <td class="total-cell">${player.totalPoints}</td>
                    <td><button class="delete-btn" onclick="removeLeaguePlayer(${player.id})"><i class="fas fa-trash"></i></button></td>
                `;
                
                row.innerHTML = rowHTML;
                body.appendChild(row);
            });
            
            // Handle week score inputs
            document.querySelectorAll('#standings-body input:not(.player-name-edit)').forEach(input => {
                input.addEventListener('input', function(e) {
                    this.value = this.value.replace(/[^0-9]/g, '');
                    const pIndex = parseInt(this.dataset.p);
                    const wIndex = parseInt(this.dataset.w);
                    
                    playerData[pIndex].weekScores[wIndex] = this.value;
                    calculatePlayerTotalsLeague(playerData[pIndex]);
                    updatePlayerRow(pIndex);
                    saveLeagueData();
                    
                    const score = parseInt(this.value) || 0;
                    if (score > 0 && score <= 29) {
                        this.classList.add('low-score');
                    } else {
                        this.classList.remove('low-score');
                    }
                    
                    updateTopScoreHighlighting(pIndex);
                });
                
                // Add Enter key navigation for league table
                input.addEventListener('keydown', handleLeagueKeyNavigation);
            });
            
            // Handle player name inputs
            document.querySelectorAll('.player-name-edit').forEach(input => {
                input.addEventListener('change', function(e) {
                    const pIndex = parseInt(this.dataset.playerIndex);
                    const newName = this.value.trim();
                    if (newName) {
                        playerData[pIndex].name = newName;
                        saveLeagueData();
                        console.log(`Updated player name to: ${newName}`);
                    } else {
                        // Restore original name if empty
                        this.value = playerData[pIndex].name;
                    }
                });
            });
            
            document.getElementById('player-count').textContent = playerData.length;
            document.getElementById('week-count').textContent = totalWeeks;
            adjustTableWidth();
        }
        
        function updateTopScoreHighlighting(playerIndex) {
            const player = playerData[playerIndex];
            const topScoreWeeks = identifyTopScoresForPlayer(player);
            const row = document.querySelector(`tr[data-player-id="${player.id}"]`);
            
            if (row) {
                for (let weekIndex = 0; weekIndex < totalWeeks; weekIndex++) {
                    const cell = row.cells[2 + weekIndex];
                    if (cell && cell.querySelector('input')) {
                        const input = cell.querySelector('input');
                        if (topScoreWeeks[weekIndex]) {
                            input.classList.add('top-score');
                        } else {
                            input.classList.remove('top-score');
                        }
                    }
                }
            }
        }
        
        function adjustTableWidth() {
            const table = document.getElementById('standings-table');
            const container = table.parentElement;
            const screenWidth = window.innerWidth;
            
            const fixedColumnsWidth = 30 + 100 + 30 + 30 + 30 + 40;
            const weekColumnsWidth = totalWeeks * (screenWidth <= 768 ? 20 : 22);
            const totalWidth = fixedColumnsWidth + weekColumnsWidth;
            
            if (totalWidth > container.clientWidth) {
                table.style.width = totalWidth + 'px';
            } else {
                table.style.width = '100%';
            }
        }
        
        function updatePlayerRow(playerIndex) {
            const player = playerData[playerIndex];
            const row = document.querySelector(`tr[data-player-id="${player.id}"]`);
            if (row) {
                row.cells[2 + totalWeeks].textContent = player.pld;
                row.cells[3 + totalWeeks].textContent = player.bestPoints;
                row.cells[4 + totalWeeks].textContent = player.totalPoints;
            }
        }
        
        function addLeaguePlayer() {
            const name = prompt("Enter player name:");
            if (!name || name.trim() === '') return;
            
            if (playerData.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Player already exists');
                return;
            }
            
            const newPlayer = {
                id: nextPlayerId++,
                name: name.trim(),
                weekScores: Array(totalWeeks).fill(''),
                pld: 0,
                totalPoints: 0,
                bestPoints: 0
            };
            
            playerData.push(newPlayer);
            calculateAllTotals();
        }
        
        function adjustTotalWeeks() {
            const newWeeks = prompt(`Enter total number of weeks (current: ${totalWeeks}):`, totalWeeks);
            if (!newWeeks || isNaN(newWeeks) || newWeeks < 1 || newWeeks > 52) {
                alert('Please enter a valid number between 1 and 52');
                return;
            }
            
            const newTotal = parseInt(newWeeks);
            
            playerData.forEach(player => {
                if (player.weekScores.length < newTotal) {
                    while (player.weekScores.length < newTotal) {
                        player.weekScores.push('');
                    }
                } else if (player.weekScores.length > newTotal) {
                    player.weekScores = player.weekScores.slice(0, newTotal);
                }
            });
            
            totalWeeks = newTotal;
            calculateAllTotals();
            saveLeagueData();
        }
        
        function removeLeaguePlayer(playerId) {
            if (confirm('Remove player?')) {
                const index = playerData.findIndex(p => p.id === playerId);
                if (index !== -1) {
                    playerData.splice(index, 1);
                    calculateAllTotals();
                }
            }
        }
        
        // ============================================
        // CSV DROPDOWN TOGGLE FUNCTIONS
        // ============================================
        
        function toggleLeagueCSVDropdown() {
            document.getElementById('leagueCSVDropdown').classList.toggle('show');
        }
        
        function toggleScorecardCSVDropdown() {
            document.getElementById('scorecardCSVDropdown').classList.toggle('show');
        }
        
        function toggleBatchCSVDropdown() {
            document.getElementById('batchCSVDropdown').classList.toggle('show');
        }
        
        function exportLeagueCSV() {
            let csv = "POS,Player Name," + Array.from({length: totalWeeks}, (_, i) => `WK${i+1}`).join(',') + ",PLD,B" + bestCount + ",Total\n";
            
            playerData.forEach((player, index) => {
                const row = [
                    index + 1,
                    `"${player.name}"`,
                    ...player.weekScores.map(score => score || ''),
                    player.pld,
                    player.bestPoints,
                    player.totalPoints
                ];
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'pga_league.csv';
            a.click();
            URL.revokeObjectURL(url);
            document.getElementById('leagueCSVDropdown').classList.remove('show');
        }
        
        function importLeagueCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        alert('Invalid CSV file format');
                        return;
                    }
                    
                    // Parse header to determine week columns
                    const headers = lines[0].split(',').map(h => h.trim());
                    let importedCount = 0;
                    
                    // Process each data row
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                        if (values.length < 2) continue;
                        
                        const playerName = values[1]; // Column 2 is player name
                        
                        // Find matching player in playerData
                        const player = playerData.find(p => p.name.toLowerCase().trim() === playerName.toLowerCase().trim());
                        if (player) {
                            // Import week scores (starting from column 2)
                            for (let weekIdx = 0; weekIdx < totalWeeks && (weekIdx + 2) < values.length; weekIdx++) {
                                const score = values[weekIdx + 2];
                                if (score && score !== '') {
                                    player.weekScores[weekIdx] = score;
                                }
                            }
                            importedCount++;
                        }
                    }
                    
                    if (importedCount > 0) {
                        calculateAllTotals();
                        saveLeagueData();
                        alert(`Successfully imported data for ${importedCount} player(s)!`);
                    } else {
                        alert('No matching players found in CSV file.');
                    }
                } catch (error) {
                    console.error('Import error:', error);
                    alert('Error importing CSV file: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
            document.getElementById('leagueCSVDropdown').classList.remove('show');
        }
        
        function captureLeagueTable() {
            if (typeof html2canvas === 'undefined') {
                alert('Image capture not available');
                return;
            }
            
            const standingsTable = document.getElementById('standings-table');
            
            if (!standingsTable || playerData.length === 0) {
                alert('No league data to capture');
                return;
            }
            
            // Create a temporary container for the capture
            const tempDiv = document.createElement('div');
            tempDiv.style.padding = '20px';
            tempDiv.style.backgroundColor = '#ffffff';
            tempDiv.style.position = 'absolute';
            tempDiv.style.left = '-9999px';
            tempDiv.style.top = '0';
            tempDiv.style.width = 'auto';
            tempDiv.style.maxWidth = 'none';
            document.body.appendChild(tempDiv);
            
            // Clone the table
            const tableClone = standingsTable.cloneNode(true);
            
            // Remove sticky positioning and set proper widths for capture
            tableClone.style.position = 'static';
            tableClone.style.width = 'auto';
            tableClone.style.tableLayout = 'auto';
            
            // Fix header cells - remove sticky and set proper styles
            const headerCells = tableClone.querySelectorAll('thead th');
            headerCells.forEach((th, index) => {
                th.style.position = 'static';
                th.style.backgroundColor = '#1a6b4f';
                th.style.color = 'white';
                th.style.padding = '6px 4px';
                th.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                th.style.fontWeight = '700';
                th.style.fontSize = '8px';
                th.style.textAlign = 'center';
                th.style.whiteSpace = 'nowrap';
                
                // First column (No)
                if (index === 0) {
                    th.style.width = '35px';
                    th.style.minWidth = '35px';
                }
                // Second column (Player)
                else if (index === 1) {
                    th.style.width = '120px';
                    th.style.minWidth = '120px';
                    th.style.textAlign = 'left';
                    th.style.paddingLeft = '6px';
                }
            });
            
            // Fix body cells - remove sticky and set proper styles
            const bodyRows = tableClone.querySelectorAll('tbody tr');
            bodyRows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td');
                cells.forEach((td, cellIndex) => {
                    td.style.position = 'static';
                    td.style.padding = '4px';
                    td.style.textAlign = 'center';
                    td.style.border = '1px solid #eee';
                    td.style.fontSize = '9px';
                    td.style.color = '#333';
                    
                    // First column (No) - ranking number
                    if (cellIndex === 0) {
                        td.style.backgroundColor = '#1a6b4f';
                        td.style.color = 'white';
                        td.style.fontWeight = '700';
                        td.style.width = '35px';
                        td.style.minWidth = '35px';
                    }
                    // Second column (Player name)
                    else if (cellIndex === 1) {
                        td.style.backgroundColor = 'white';
                        td.style.fontWeight = '600';
                        td.style.color = '#0a3d2e';
                        td.style.textAlign = 'left';
                        td.style.paddingLeft = '6px';
                        td.style.width = '120px';
                        td.style.minWidth = '120px';
                    }
                });
            });
            
            // Replace inputs with their values for cleaner capture
            const inputs = tableClone.querySelectorAll('input');
            inputs.forEach(input => {
                const span = document.createElement('span');
                span.textContent = input.value || '';
                span.className = input.className;
                span.style.display = 'block';
                span.style.width = '100%';
                span.style.textAlign = 'center';
                span.style.padding = '2px';
                span.style.fontSize = '9px';
                span.style.color = '#333';
                input.parentNode.replaceChild(span, input);
            });
            
            // Add zebra striping
            const rows = tableClone.querySelectorAll('tbody tr');
            rows.forEach((row, index) => {
                if (index % 2 === 1) {
                    const cells = row.querySelectorAll('td');
                    cells.forEach((cell, cellIndex) => {
                        // Don't change first column (No) background
                        if (cellIndex !== 0) {
                            if (!cell.style.backgroundColor || cell.style.backgroundColor === 'white') {
                                cell.style.backgroundColor = '#f9f9f9';
                            }
                        }
                    });
                }
            });
            
            // Add title
            const title = document.createElement('h2');
            title.textContent = 'PGA League Standings';
            title.style.textAlign = 'center';
            title.style.marginBottom = '10px';
            title.style.color = '#1a6b4f';
            title.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            tempDiv.appendChild(title);
            
            // Add date
            const dateDiv = document.createElement('div');
            dateDiv.textContent = `Generated: ${new Date().toLocaleString()}`;
            dateDiv.style.textAlign = 'center';
            dateDiv.style.fontSize = '10px';
            dateDiv.style.marginBottom = '15px';
            dateDiv.style.color = '#666';
            tempDiv.appendChild(dateDiv);
            
            // Add table wrapper
            const tableWrapper = document.createElement('div');
            tableWrapper.style.overflowX = 'visible';
            tableWrapper.style.width = 'auto';
            tableWrapper.appendChild(tableClone);
            tempDiv.appendChild(tableWrapper);
            
            // Capture the image
            html2canvas(tempDiv, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true,
                allowTaint: true,
                scrollX: 0,
                scrollY: 0,
                windowWidth: tempDiv.scrollWidth + 40,
                windowHeight: tempDiv.scrollHeight + 40
            }).then(canvas => {
                // Remove temp div
                document.body.removeChild(tempDiv);
                
                // Download the image
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                link.download = `PGA_League_Standings_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                document.body.removeChild(tempDiv);
                console.error('Capture error:', error);
                alert('Error capturing image: ' + error.message);
            });
        }
        
        function resetLeagueData() {
            if (confirm('Reset all scores?')) {
                localStorage.removeItem('pgaLeagueData');
                playerData = generatePlayerData();
                calculateAllTotals();
            }
        }
        
        function importScorecardScores() {
            // Load scorecard data
            loadScorecardData();
            
            // Check if currentWeek is valid
            if (!currentWeek || currentWeek < 1 || currentWeek > totalWeeks) {
                alert(`Invalid week number. Please select a week between 1 and ${totalWeeks} in the Scorecard tab.`);
                return;
            }
            
            // Get scorecard data for current week (data is stored as "week1", "week2", etc.)
            const weekKey = `week${currentWeek}`;
            const weekData = allWeeksScorecardData[weekKey];
            
            console.log(`Looking for scorecard data for ${weekKey}`);
            console.log('Available weeks:', Object.keys(allWeeksScorecardData));
            console.log('Week data:', weekData);
            
            if (!weekData || !weekData.players || weekData.players.length === 0) {
                alert(`No scorecard data found for Week ${currentWeek}. Please add players and scores in the Scorecard tab first.`);
                return;
            }
            
            let importedCount = 0;
            let notFoundCount = 0;
            const notFoundPlayers = [];
            
            // Loop through scorecard players
            console.log(`Total scorecard players: ${weekData.players.length}`);
            weekData.players.forEach((scorecardPlayer, index) => {
                console.log(`Processing player ${index + 1}: ${scorecardPlayer.name}`);
                // Calculate stableford total for this player
                let stablefordTotal = 0;
                
                for (let hole = 0; hole < 18; hole++) {
                    const score = parseInt(scorecardPlayer.scores[hole]) || 0;
                    if (score > 0) {
                        const par = globalParValues[hole] || 4;
                        const playerHandicap = (scorecardPlayer.whiteTees !== undefined && scorecardPlayer.whiteTees !== null && scorecardPlayer.whiteTees !== '') 
                            ? parseFloat(scorecardPlayer.whiteTees) 
                            : (parseFloat(scorecardPlayer.handicap) || 0);
                        const holeIndex = globalIndexValues[hole] || (hole + 1);
                        
                        // Calculate strokes received on this hole (same as scorecard)
                        const strokesReceived = calculateStrokesForHole(playerHandicap, holeIndex);
                        
                        // Adjust par for handicap
                        const adjustedPar = par + strokesReceived;
                        
                        // Calculate stableford points (same as scorecard)
                        const diff = score - adjustedPar;
                        let points = 0;
                        
                        if (diff <= -2) points = 4;      // Eagle or better (2+ under adjusted par)
                        else if (diff === -1) points = 3; // Birdie (1 under adjusted par)
                        else if (diff === 0) points = 2;  // Par (on adjusted par)
                        else if (diff === 1) points = 1;  // Bogey (1 over adjusted par)
                        // diff >= 2: 0 points (double bogey or worse)
                        
                        stablefordTotal += points;
                    }
                }
                
                // Find matching player in league by name
                const leaguePlayer = playerData.find(p => 
                    p.name.toLowerCase().trim() === scorecardPlayer.name.toLowerCase().trim()
                );
                
                if (leaguePlayer) {
                    console.log(`  ‚úì Found in league: ${leaguePlayer.name} (Stableford: ${stablefordTotal})`);
                    // Set the score for the current week (currentWeek - 1 because array is 0-indexed)
                    leaguePlayer.weekScores[currentWeek - 1] = stablefordTotal.toString();
                    importedCount++;
                } else {
                    console.log(`  ‚úó NOT found in league: "${scorecardPlayer.name}"`);
                    notFoundCount++;
                    notFoundPlayers.push(scorecardPlayer.name);
                }
            });
            
            // Recalculate totals WITHOUT sorting
            playerData.forEach(player => calculatePlayerTotalsLeague(player));
            
            // Save and re-render without sorting
            renderLeagueTable();
            saveLeagueData();
            
            // Show summary
            let message = `Imported ${importedCount} player score(s) from Scorecard Week ${currentWeek} to League Week ${currentWeek}.`;
            if (notFoundCount > 0) {
                message += `\n\n${notFoundCount} player(s) not found in league:\n${notFoundPlayers.join(', ')}`;
            }
            alert(message);
        }
        
        function extractData() {
            if (!uploadedFiles.length) {
                alert('Select files first');
                return;
            }
            
            const tableBody = document.querySelector('#extractedTable tbody');
            tableBody.innerHTML = '';
            handicapPlayerData = [];
            
            uploadedFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const text = e.target.result;
                    const lines = text.split('\n');
                    
                    lines.forEach((line, lineIndex) => {
                        line = line.trim();
                        if (!line) return;
                        
                        // Skip header line (contains "Player Name" or "No,Player")
                        if (line.includes('Player Name') || line.includes('No,Player')) return;
                        
                        // Check if this is CSV format (from HCAP Batch Calculator)
                        if (line.includes(',')) {
                            // Parse CSV line
                            const columns = line.split(',');
                            if (columns.length < 12) return;
                            
                            // Extract columns:
                            // 0: No, 1: Player Name, 2: Players Index, 3: Index Category, 4: Prize Money Won,
                            // 5: Stableford Points Scored, 6: Swindle Finishing Position, 7: Players Previous Index,
                            // 8: Total Adjustment, 9: Players New Index, 10: Course Handicap (White), 11: Course Handicap (Yellow)
                            let name = columns[1].replace(/"/g, '').trim();
                            if (!name) return;
                            
                            const playersNewIndex = columns[9].trim();
                            const totalAdjustment = columns[8].trim();
                            const playersPreviousIndex = columns[7].trim();
                            const whiteHandicap = columns[10].trim();
                            const yellowHandicap = columns[11].trim();
                            
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="swindle-editable not-paid" onclick="editPayment(this)" data-name="${name}">¬£0</td>
                                <td>${name}</td>
                                <td>${playersNewIndex}</td>
                                <td>${totalAdjustment}</td>
                                <td>${playersPreviousIndex}</td>
                                <td>${whiteHandicap}</td>
                                <td>${yellowHandicap}</td>
                            `;
                            tableBody.appendChild(tr);
                            
                            handicapPlayerData.push({
                                name: name,
                                newIndex: playersNewIndex,
                                totalAdjustment: totalAdjustment,
                                previousIndex: playersPreviousIndex,
                                whiteTees: whiteHandicap,
                                yellowTees: yellowHandicap,
                                paid: '¬£0'
                            });
                        } else {
                            // Original text format parsing (for backwards compatibility)
                            if (line.includes('PGA') || line.includes('Name') || line.includes('Tees')) return;
                            
                            // Match name followed by numbers (space-separated)
                            const parts = line.split(/\s{2,}/);
                            if (parts.length < 2) return;
                            
                            let name = parts[0].trim();
                            if (!name || !/^[A-Z]/.test(name)) return;
                            
                            if (document.getElementById('removeQuotes').checked) {
                                name = name.replace(/"([^"]*)"/g, '$1');
                            }
                            if (document.getElementById('removeDefaultNames').checked && /Golfer\s+\d+/i.test(name)) {
                                return;
                            }
                            
                            // Extract all numbers from the rest of the line
                            const numbers = line.substring(name.length).match(/-?\d+\.?\d*/g);
                            if (!numbers || numbers.length < 5) return;
                            
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td class="swindle-editable not-paid" onclick="editPayment(this)" data-name="${name}">¬£0</td>
                                <td>${name}</td>
                                <td>${numbers[0]}</td>
                                <td>${numbers[1]}</td>
                                <td>${numbers[2]}</td>
                                <td>${numbers[3]}</td>
                                <td>${numbers[4]}</td>
                            `;
                            tableBody.appendChild(tr);
                            
                            handicapPlayerData.push({
                                name: name,
                                newIndex: numbers[0],
                                totalAdjustment: numbers[1],
                                previousIndex: numbers[2],
                                whiteTees: numbers[3],
                                yellowTees: numbers[4],
                                paid: '¬£0'
                            });
                        }
                    });
                    
                    updatePaymentStats();
                    saveHandicapData();
                };
                reader.readAsText(file);
            });
        }
        
        function syncHandicapToCalculator() {
            // Check if there's handicap data available
            if (!handicapPlayerData || handicapPlayerData.length === 0) {
                alert('No handicap data available. Please extract handicap data first in the Handicap tab.');
                return;
            }
            
            // Run the same calculation logic as generateBatchHandicapReport()
            const week = currentWeek || 1;
            const weekKey = `week${week}`;
            const weekData = allWeeksScorecardData[weekKey];
            
            // Create calculation map
            window.latestHandicapCalculations = new Map();
            
            // If there's scorecard data, calculate for players who played
            if (weekData && weekData.players && weekData.players.length > 0) {
                weekData.players.forEach(player => {
                    const playerName = player.name;
                    const pgaIndex = parseFloat(player.pgaIndex) || 0;
                    const handicap = parseFloat(player.whiteTees) || parseFloat(player.handicap) || 0;
                    const prizeMoney = parseFloat(player.prizeMoney) || 0;
                    
                    // Calculate Stableford score
                    let stablefordTotal = 0;
                    for (let hole = 0; hole < 18; hole++) {
                        const score = parseInt(player.scores[hole]) || 0;
                        if (score > 0) {
                            const par = globalParValues[hole] || 4;
                            const holeIndex = globalIndexValues[hole] || (hole + 1);
                            const strokesReceived = calculateStrokesForHole(handicap, holeIndex);
                            const adjustedPar = par + strokesReceived;
                            const diff = score - adjustedPar;
                            
                            let points = 0;
                            if (diff <= -2) points = 4;
                            else if (diff === -1) points = 3;
                            else if (diff === 0) points = 2;
                            else if (diff === 1) points = 1;
                            
                            stablefordTotal += points;
                        }
                    }
                    
                    // Calculate category
                    const category = calculateGolfIndexCategory(pgaIndex);
                    const finishingPosition = prizeMoney > 0 ? 1 : 4;
                    
                    // Calculate adjustments
                    let stage1 = 0;
                    if (prizeMoney > 0 && stablefordTotal > golfParams.winThreshold) {
                        const baseCut = golfParams.cutBase + (category / golfParams.cutCatDivisor) + (pgaIndex * golfParams.cutIndexPercent);
                        stage1 = -(baseCut / finishingPosition);
                    }
                    
                    let stage2 = 0;
                    if (prizeMoney === 0 && stablefordTotal < golfParams.noWinThreshold && category > 0) {
                        stage2 = (pgaIndex * golfParams.incIndexPercent) + golfParams.incAddValue + (category / golfParams.incCatDivisor);
                    }
                    
                    let stage3 = 0;
                    if (stablefordTotal > golfParams.exceptionalThreshold) {
                        const pointsOver = stablefordTotal - golfParams.exceptionalThreshold;
                        stage3 = -((category / golfParams.excCatDivisor) + (pgaIndex * golfParams.excIndexPercent)) * pointsOver;
                    }
                    
                    const totalAdjustment = stage1 + stage2 + stage3;
                    let newIndex = pgaIndex + totalAdjustment;
                    if (newIndex > golfParams.maxIndex) {
                        newIndex = golfParams.maxIndex;
                    }
                    newIndex = Math.round(newIndex * 10) / 10;
                    
                    window.latestHandicapCalculations.set(playerName, {
                        newIndex: newIndex,
                        change: newIndex - pgaIndex
                    });
                });
            }
            
            // For all league players not in scorecard, set 0 change
            leaguePlayers.forEach(lp => {
                if (!window.latestHandicapCalculations.has(lp.name)) {
                    // Find current handicap
                    let currentIndex = 0;
                    if (handicapPlayerData && handicapPlayerData.length > 0) {
                        const handicapInfo = handicapPlayerData.find(hp => 
                            hp.name.toLowerCase().trim() === lp.name.toLowerCase().trim()
                        );
                        if (handicapInfo) {
                            currentIndex = parseFloat(handicapInfo.pgaIndex) || 0;
                        }
                    }
                    window.latestHandicapCalculations.set(lp.name, {
                        newIndex: currentIndex,
                        change: 0
                    });
                }
            });
            
            // Refresh the calculator table to show latest handicap data
            renderCalculatorTable();
            
            // Show success message
            alert(`H'CAP Calculator refreshed!\n\nShowing calculated handicaps for Week ${week}.`);
        }
        
        function editPayment(element) {
            const current = element.textContent;
            const playerName = element.dataset.name;
            const input = document.createElement('input');
            input.value = current;
            input.style.width = '100%';
            input.style.padding = '1px 2px';
            input.style.fontSize = '9px';
            input.style.color = '#000000';
            input.style.backgroundColor = '#ffffff';
            input.style.border = '1px solid #4a90e2';
            input.style.textAlign = 'center';
            
            element.innerHTML = '';
            element.appendChild(input);
            input.focus();
            input.select();
            
            const finish = () => {
                let value = input.value.trim();
                if (!value.startsWith('¬£')) value = '¬£' + value.replace(/[^0-9.]/g, '');
                if (value === '¬£') value = '¬£0';
                
                element.textContent = value;
                element.className = `swindle-editable ${value !== '¬£0' ? 'paid' : 'not-paid'}`;
                element.onclick = () => editPayment(element);
                
                if (playerName) {
                    const playerIndex = handicapPlayerData.findIndex(p => p.name === playerName);
                    if (playerIndex !== -1) {
                        handicapPlayerData[playerIndex].paid = value;
                    }
                }
                
                updatePaymentStats();
                saveHandicapData();
            };
            
            input.addEventListener('blur', finish);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') finish();
                if (e.key === 'Escape') {
                    element.textContent = current;
                    element.className = `swindle-editable ${current !== '¬£0' ? 'paid' : 'not-paid'}`;
                    element.onclick = () => editPayment(element);
                }
            });
        }
        
        function setAllToFive() {
            document.querySelectorAll('#extractedTable .swindle-editable').forEach(cell => {
                const playerName = cell.dataset.name;
                cell.textContent = '¬£5';
                cell.className = 'swindle-editable paid';
                
                if (playerName) {
                    const playerIndex = handicapPlayerData.findIndex(p => p.name === playerName);
                    if (playerIndex !== -1) {
                        handicapPlayerData[playerIndex].paid = '¬£5';
                    }
                }
            });
            updatePaymentStats();
            saveHandicapData();
        }
        
        function setAllToZero() {
            document.querySelectorAll('#extractedTable .swindle-editable').forEach(cell => {
                const playerName = cell.dataset.name;
                cell.textContent = '¬£0';
                cell.className = 'swindle-editable not-paid';
                
                if (playerName) {
                    const playerIndex = handicapPlayerData.findIndex(p => p.name === playerName);
                    if (playerIndex !== -1) {
                        handicapPlayerData[playerIndex].paid = '¬£0';
                    }
                }
            });
            updatePaymentStats();
            saveHandicapData();
        }
        
        function updatePaymentStats() {
            const cells = document.querySelectorAll('#extractedTable .swindle-editable');
            let total = 0, paid = 0;
            
            cells.forEach(cell => {
                const val = parseFloat(cell.textContent.replace('¬£', '')) || 0;
                total += val;
                if (val > 0) paid++;
            });
            
            document.getElementById('totalSwindle').textContent = '¬£' + total;
            document.getElementById('totalPlayers').textContent = cells.length;
            document.getElementById('paidPlayers').textContent = paid;
        }
        
        let handicapSortAscending = true;
        
        function sortHandicapTable() {
            const tbody = document.querySelector('#extractedTable tbody');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) return;
            
            // Toggle sort direction
            handicapSortAscending = !handicapSortAscending;
            
            // Update indicator
            const indicator = document.getElementById('handicap-sort-indicator');
            if (indicator) {
                indicator.textContent = handicapSortAscending ? '‚ñ≤' : '‚ñº';
            }
            
            // Sort rows by player name (column index 1)
            rows.sort((a, b) => {
                const nameA = a.cells[1].textContent.trim().toLowerCase();
                const nameB = b.cells[1].textContent.trim().toLowerCase();
                
                if (handicapSortAscending) {
                    return nameA.localeCompare(nameB);
                } else {
                    return nameB.localeCompare(nameA);
                }
            });
            
            // Re-append rows in sorted order
            rows.forEach(row => tbody.appendChild(row));
            
            // Update handicapPlayerData array to match sorted order
            handicapPlayerData = rows.map(row => {
                const name = row.cells[1].textContent.trim();
                return handicapPlayerData.find(p => p.name === name);
            }).filter(p => p);
            
            saveHandicapData();
        }
        
        function downloadHandicapCSV() {
            const rows = document.querySelectorAll('#extractedTable tbody tr');
            if (!rows.length) {
                alert('No data');
                return;
            }
            
            let csv = "Paid,Name,PGA_Index,Change_since_last_round,PGA_PH_cap_White_Tees,PGA_PH_cap_Yellow_Tees\n";
            rows.forEach(row => {
                const cells = row.cells;
                csv += `"${cells[0].textContent}","${cells[1].textContent}","${cells[2].textContent}","${cells[3].textContent}","${cells[4].textContent}","${cells[5].textContent}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'handicap_data.csv';
            a.click();
            URL.revokeObjectURL(url);
        }
        
        function createDraw() {
            const paidPlayers = handicapPlayerData.filter(p => {
                const val = parseFloat(p.paid.replace('¬£', '')) || 0;
                return val > 0;
            });
            
            if (!paidPlayers.length) {
                alert('No paid players');
                return;
            }
            
            const total = paidPlayers.length;
            let groups4 = Math.floor(total / 4);
            let remainder = total % 4;
            let groups3 = 0;
            
            if (remainder === 1 && groups4 >= 2) {
                groups4 -= 2;
                groups3 = 3;
            } else if (remainder === 2 && groups4 >= 1) {
                groups4 -= 1;
                groups3 = 2;
            } else if (remainder === 3) {
                groups3 = 1;
            } else if (remainder === 1) {
                groups3 = 1;
                groups4 = 0;
            } else if (remainder === 2) {
                groups3 = 1;
                groups4 = 0;
            }
            
            const shuffled = [...paidPlayers].sort(() => Math.random() - 0.5);
            groups = [];
            let idx = 0;
            
            for (let i = 0; i < groups3; i++) {
                groups.push({
                    players: shuffled.slice(idx, idx + 3),
                    teeBox: i + 1
                });
                idx += 3;
            }
            
            for (let i = 0; i < groups4; i++) {
                groups.push({
                    players: shuffled.slice(idx, idx + 4),
                    teeBox: groups3 + i + 1
                });
                idx += 4;
            }
            
            if (idx < total) {
                groups.push({
                    players: shuffled.slice(idx),
                    teeBox: groups.length + 1
                });
            }
            
            renderGroups();
            saveHandicapData();
        }
        
        function reshuffleDraw() {
            if (!groups.length) {
                createDraw();
                return;
            }
            
            const allPlayers = [];
            groups.forEach(g => allPlayers.push(...g.players));
            const shuffled = [...allPlayers].sort(() => Math.random() - 0.5);
            
            let idx = 0;
            groups.forEach(g => {
                const size = g.players.length;
                g.players = shuffled.slice(idx, idx + size);
                idx += size;
            });
            
            renderGroups();
            saveHandicapData();
        }
        
        function renderGroups() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '';
            
            // Update group selector dropdown
            const groupSelector = document.getElementById('newPlayerGroup');
            if (groupSelector) {
                groupSelector.innerHTML = '<option value="auto">Auto</option>';
                groups.forEach((group, idx) => {
                    const option = document.createElement('option');
                    option.value = idx;
                    option.textContent = `Group ${idx + 1} (${group.players.length} players)`;
                    groupSelector.appendChild(option);
                });
            }
            
            if (!groups.length) {
                container.innerHTML = '<div class="text-small">No draw created</div>';
                return;
            }
            
            groups.forEach((group, idx) => {
                const div = document.createElement('div');
                div.className = 'group';
                div.setAttribute('ondragover', 'handleDragOver(event)');
                div.setAttribute('ondrop', `handleDrop(event, ${idx})`);
                div.innerHTML = `
                    <div class="group-header">
                        <h3>G${idx + 1} <span class="group-size-badge">${group.players.length}</span></h3>
                        <div style="display: flex; align-items: center; gap: 4px;">
                            <span style="font-size: 8px; color: #e6f2ff;">Tee Box:</span>
                            <input type="number" class="tee-box-input" value="${group.teeBox}" min="1" max="20" 
                                   onchange="updateTeeBox(${idx}, this.value)">
                        </div>
                    </div>
                    ${group.players.map((p, pIdx) => `
                        <div class="player-item" 
                             draggable="true" 
                             ondragstart="handleDragStart(event, ${idx}, ${pIdx})" 
                             ondragover="handleDragOver(event)" 
                             ondrop="handleDrop(event, ${idx})" 
                             ondragend="handleDragEnd(event)"
                             style="cursor: move;">
                            <div>
                                <div class="player-name">‚ò∞ ${p.name}</div>
                                <div class="player-details">Index: ${p.newIndex || p.pgaIndex || 'N/A'} | White: ${p.whiteTees} | Yellow: ${p.yellowTees}</div>
                            </div>
                            <span class="delete-player" onclick="removeFromGroup(${idx}, '${p.name}')" style="pointer-events: auto;">√ó</span>
                        </div>
                    `).join('')}
                `;
                container.appendChild(div);
            });
        }
        
        function updateTeeBox(groupIdx, value) {
            const num = parseInt(value);
            if (num >= 1 && num <= 20) {
                groups[groupIdx].teeBox = num;
                saveHandicapData();
            }
        }
        
        function removeFromGroup(groupIdx, playerName) {
            if (!confirm('Remove from group?')) return;
            groups[groupIdx].players = groups[groupIdx].players.filter(p => p.name !== playerName);
            if (groups[groupIdx].players.length === 0) {
                groups.splice(groupIdx, 1);
            }
            renderGroups();
            saveHandicapData();
        }
        
        // Drag and Drop Functions
        let draggedPlayer = null;
        let draggedFromGroup = null;
        let draggedPlayerIndex = null;
        
        function handleDragStart(event, groupIdx, playerIdx) {
            draggedPlayer = groups[groupIdx].players[playerIdx];
            draggedFromGroup = groupIdx;
            draggedPlayerIndex = playerIdx;
            event.dataTransfer.effectAllowed = 'move';
            event.target.style.opacity = '0.5';
        }
        
        function handleDragOver(event) {
            if (event.preventDefault) {
                event.preventDefault();
            }
            event.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDrop(event, targetGroupIdx) {
            if (event.stopPropagation) {
                event.stopPropagation();
            }
            
            if (draggedPlayer && draggedFromGroup !== null) {
                // Remove from original group
                groups[draggedFromGroup].players.splice(draggedPlayerIndex, 1);
                
                // Add to target group
                groups[targetGroupIdx].players.push(draggedPlayer);
                
                // Clean up empty groups
                groups = groups.filter(g => g.players.length > 0);
                
                // Re-render and save
                renderGroups();
                saveHandicapData();
            }
            
            return false;
        }
        
        function handleDragEnd(event) {
            event.target.style.opacity = '1';
            draggedPlayer = null;
            draggedFromGroup = null;
            draggedPlayerIndex = null;
        }
        
        function addManualPlayer() {
            const name = document.getElementById('newPlayerName').value.trim();
            const newIndex = (document.getElementById('newPlayerNewIndex').value || '').trim();
            const previousIndex = (document.getElementById('newPlayerPreviousIndex').value || '').trim();
            const whiteTees = (document.getElementById('newPlayerWhiteTees').value || '').trim();
            const yellowTees = (document.getElementById('newPlayerYellowTees').value || '').trim();
            const paid = (document.getElementById('newPlayerPaid').value || '').trim();
            const groupSelection = document.getElementById('newPlayerGroup').value;
            
            if (!name) {
                alert('Enter name');
                return;
            }
            
            const paidValue = paid ? '¬£' + paid.replace('¬£', '') : '¬£0';
            const player = {
                name: name,
                newIndex: newIndex || 'N/A',
                pgaIndex: newIndex || 'N/A',
                totalAdjustment: 0,
                previousIndex: previousIndex || 'N/A',
                whiteTees: whiteTees || 'N/A',
                yellowTees: yellowTees || 'N/A',
                paid: paidValue
            };
            
            const tbody = document.querySelector('#extractedTable tbody');
            const tr = document.createElement('tr');
            const paidClass = paidValue !== '¬£0' ? 'paid' : 'not-paid';
            tr.innerHTML = `
                <td class="swindle-editable ${paidClass}" onclick="editPayment(this)" data-name="${name}">${paidValue}</td>
                <td>${player.name}</td>
                <td>${player.newIndex}</td>
                <td>${player.totalAdjustment}</td>
                <td>${player.previousIndex}</td>
                <td>${player.whiteTees}</td>
                <td>${player.yellowTees}</td>
            `;
            tbody.appendChild(tr);
            
            handicapPlayerData.push(player);
            
            if (paidValue !== '¬£0') {
                if (!groups.length) {
                    groups.push({ players: [player], teeBox: 1 });
                } else if (groupSelection === 'auto') {
                    // Find smallest group by size
                    let smallestIndex = 0;
                    for (let i = 1; i < groups.length; i++) {
                        if (groups[i].players.length < groups[smallestIndex].players.length) smallestIndex = i;
                    }
                    // If smallest group already has 4, start a new group
                    if (groups[smallestIndex].players.length >= 4) {
                        groups.push({ players: [player], teeBox: groups.length + 1 });
                    } else {
                        groups[smallestIndex].players.push(player);
                    }
                } else {
                    // Add to selected group (groupSelection is "0", "1", "2", etc.)
                    const groupIdx = parseInt(groupSelection);
                    if (groupIdx >= 0 && groupIdx < groups.length) {
                        if (groups[groupIdx].players.length >= 4) {
                            // Selected group full -> create a new group
                            groups.push({ players: [player], teeBox: groups.length + 1 });
                        } else {
                            groups[groupIdx].players.push(player);
                        }
                    } else {
                        // Fallback to smallest if invalid
                        let smallestIndex = 0;
                        for (let i = 1; i < groups.length; i++) {
                            if (groups[i].players.length < groups[smallestIndex].players.length) smallestIndex = i;
                        }
                        if (groups[smallestIndex].players.length >= 4) {
                            groups.push({ players: [player], teeBox: groups.length + 1 });
                        } else {
                            groups[smallestIndex].players.push(player);
                        }
                    }
                }
                
                renderGroups();
            }
            
            document.getElementById('newPlayerName').value = '';
            document.getElementById('newPlayerNewIndex').value = '';
            document.getElementById('newPlayerPreviousIndex').value = '';
            document.getElementById('newPlayerWhiteTees').value = '';
            document.getElementById('newPlayerYellowTees').value = '';
            document.getElementById('newPlayerPaid').value = '';
            document.getElementById('newPlayerGroup').value = 'auto';
            
            updatePaymentStats();
            saveHandicapData();
        }
        
        function captureDrawImage() {
            if (typeof html2canvas === 'undefined') {
                alert('Image capture not available');
                return;
            }
            
            if (!groups.length) {
                alert('No draw to capture');
                return;
            }
            
            // Create a temporary container for professional capture
            const temp = document.createElement('div');
            temp.style.position = 'absolute';
            temp.style.left = '-9999px';
            temp.style.backgroundColor = '#ffffff';
            temp.style.padding = '20px';
            temp.style.width = 'auto';
            document.body.appendChild(temp);
            
            // Add title
            const title = document.createElement('h2');
            title.textContent = 'Draw Groups';
            title.style.textAlign = 'center';
            title.style.marginBottom = '10px';
            title.style.color = '#1a6b4f';
            title.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            title.style.fontSize = '18px';
            temp.appendChild(title);
            
            // Add date
            const dateDiv = document.createElement('div');
            dateDiv.textContent = `Generated: ${new Date().toLocaleString()}`;
            dateDiv.style.textAlign = 'center';
            dateDiv.style.fontSize = '10px';
            dateDiv.style.marginBottom = '15px';
            dateDiv.style.color = '#666';
            temp.appendChild(dateDiv);
            
            // Create groups container
            const groupsWrapper = document.createElement('div');
            groupsWrapper.style.display = 'grid';
            groupsWrapper.style.gridTemplateColumns = `repeat(${Math.min(groups.length, 4)}, 1fr)`;
            groupsWrapper.style.gap = '15px';
            groupsWrapper.style.marginBottom = '15px';
            groupsWrapper.style.width = '100%';
            
            // Add each group
            groups.forEach((group, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.style.border = '2px solid #1a6b4f';
                groupDiv.style.borderRadius = '8px';
                groupDiv.style.padding = '12px';
                groupDiv.style.backgroundColor = '#f8f9fa';
                
                // Group header
                const groupHeader = document.createElement('div');
                groupHeader.style.display = 'flex';
                groupHeader.style.justifyContent = 'space-between';
                groupHeader.style.alignItems = 'center';
                groupHeader.style.marginBottom = '10px';
                groupHeader.style.paddingBottom = '8px';
                groupHeader.style.borderBottom = '2px solid #1a6b4f';
                
                const groupTitle = document.createElement('h3');
                groupTitle.textContent = `Group ${index + 1}`;
                groupTitle.style.margin = '0';
                groupTitle.style.fontSize = '14px';
                groupTitle.style.fontWeight = '700';
                groupTitle.style.color = '#1a6b4f';
                groupHeader.appendChild(groupTitle);
                
                const groupBadge = document.createElement('span');
                groupBadge.textContent = `${group.players.length} player${group.players.length !== 1 ? 's' : ''}`;
                groupBadge.style.backgroundColor = '#1a6b4f';
                groupBadge.style.color = 'white';
                groupBadge.style.padding = '3px 8px';
                groupBadge.style.borderRadius = '12px';
                groupBadge.style.fontSize = '10px';
                groupBadge.style.fontWeight = '600';
                groupHeader.appendChild(groupBadge);
                
                groupDiv.appendChild(groupHeader);
                
                // Tee box info
                const teeBoxDiv = document.createElement('div');
                teeBoxDiv.textContent = `Tee Box: ${group.teeBox || 1}`;
                teeBoxDiv.style.fontSize = '11px';
                teeBoxDiv.style.color = '#666';
                teeBoxDiv.style.marginBottom = '8px';
                teeBoxDiv.style.fontWeight = '600';
                groupDiv.appendChild(teeBoxDiv);
                
                // Players list
                group.players.forEach((player, pIndex) => {
                    const playerDiv = document.createElement('div');
                    playerDiv.style.display = 'flex';
                    playerDiv.style.justifyContent = 'space-between';
                    playerDiv.style.alignItems = 'center';
                    playerDiv.style.padding = '8px';
                    playerDiv.style.marginBottom = '4px';
                    playerDiv.style.backgroundColor = 'white';
                    playerDiv.style.borderRadius = '4px';
                    playerDiv.style.border = '1px solid #ddd';
                    
                    const playerName = document.createElement('span');
                    playerName.textContent = player.name;
                    playerName.style.fontSize = '11px';
                    playerName.style.fontWeight = '600';
                    playerName.style.color = '#333';
                    playerDiv.appendChild(playerName);
                    
                    const playerDetails = document.createElement('span');
                    playerDetails.textContent = `Index: ${player.newIndex || player.pgaIndex || 'N/A'} | White: ${player.whiteTees || 'N/A'} | Yellow: ${player.yellowTees || 'N/A'}`;
                    playerDetails.style.fontSize = '10px';
                    playerDetails.style.color = '#666';
                    playerDiv.appendChild(playerDetails);
                    
                    groupDiv.appendChild(playerDiv);
                });
                
                groupsWrapper.appendChild(groupDiv);
            });
            
            temp.appendChild(groupsWrapper);
            
            // Add summary
            const summary = document.createElement('div');
            summary.style.marginTop = '10px';
            summary.style.padding = '10px';
            summary.style.backgroundColor = '#f0f7ff';
            summary.style.border = '2px solid #1a6b4f';
            summary.style.borderRadius = '4px';
            summary.style.textAlign = 'center';
            
            const totalPlayers = groups.reduce((sum, g) => sum + g.players.length, 0);
            summary.innerHTML = `<strong style="color: #1a6b4f; font-size: 11px;">Total Groups:</strong> <span style="font-size: 11px;">${groups.length}</span> | <strong style="color: #1a6b4f; font-size: 11px;">Total Players:</strong> <span style="font-size: 11px;">${totalPlayers}</span>`;
            temp.appendChild(summary);
            
            // Capture the image
            html2canvas(temp, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true
            }).then(canvas => {
                document.body.removeChild(temp);
                
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                link.download = `Draw_Groups_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }).catch(error => {
                document.body.removeChild(temp);
                console.error('Capture error:', error);
                alert('Error capturing draw image');
            });
        }
        
        function captureFivePoundPlayers() {
            if (typeof html2canvas === 'undefined') return;
            const cells = document.querySelectorAll('#extractedTable .swindle-editable.paid');
            if (!cells.length) {
                alert('No ¬£5 players');
                return;
            }
            
            const temp = document.createElement('div');
            temp.style.position = 'absolute';
            temp.style.left = '-9999px';
            temp.style.backgroundColor = '#ffffff';
            temp.style.padding = '20px';
            document.body.appendChild(temp);
            
            // Add title
            const title = document.createElement('h2');
            title.textContent = '¬£5 Players - Handicap Data';
            title.style.textAlign = 'center';
            title.style.marginBottom = '10px';
            title.style.color = '#1a6b4f';
            title.style.fontFamily = "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif";
            temp.appendChild(title);
            
            // Add date
            const dateDiv = document.createElement('div');
            dateDiv.textContent = `Generated: ${new Date().toLocaleString()}`;
            dateDiv.style.textAlign = 'center';
            dateDiv.style.fontSize = '10px';
            dateDiv.style.marginBottom = '15px';
            dateDiv.style.color = '#666';
            temp.appendChild(dateDiv);
            
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.style.fontSize = '10px';
            table.style.backgroundColor = 'white';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headerRow.style.backgroundColor = '#1a6b4f';
            headerRow.style.color = 'white';
            
            const headers = ['Paid', 'Name', 'PGA Index', 'Change Since Last Round', 'PGA PH Cap White Tees', 'PGA PH Cap Yellow Tees'];
            headers.forEach(headerText => {
                const th = document.createElement('th');
                th.textContent = headerText;
                th.style.padding = '8px 6px';
                th.style.textAlign = 'center';
                th.style.fontWeight = '700';
                th.style.fontSize = '9px';
                th.style.border = '1px solid rgba(255, 255, 255, 0.1)';
                th.style.whiteSpace = 'nowrap';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body with only ¬£5 players
            const tbody = document.createElement('tbody');
            const rows = Array.from(document.querySelectorAll('#extractedTable tbody tr'))
                .filter(row => row.cells[0].textContent === '¬£5');
            
            rows.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid #eee';
                
                // Alternating row colors
                if (index % 2 === 1) {
                    tr.style.backgroundColor = '#f9f9f9';
                } else {
                    tr.style.backgroundColor = 'white';
                }
                
                // Add all 6 columns: Paid, Name, PGA_Index, Change, White Tees, Yellow Tees
                for (let i = 0; i < 6; i++) {
                    const td = document.createElement('td');
                    td.style.border = '1px solid #eee';
                    td.style.padding = '6px';
                    td.style.textAlign = i === 1 ? 'left' : 'center'; // Left align Name column
                    td.style.color = '#333';
                    td.style.fontSize = '9px';
                    
                    if (row.cells[i]) {
                        td.textContent = row.cells[i].textContent;
                        
                        // Style the Paid column
                        if (i === 0) {
                            td.style.color = '#4CAF50';
                            td.style.fontWeight = 'bold';
                        }
                        // Style the Name column
                        else if (i === 1) {
                            td.style.fontWeight = '600';
                        }
                    }
                    
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });
            
            table.appendChild(tbody);
            temp.appendChild(table);
            
            // Calculate total money
            const totalPlayers = rows.length;
            const totalMoney = totalPlayers * 5;
            
            // Add summary box
            const summaryBox = document.createElement('div');
            summaryBox.style.marginTop = '15px';
            summaryBox.style.padding = '10px';
            summaryBox.style.backgroundColor = '#f0f7ff';
            summaryBox.style.border = '2px solid #1a6b4f';
            summaryBox.style.borderRadius = '4px';
            summaryBox.style.textAlign = 'center';
            
            const summaryTitle = document.createElement('div');
            summaryTitle.textContent = 'Summary';
            summaryTitle.style.fontSize = '11px';
            summaryTitle.style.fontWeight = 'bold';
            summaryTitle.style.color = '#1a6b4f';
            summaryTitle.style.marginBottom = '8px';
            summaryBox.appendChild(summaryTitle);
            
            const playerCount = document.createElement('div');
            playerCount.innerHTML = `<strong>Total Players:</strong> ${totalPlayers}`;
            playerCount.style.fontSize = '10px';
            playerCount.style.color = '#333';
            playerCount.style.marginBottom = '4px';
            summaryBox.appendChild(playerCount);
            
            const totalAmount = document.createElement('div');
            totalAmount.innerHTML = `<strong>Total Collected:</strong> ¬£${totalMoney}`;
            totalAmount.style.fontSize = '12px';
            totalAmount.style.fontWeight = 'bold';
            totalAmount.style.color = '#4CAF50';
            summaryBox.appendChild(totalAmount);
            
            temp.appendChild(summaryBox);
            
            html2canvas(temp, {
                scale: 2,
                backgroundColor: '#ffffff',
                logging: false,
                useCORS: true
            }).then(canvas => {
                const link = document.createElement('a');
                const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
                link.download = `Five_Pound_Players_${timestamp}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                document.body.removeChild(temp);
            }).catch(error => {
                document.body.removeChild(temp);
                console.error('Capture error:', error);
                alert('Error capturing image');
            });
        }
        
        function clearHandicapResults() {
            if (!confirm('Clear all handicap data? The page will reload.')) return;
            
            // Clear everything
            localStorage.removeItem('handicapData');
            
            // Reload page to ensure clean state everywhere
            location.reload();
        }
        
        function saveHandicapData() {
            const data = {
                players: handicapPlayerData,
                groups: groups,
                removeQuotes: document.getElementById('removeQuotes').checked,
                removeDefaultNames: document.getElementById('removeDefaultNames').checked
            };
            localStorage.setItem('handicapData', JSON.stringify(data));
        }
        
        function loadHandicapData() {
            const saved = localStorage.getItem('handicapData');
            if (saved) {
                const data = JSON.parse(saved);
                handicapPlayerData = data.players || [];
                groups = data.groups || [];
                
                document.getElementById('removeQuotes').checked = data.removeQuotes || false;
                document.getElementById('removeDefaultNames').checked = data.removeDefaultNames || false;
                
                const tbody = document.querySelector('#extractedTable tbody');
                tbody.innerHTML = '';
                
                handicapPlayerData.forEach(p => {
                    const tr = document.createElement('tr');
                    const paidClass = p.paid !== '¬£0' ? 'paid' : 'not-paid';
                    tr.innerHTML = `
                        <td class="swindle-editable ${paidClass}" onclick="editPayment(this)" data-name="${p.name}">${p.paid}</td>
                        <td>${p.name}</td>
                        <td>${p.newIndex || p.pgaIndex || ''}</td>
                        <td>${p.totalAdjustment || p.changeSinceLastRound || 0}</td>
                        <td>${p.previousIndex || ''}</td>
                        <td>${p.whiteTees}</td>
                        <td>${p.yellowTees}</td>
                    `;
                    tbody.appendChild(tr);
                });
                
                updatePaymentStats();
                renderGroups();
            }
        }
        
        const uploadBox = document.getElementById('uploadBox');
        const fileInput = document.getElementById('fileInput');
        
        uploadBox.addEventListener('click', () => {
            fileInput.click();
        });
        
        fileInput.addEventListener('change', (e) => {
            uploadedFiles = Array.from(e.target.files);
            console.log('Files selected:', uploadedFiles.length);
            
            if (uploadedFiles.length > 0) {
                const fileNames = uploadedFiles.map(f => f.name).join(', ');
                uploadBox.innerHTML = `
                    <i class="fas fa-check-circle" style="color: #4CAF50;"></i>
                    <p style="color: #4CAF50; font-weight: bold;">${uploadedFiles.length} file(s) selected</p>
                    <p class="text-tiny" style="color: #4CAF50;">${fileNames}</p>
                `;
            } else {
                uploadBox.innerHTML = `
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Click to upload handicap file</p>
                    <p class="text-tiny">JPG, PNG, TXT, DOCX, XLSX</p>
                `;
            }
        });
        
        function toggleThemeDropdown() {
            document.getElementById('themeDropdown').classList.toggle('show');
        }
        
        function changeTheme(name) {
            const body = document.body;
            const container = document.querySelector('.container');
            const header = document.querySelector('.app-header');
            const tabs = document.querySelector('.tabs');
            const sections = document.querySelectorAll('.section');
            const allTabs = document.querySelectorAll('.tab');
            const sectionHeaders = document.querySelectorAll('.section h2');
            const labels = document.querySelectorAll('.form-group label, .checkboxes label, .checkboxes span, label');
            const statsLabels = document.querySelectorAll('.stats span');
            const footers = document.querySelectorAll('.footer');
            const legendText = document.querySelectorAll('.stats strong, .section strong, .course-info label, .course-info');
            const allText = document.querySelectorAll('.text-small, .text-tiny, .app-description');
            const instructions = document.querySelectorAll('.section > div');
            const courseInfo = document.querySelectorAll('.course-info, .course-info *');
            const groupHeaders = document.querySelectorAll('.group-header h3, .compact-card h3');
            const allSpans = document.querySelectorAll('span:not(.stableford-points):not(.group-size-badge)');
            const legendBox = document.querySelector('.legend-box');
            const legendBoxContent = document.querySelectorAll('.legend-box *');
            const allInputs = document.querySelectorAll('input, select, textarea');
            const allButtons = document.querySelectorAll('button');
            const uploadBox = document.querySelector('.upload-box');
            const uploadBoxContent = document.querySelectorAll('.upload-box *');
            const statsDivs = document.querySelectorAll('.stats div');
            const statsContent = document.querySelectorAll('.stats *');
            const compactCards = document.querySelectorAll('.compact-card');
            const compactCardContent = document.querySelectorAll('.compact-card *');
            const groups = document.querySelectorAll('.group');
            const groupContent = document.querySelectorAll('.group *, .group-header *, .player-item *, .player-name, .player-details');
            const teeBoxInputs = document.querySelectorAll('.tee-box-input');
            
            // Reset any inline styles
            container.style.backgroundColor = '';
            header.style.background = '';
            header.style.color = '';
            tabs.style.background = '';
            sections.forEach(s => {
                s.style.backgroundColor = '';
                s.style.borderColor = '';
                s.style.color = '';
            });
            allTabs.forEach(t => t.style.color = '');
            sectionHeaders.forEach(h => h.style.color = '');
            labels.forEach(l => l.style.color = '');
            statsLabels.forEach(s => s.style.color = '');
            footers.forEach(f => f.style.color = '');
            legendText.forEach(l => l.style.color = '');
            allText.forEach(t => t.style.color = '');
            courseInfo.forEach(c => c.style.color = '');
            groupHeaders.forEach(h => h.style.color = '');
            allSpans.forEach(s => s.style.color = '');
            if (legendBox) {
                legendBox.style.backgroundColor = '';
                legendBox.style.color = '';
            }
            legendBoxContent.forEach(l => l.style.color = '');
            
            // Reset upload box
            if (uploadBox) {
                uploadBox.style.backgroundColor = '';
                uploadBox.style.color = '';
                uploadBox.style.borderColor = '';
            }
            uploadBoxContent.forEach(e => e.style.color = '');
            
            // Reset stats
            statsDivs.forEach(d => {
                d.style.backgroundColor = '';
                d.style.color = '';
                d.style.borderColor = '';
            });
            statsContent.forEach(s => s.style.color = '');
            
            // Reset compact cards
            compactCards.forEach(c => {
                c.style.backgroundColor = '';
                c.style.color = '';
                c.style.borderColor = '';
            });
            compactCardContent.forEach(c => c.style.color = '');
            
            // Reset groups
            groups.forEach(g => {
                g.style.backgroundColor = '';
                g.style.color = '';
                g.style.borderColor = '';
            });
            groupContent.forEach(g => g.style.color = '');
            
            // Don't reset inputs/buttons - they should always be white background
            
            // Apply theme colors
            const themes = {
                'ocean-breeze': {
                    bodyBg: '#e0f2f7',
                    bodyText: '#01579b',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #4fc3f7 0%, #0288d1 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #0288d1 0%, #01579b 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#e1f5fe',
                    sectionText: '#01579b',
                    sectionHeaderText: '#01579b',
                    labelText: '#01579b',
                    borderColor: '#01579b33'
                },
                'mint-fresh': {
                    bodyBg: '#e8f5e9',
                    bodyText: '#1b5e20',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #66bb6a 0%, #388e3c 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #43a047 0%, #2e7d32 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#f1f8e9',
                    sectionText: '#1b5e20',
                    sectionHeaderText: '#1b5e20',
                    labelText: '#1b5e20',
                    borderColor: '#1b5e2033'
                },
                'sunset-glow': {
                    bodyBg: '#fff3e0',
                    bodyText: '#e65100',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #ff9800 0%, #f57c00 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #fb8c00 0%, #ef6c00 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#ffe0b2',
                    sectionText: '#e65100',
                    sectionHeaderText: '#e65100',
                    labelText: '#e65100',
                    borderColor: '#e6510033'
                },
                'lavender-dream': {
                    bodyBg: '#f3e5f5',
                    bodyText: '#4a148c',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #ba68c8 0%, #8e24aa 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #ab47bc 0%, #7b1fa2 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#e1bee7',
                    sectionText: '#4a148c',
                    sectionHeaderText: '#4a148c',
                    labelText: '#4a148c',
                    borderColor: '#4a148c33'
                },
                'rose-garden': {
                    bodyBg: '#fce4ec',
                    bodyText: '#880e4f',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #f06292 0%, #c2185b 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #ec407a 0%, #ad1457 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#f8bbd0',
                    sectionText: '#880e4f',
                    sectionHeaderText: '#880e4f',
                    labelText: '#880e4f',
                    borderColor: '#880e4f33'
                },
                'golden-sand': {
                    bodyBg: '#fff8e1',
                    bodyText: '#f57f17',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #ffd54f 0%, #fbc02d 100%)',
                    headerText: '#5d4037',
                    tabsBg: 'linear-gradient(135deg, #ffca28 0%, #f9a825 100%)',
                    tabText: '#5d4037',
                    sectionBg: '#fff9c4',
                    sectionText: '#f57f17',
                    sectionHeaderText: '#f57f17',
                    labelText: '#f57f17',
                    borderColor: '#f57f1733'
                },
                'sky-blue': {
                    bodyBg: '#e3f2fd',
                    bodyText: '#0d47a1',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #64b5f6 0%, #1976d2 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #42a5f5 0%, #1565c0 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#bbdefb',
                    sectionText: '#0d47a1',
                    sectionHeaderText: '#0d47a1',
                    labelText: '#0d47a1',
                    borderColor: '#0d47a133'
                },
                'peach-cream': {
                    bodyBg: '#fbe9e7',
                    bodyText: '#bf360c',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #ff8a65 0%, #f4511e 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #ff7043 0%, #e64a19 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#ffccbc',
                    sectionText: '#bf360c',
                    sectionHeaderText: '#bf360c',
                    labelText: '#bf360c',
                    borderColor: '#bf360c33'
                },
                'forest-mist': {
                    bodyBg: '#e0f2f1',
                    bodyText: '#004d40',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #4db6ac 0%, #00897b 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #26a69a 0%, #00796b 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#b2dfdb',
                    sectionText: '#004d40',
                    sectionHeaderText: '#004d40',
                    labelText: '#004d40',
                    borderColor: '#004d4033'
                },
                'coral-reef': {
                    bodyBg: '#fce4ec',
                    bodyText: '#d32f2f',
                    containerBg: '#ffffff',
                    headerBg: 'linear-gradient(135deg, #ff6f60 0%, #e53935 100%)',
                    headerText: '#ffffff',
                    tabsBg: 'linear-gradient(135deg, #ef5350 0%, #d32f2f 100%)',
                    tabText: '#ffffff',
                    sectionBg: '#ffcdd2',
                    sectionText: '#d32f2f',
                    sectionHeaderText: '#d32f2f',
                    labelText: '#d32f2f',
                    borderColor: '#d32f2f33'
                }
            };
            
            const theme = themes[name];
            if (theme) {
                // Apply base colors
                body.style.backgroundColor = theme.bodyBg;
                body.style.color = theme.bodyText;
                container.style.backgroundColor = theme.containerBg;
                
                // Apply header colors
                header.style.background = theme.headerBg;
                header.style.color = theme.headerText;
                
                // Apply tab colors
                tabs.style.background = theme.tabsBg;
                allTabs.forEach(t => {
                    if (!t.classList.contains('active')) {
                        t.style.color = theme.tabText;
                    }
                });
                
                // Apply section colors
                sections.forEach(s => {
                    s.style.backgroundColor = theme.sectionBg;
                    s.style.borderColor = theme.borderColor;
                    s.style.color = theme.sectionText;
                });
                
                // Apply section header colors
                sectionHeaders.forEach(h => {
                    h.style.color = theme.sectionHeaderText;
                });
                
                // Apply label colors (all labels)
                labels.forEach(l => {
                    l.style.color = theme.labelText;
                });
                
                // Apply stats label colors
                statsLabels.forEach(s => {
                    s.style.color = theme.sectionText;
                });
                
                // Apply footer colors
                footers.forEach(f => {
                    f.style.color = theme.sectionText;
                });
                
                // Apply legend text colors
                legendText.forEach(l => {
                    l.style.color = theme.sectionText;
                });
                
                // Apply to all small text elements
                allText.forEach(t => {
                    t.style.color = theme.sectionText;
                });
                
                // Apply to course info
                courseInfo.forEach(c => {
                    c.style.color = theme.sectionText;
                });
                
                // Apply to group headers
                groupHeaders.forEach(h => {
                    h.style.color = theme.sectionText;
                });
                
                // Apply to all spans
                allSpans.forEach(s => {
                    if (!s.closest('.app-header') && !s.closest('.tabs')) {
                        s.style.color = theme.sectionText;
                    }
                });
                
                // Apply to legend box
                if (legendBox) {
                    legendBox.style.backgroundColor = theme.sectionBg;
                    legendBox.style.color = theme.sectionText;
                    legendBox.style.borderColor = theme.borderColor;
                    legendBox.style.border = `1px solid ${theme.borderColor}`;
                }
                legendBoxContent.forEach(l => {
                    l.style.color = theme.sectionText;
                });
                
                // Ensure all inputs/selects/textareas remain white with dark text
                allInputs.forEach(input => {
                    if (!input.closest('#standings-table') && !input.closest('#scorecard-table') && !input.closest('#calculator-table') && !input.closest('#extractedTable')) {
                        input.style.backgroundColor = '#ffffff';
                        input.style.color = '#333333';
                        input.style.borderColor = '#cccccc';
                    }
                });
                
                // Apply to upload box
                if (uploadBox) {
                    uploadBox.style.backgroundColor = 'rgba(74, 144, 226, 0.1)';
                    uploadBox.style.color = theme.sectionText;
                    uploadBox.style.borderColor = '#4a90e2';
                }
                uploadBoxContent.forEach(e => {
                    e.style.color = theme.sectionText;
                });
                
                // Apply to stats
                statsDivs.forEach(d => {
                    d.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                    d.style.color = theme.sectionText;
                    d.style.borderColor = theme.sectionText;
                });
                statsContent.forEach(s => {
                    s.style.color = theme.sectionText;
                });
                
                // Apply to compact cards
                compactCards.forEach(c => {
                    c.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                    c.style.color = theme.sectionText;
                    c.style.borderColor = theme.sectionText;
                });
                compactCardContent.forEach(c => {
                    c.style.color = theme.sectionText;
                });
                
                // Apply to groups
                groups.forEach(g => {
                    g.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
                    g.style.color = theme.sectionText;
                    g.style.borderColor = theme.sectionText;
                });
                groupContent.forEach(g => {
                    g.style.color = theme.sectionText;
                });
            }
            
            localStorage.setItem('theme', name);
            document.getElementById('themeDropdown').classList.remove('show');
        }
        
        function loadTheme() {
            const saved = localStorage.getItem('theme') || 'ocean-breeze';
            changeTheme(saved);
        }
        
        // ============================================
        // BACKUP AND RESTORE FUNCTIONS
        // ============================================
        
        function backupAllData() {
            const backup = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                data: {
                    // League data
                    pgaLeagueData: localStorage.getItem('pgaLeagueData'),
                    bestCount: localStorage.getItem('bestCount'),
                    
                    // Handicap data
                    handicapData: localStorage.getItem('handicapData'),
                    
                    // Scorecard data
                    allWeeksScorecardData: localStorage.getItem('allWeeksScorecardData'),
                    currentScorecardWeek: localStorage.getItem('currentScorecardWeek'),
                    globalParValues: localStorage.getItem('globalParValues'),
                    globalIndexValues: localStorage.getItem('globalIndexValues'),
                    
                    // Calculator data
                    calculatorData: localStorage.getItem('calculatorData'),
                    
                    // Winners data
                    allWeeksWinnersData: localStorage.getItem('allWeeksWinnersData'),
                    
                    // App settings
                    activeTab: localStorage.getItem('activeTab'),
                    theme: localStorage.getItem('theme')
                }
            };
            
            const json = JSON.stringify(backup, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            a.download = `PGA_League_Backup_${timestamp}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert('Backup completed successfully!');
        }
        
        function restoreAllData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!confirm('This will replace ALL current data with the backup. Are you sure?\n\nCurrent data will be lost if not backed up first.')) {
                event.target.value = ''; // Reset file input
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backup = JSON.parse(e.target.result);
                    
                    if (!backup.data) {
                        throw new Error('Invalid backup file format');
                    }
                    
                    // Restore all data to localStorage
                    Object.keys(backup.data).forEach(key => {
                        if (backup.data[key] !== null && backup.data[key] !== undefined) {
                            localStorage.setItem(key, backup.data[key]);
                        }
                    });
                    
                    alert(`Backup restored successfully!\n\nBackup created: ${new Date(backup.timestamp).toLocaleString()}\n\nThe page will now reload.`);
                    
                    // Reload the page to apply all restored data
                    location.reload();
                    
                } catch (error) {
                    alert('Error restoring backup: ' + error.message);
                    console.error('Restore error:', error);
                }
                
                // Reset file input
                event.target.value = '';
            };
            
            reader.onerror = function() {
                alert('Error reading backup file');
                event.target.value = '';
            };
            
            reader.readAsText(file);
        }
        
        // ============================================
        // GOLF HANDICAP CALCULATOR TOGGLE
        // ============================================
        
        function toggleGolfHandicapCalculator() {
            const calcSection = document.getElementById('embedded-golf-calculator');
            const toggleText = document.getElementById('calc-toggle-text');
            
            if (calcSection.style.display === 'none') {
                calcSection.style.display = 'block';
                toggleText.textContent = 'Hide Golf H\'CAP Calculator';
                // Initialize calculator if first time opening
                if (!window.golfCalcInitialized) {
                    initializeGolfCalculator();
                    window.golfCalcInitialized = true;
                }
                // Scroll to calculator
                setTimeout(() => {
                    calcSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
            } else {
                calcSection.style.display = 'none';
                toggleText.textContent = 'Show Golf H\'CAP Calculator';
            }
        }
        
        // ============================================
        // GOLF HANDICAP CALCULATOR FUNCTIONS
        // ============================================
        
        const golfCourses = {
            "White": { slope: 128, rating: 71.5, par: 71 },
            "Yellow": { slope: 123, rating: 70.1, par: 71 }
        };
        
        const golfParams = {
            winThreshold: 29,
            noWinThreshold: 31,
            exceptionalThreshold: 36,
            maxIndex: 15.1,
            minIndex: -18,
            cutBase: 0.8,
            cutCatDivisor: 40,
            cutIndexPercent: 0.02,
            incIndexPercent: 0.02,
            incAddValue: 0.2,
            incCatDivisor: 30,
            excCatDivisor: 10,
            excIndexPercent: 0.0225,
            cat1Max: -0.1,
            cat2Max: 4.9,
            cat3Max: 9.9,
            cat4Min: 10
        };
        
        function initializeGolfCalculator() {
            // Set up event listeners for auto-calculation
            document.getElementById('golf-playerIndex').addEventListener('change', calculateGolfHandicap);
            document.getElementById('golf-prizeMoney').addEventListener('change', calculateGolfHandicap);
            document.getElementById('golf-stablefordPoints').addEventListener('change', calculateGolfHandicap);
            document.getElementById('golf-finishingPosition').addEventListener('change', calculateGolfHandicap);
            document.getElementById('golf-teeColor').addEventListener('change', calculateGolfHandicap);
            document.getElementById('golf-manualAdjustment').addEventListener('change', calculateGolfHandicap);
            
            // Initial calculation
            calculateGolfHandicap();
        }
        
        function updateGolfCourseInfo() {
            const teeColor = document.getElementById('golf-teeColor').value;
            const course = golfCourses[teeColor];
            
            document.getElementById('golf-slopeRating').textContent = course.slope;
            document.getElementById('golf-courseRating').textContent = course.rating;
            document.getElementById('golf-coursePar').textContent = course.par;
        }
        
        function calculateGolfIndexCategory(index) {
            if (index <= golfParams.cat1Max) {
                return 1;
            } else if (index <= golfParams.cat2Max) {
                return 2;
            } else if (index <= golfParams.cat3Max) {
                return 3;
            } else {
                return 4;
            }
        }
        
        function calculateGolfHandicap() {
            // Get input values
            const playerName = document.getElementById('golf-playerName').value;
            const playerIndex = parseFloat(document.getElementById('golf-playerIndex').value);
            const prizeMoney = parseFloat(document.getElementById('golf-prizeMoney').value);
            const stablefordPoints = parseFloat(document.getElementById('golf-stablefordPoints').value);
            const teeColor = document.getElementById('golf-teeColor').value;
            const manualAdjustment = parseFloat(document.getElementById('golf-manualAdjustment').value) || 0;
            
            // Update player name display
            const nameDisplay = document.getElementById('golf-playerNameDisplay');
            if (playerName.trim()) {
                nameDisplay.textContent = playerName;
            } else {
                nameDisplay.textContent = '';
            }
            
            // Update course info based on tee selection
            updateGolfCourseInfo();
            
            // Get course data
            const course = golfCourses[teeColor];
            
            // Calculate index category
            const category = calculateGolfIndexCategory(playerIndex);
            document.getElementById('golf-indexCategory').textContent = `Category ${category}`;
            
            // Stage 1: Index Cut (if won money AND scored > winThreshold)
            // IMPORTANT: Cut is divided by finishing position (1st, 2nd, 3rd, 4th)
            let stage1 = 0;
            const finishingPosition = parseInt(document.getElementById('golf-finishingPosition').value) || null;
            if (prizeMoney > 0 && stablefordPoints > golfParams.winThreshold && finishingPosition) {
                const baseCut = golfParams.cutBase + (category / golfParams.cutCatDivisor) + (playerIndex * golfParams.cutIndexPercent);
                stage1 = - (baseCut / finishingPosition);
            }
            document.getElementById('golf-stage1').textContent = stage1.toFixed(2);
            
            // Stage 2: Index Increase (if no money AND scored < noWinThreshold AND category > 0)
            let stage2 = 0;
            if (prizeMoney === 0 && stablefordPoints < golfParams.noWinThreshold && category > 0) {
                stage2 = (playerIndex * golfParams.incIndexPercent) + golfParams.incAddValue + (category / golfParams.incCatDivisor);
            }
            document.getElementById('golf-stage2').textContent = stage2.toFixed(2);
            
            // Stage 3: Exceptional Cut (if scored > exceptionalThreshold)
            let stage3 = 0;
            if (stablefordPoints > golfParams.exceptionalThreshold) {
                const pointsOver = stablefordPoints - golfParams.exceptionalThreshold;
                stage3 = - ((category / golfParams.excCatDivisor) + (playerIndex * golfParams.excIndexPercent)) * pointsOver;
            }
            document.getElementById('golf-stage3').textContent = stage3.toFixed(2);
            
            // Stage 5: Total adjustment
            const stage5 = stage1 + stage2 + stage3 + manualAdjustment;
            document.getElementById('golf-stage5').textContent = stage5.toFixed(2);
            
            // Stage 6: New Index (limited to maxIndex)
            let newIndex = playerIndex + stage5;
            if (newIndex > golfParams.maxIndex) {
                newIndex = golfParams.maxIndex;
            }
            newIndex = Math.round(newIndex * 10) / 10; // Round to 1 decimal place
            document.getElementById('golf-newIndex').textContent = newIndex.toFixed(1);
            
            // Stage 7: Course Handicap
            const courseHandicap = Math.round((newIndex * course.slope / 113) + (course.rating - course.par));
            document.getElementById('golf-courseHandicap').textContent = courseHandicap;
            
            // Update final results display
            document.getElementById('golf-prevIndex').textContent = playerIndex.toFixed(1);
            document.getElementById('golf-totalAdjustment').textContent = stage5.toFixed(2);
        }
        
        function addPlayerToGolfReport() {
            // Get input values
            const playerName = document.getElementById('golf-playerName').value.trim();
            
            if (!playerName) {
                alert('Please enter a player name before adding to report.');
                return;
            }
            
            const playerIndex = parseFloat(document.getElementById('golf-playerIndex').value);
            const prizeMoney = parseFloat(document.getElementById('golf-prizeMoney').value) || 0;
            const stablefordPoints = parseFloat(document.getElementById('golf-stablefordPoints').value);
            const finishingPosition = parseInt(document.getElementById('golf-finishingPosition').value) || null;
            const teeColor = document.getElementById('golf-teeColor').value;
            const manualAdjustment = parseFloat(document.getElementById('golf-manualAdjustment').value) || 0;
            
            // Get course data
            const course = golfCourses[teeColor];
            
            // Calculate index category
            const category = calculateGolfIndexCategory(playerIndex);
            
            // Calculate stages (same logic as calculateGolfHandicap)
            let stage1 = 0;
            if (prizeMoney > 0 && stablefordPoints > golfParams.winThreshold && finishingPosition) {
                const baseCut = golfParams.cutBase + (category / golfParams.cutCatDivisor) + (playerIndex * golfParams.cutIndexPercent);
                stage1 = - (baseCut / finishingPosition);
            }
            
            let stage2 = 0;
            if (prizeMoney === 0 && stablefordPoints < golfParams.noWinThreshold && category > 0) {
                stage2 = (playerIndex * golfParams.incIndexPercent) + golfParams.incAddValue + (category / golfParams.incCatDivisor);
            }
            
            let stage3 = 0;
            if (stablefordPoints > golfParams.exceptionalThreshold) {
                const pointsOver = stablefordPoints - golfParams.exceptionalThreshold;
                stage3 = - ((category / golfParams.excCatDivisor) + (playerIndex * golfParams.excIndexPercent)) * pointsOver;
            }
            
            const stage5 = stage1 + stage2 + stage3 + manualAdjustment;
            
            let newIndex = playerIndex + stage5;
            if (newIndex > golfParams.maxIndex) {
                newIndex = golfParams.maxIndex;
            }
            newIndex = Math.round(newIndex * 10) / 10;
            
            const courseHandicap = Math.round((newIndex * course.slope / 113) + (course.rating - course.par));
            
            // Add to report
            appendToGolfReport({
                name: playerName,
                previousIndex: playerIndex,
                category: category,
                prizeMoney: prizeMoney,
                stablefordPoints: stablefordPoints,
                finishingPosition: finishingPosition,
                teeColor: teeColor,
                stage1: stage1,
                stage2: stage2,
                stage3: stage3,
                manualAdjustment: manualAdjustment,
                totalAdjustment: stage5,
                newIndex: newIndex,
                courseHandicap: courseHandicap
            });
            
            alert(`${playerName} added to report! (Total: ${golfReportData.length} players)`);
        }
        
        function populateGolfPlayerDropdown() {
            const select = document.getElementById('golf-playerNameSelect');
            
            // Clear existing options except the first one
            select.innerHTML = '<option value="">-- Select Player --</option>';
            
            // Add all league players
            leaguePlayers.forEach(player => {
                const option = document.createElement('option');
                option.value = player.name;
                option.textContent = player.name;
                select.appendChild(option);
            });
        }
        
        function selectGolfPlayer() {
            const select = document.getElementById('golf-playerNameSelect');
            const nameInput = document.getElementById('golf-playerName');
            
            if (select.value) {
                nameInput.value = select.value;
            }
        }
        
        function resetGolfCalculator() {
            // Reset to default values
            document.getElementById('golf-playerNameSelect').value = '';
            document.getElementById('golf-playerName').value = '';
            document.getElementById('golf-playerIndex').value = 6.4;
            document.getElementById('golf-prizeMoney').value = 0;
            document.getElementById('golf-stablefordPoints').value = 38;
            document.getElementById('golf-finishingPosition').value = '';
            document.getElementById('golf-teeColor').value = 'White';
            document.getElementById('golf-manualAdjustment').value = 0;
            
            // Recalculate
            calculateGolfHandicap();
        }
        
        // ============================================
        // CALCULATION PARAMETERS SETTINGS
        // ============================================
        
        const defaultGolfParams = {
            winThreshold: 29,
            noWinThreshold: 31,
            exceptionalThreshold: 36,
            maxIndex: 15.1,
            minIndex: -18,
            cutBase: 0.8,
            cutCatDivisor: 40,
            cutIndexPercent: 0.02,
            incIndexPercent: 0.02,
            incAddValue: 0.2,
            incCatDivisor: 30,
            excCatDivisor: 10,
            excIndexPercent: 0.0225,
            cat1Max: -0.1,
            cat2Max: 4.9,
            cat3Max: 9.9,
            cat4Min: 10
        };
        
        function loadCalculationParameters() {
            const saved = localStorage.getItem('golfCalculationParams');
            if (saved) {
                try {
                    const savedParams = JSON.parse(saved);
                    Object.assign(golfParams, savedParams);
                    console.log('Loaded custom calculation parameters');
                } catch (e) {
                    console.error('Error loading calculation parameters:', e);
                }
            }
        }
        
        function saveCalculationParameters() {
            try {
                localStorage.setItem('golfCalculationParams', JSON.stringify(golfParams));
                console.log('Saved calculation parameters');
            } catch (e) {
                console.error('Error saving calculation parameters:', e);
            }
        }
        
        function showCalculationParametersDialog() {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.overflow = 'auto';
            overlay.style.padding = '20px';
            
            // Create dialog
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.padding = '24px';
            dialog.style.borderRadius = '8px';
            dialog.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
            dialog.style.minWidth = '600px';
            dialog.style.maxWidth = '800px';
            dialog.style.maxHeight = '90vh';
            dialog.style.overflow = 'auto';
            dialog.style.color = '#333';
            
            dialog.innerHTML = `
                <h3 style="color:#1a6b4f; margin-bottom:16px; font-size:18px; font-weight:700; display:flex; align-items:center; gap:8px;">
                    <i class="fas fa-cog"></i> Calculation Parameters
                </h3>
                <p style="font-size:12px; margin-bottom:16px; color:#555; line-height:1.5;">
                    Adjust the parameters used for handicap calculations. Changes will apply immediately to all calculators.
                </p>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
                    <div>
                        <h4 style="color:#2c5530; font-size:13px; margin-bottom:12px; border-bottom:2px solid #2c5530; padding-bottom:4px;">Threshold Parameters</h4>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Win Threshold (points)</label>
                            <input type="number" id="param-winThreshold" step="1" value="${golfParams.winThreshold}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                            <div style="font-size:9px; color:#666; margin-top:2px;">If won money AND scored > this value</div>
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">No Win Threshold (points)</label>
                            <input type="number" id="param-noWinThreshold" step="1" value="${golfParams.noWinThreshold}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                            <div style="font-size:9px; color:#666; margin-top:2px;">If no money AND scored < this value</div>
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Exceptional Threshold (points)</label>
                            <input type="number" id="param-exceptionalThreshold" step="1" value="${golfParams.exceptionalThreshold}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                            <div style="font-size:9px; color:#666; margin-top:2px;">If scored > this value (exceptional cut)</div>
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Max Index</label>
                            <input type="number" id="param-maxIndex" step="0.1" value="${golfParams.maxIndex}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Min Index</label>
                            <input type="number" id="param-minIndex" step="0.1" value="${golfParams.minIndex}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color:#2c5530; font-size:13px; margin-bottom:12px; border-bottom:2px solid #2c5530; padding-bottom:4px;">Cut/Increase Parameters</h4>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Cut Base</label>
                            <input type="number" id="param-cutBase" step="0.01" value="${golfParams.cutBase}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Cut Category Divisor</label>
                            <input type="number" id="param-cutCatDivisor" step="1" value="${golfParams.cutCatDivisor}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Cut Index Percent</label>
                            <input type="number" id="param-cutIndexPercent" step="0.001" value="${golfParams.cutIndexPercent}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Increase Index Percent</label>
                            <input type="number" id="param-incIndexPercent" step="0.001" value="${golfParams.incIndexPercent}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Increase Add Value</label>
                            <input type="number" id="param-incAddValue" step="0.01" value="${golfParams.incAddValue}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Increase Category Divisor</label>
                            <input type="number" id="param-incCatDivisor" step="1" value="${golfParams.incCatDivisor}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-bottom:20px;">
                    <div>
                        <h4 style="color:#2c5530; font-size:13px; margin-bottom:12px; border-bottom:2px solid #2c5530; padding-bottom:4px;">Exceptional Cut Parameters</h4>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Exceptional Category Divisor</label>
                            <input type="number" id="param-excCatDivisor" step="1" value="${golfParams.excCatDivisor}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Exceptional Index Percent</label>
                            <input type="number" id="param-excIndexPercent" step="0.0001" value="${golfParams.excIndexPercent}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                    </div>
                    
                    <div>
                        <h4 style="color:#2c5530; font-size:13px; margin-bottom:12px; border-bottom:2px solid #2c5530; padding-bottom:4px;">Category Boundaries</h4>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Category 1 Max</label>
                            <input type="number" id="param-cat1Max" step="0.1" value="${golfParams.cat1Max}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Category 2 Max</label>
                            <input type="number" id="param-cat2Max" step="0.1" value="${golfParams.cat2Max}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Category 3 Max</label>
                            <input type="number" id="param-cat3Max" step="0.1" value="${golfParams.cat3Max}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                        <div style="margin-bottom:10px;">
                            <label style="display:block; font-weight:600; font-size:11px; margin-bottom:4px; color:#333;">Category 4 Min</label>
                            <input type="number" id="param-cat4Min" step="0.1" value="${golfParams.cat4Min}" style="width:100%; padding:8px; font-size:12px; border:2px solid #1a6b4f; border-radius:4px;">
                        </div>
                    </div>
                </div>
                
                <div style="background-color:#e8f5e9; padding:12px; border-left:4px solid #4caf50; border-radius:4px; margin-bottom:20px; font-size:11px;">
                    <strong style="color:#2e7d32;">üí° Tip:</strong> Changes take effect immediately. All calculations will use the new parameters.
                </div>
                
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="resetParametersToDefaults()" style="padding:10px 20px; font-size:12px; background:#ff9800; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                    <button onclick="closeParametersDialog()" style="padding:10px 20px; font-size:12px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Cancel</button>
                    <button onclick="saveParametersFromDialog()" style="padding:10px 20px; font-size:12px; background:#1a6b4f; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">
                        <i class="fas fa-save"></i> Save Parameters
                    </button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            window.calculationParamsOverlay = overlay;
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeParametersDialog();
            });
        }
        
        function closeParametersDialog() {
            if (window.calculationParamsOverlay) {
                document.body.removeChild(window.calculationParamsOverlay);
                window.calculationParamsOverlay = null;
            }
        }
        
        function saveParametersFromDialog() {
            // Get all values from inputs
            golfParams.winThreshold = parseFloat(document.getElementById('param-winThreshold').value);
            golfParams.noWinThreshold = parseFloat(document.getElementById('param-noWinThreshold').value);
            golfParams.exceptionalThreshold = parseFloat(document.getElementById('param-exceptionalThreshold').value);
            golfParams.maxIndex = parseFloat(document.getElementById('param-maxIndex').value);
            golfParams.minIndex = parseFloat(document.getElementById('param-minIndex').value);
            golfParams.cutBase = parseFloat(document.getElementById('param-cutBase').value);
            golfParams.cutCatDivisor = parseFloat(document.getElementById('param-cutCatDivisor').value);
            golfParams.cutIndexPercent = parseFloat(document.getElementById('param-cutIndexPercent').value);
            golfParams.incIndexPercent = parseFloat(document.getElementById('param-incIndexPercent').value);
            golfParams.incAddValue = parseFloat(document.getElementById('param-incAddValue').value);
            golfParams.incCatDivisor = parseFloat(document.getElementById('param-incCatDivisor').value);
            golfParams.excCatDivisor = parseFloat(document.getElementById('param-excCatDivisor').value);
            golfParams.excIndexPercent = parseFloat(document.getElementById('param-excIndexPercent').value);
            golfParams.cat1Max = parseFloat(document.getElementById('param-cat1Max').value);
            golfParams.cat2Max = parseFloat(document.getElementById('param-cat2Max').value);
            golfParams.cat3Max = parseFloat(document.getElementById('param-cat3Max').value);
            golfParams.cat4Min = parseFloat(document.getElementById('param-cat4Min').value);
            
            // Save to localStorage
            saveCalculationParameters();
            
            // Close dialog
            closeParametersDialog();
            
            // Recalculate if golf calculator is active
            if (document.getElementById('golf-playerIndex')) {
                calculateGolfHandicap();
            }
            
            alert('Calculation parameters updated successfully!\n\nAll calculations will now use the new parameters.');
        }
        
        function resetParametersToDefaults() {
            if (!confirm('Reset all parameters to default values?\n\nThis will overwrite your current settings.')) {
                return;
            }
            
            // Reset to defaults
            Object.assign(golfParams, defaultGolfParams);
            
            // Update all input fields
            document.getElementById('param-winThreshold').value = golfParams.winThreshold;
            document.getElementById('param-noWinThreshold').value = golfParams.noWinThreshold;
            document.getElementById('param-exceptionalThreshold').value = golfParams.exceptionalThreshold;
            document.getElementById('param-maxIndex').value = golfParams.maxIndex;
            document.getElementById('param-minIndex').value = golfParams.minIndex;
            document.getElementById('param-cutBase').value = golfParams.cutBase;
            document.getElementById('param-cutCatDivisor').value = golfParams.cutCatDivisor;
            document.getElementById('param-cutIndexPercent').value = golfParams.cutIndexPercent;
            document.getElementById('param-incIndexPercent').value = golfParams.incIndexPercent;
            document.getElementById('param-incAddValue').value = golfParams.incAddValue;
            document.getElementById('param-incCatDivisor').value = golfParams.incCatDivisor;
            document.getElementById('param-excCatDivisor').value = golfParams.excCatDivisor;
            document.getElementById('param-excIndexPercent').value = golfParams.excIndexPercent;
            document.getElementById('param-cat1Max').value = golfParams.cat1Max;
            document.getElementById('param-cat2Max').value = golfParams.cat2Max;
            document.getElementById('param-cat3Max').value = golfParams.cat3Max;
            document.getElementById('param-cat4Min').value = golfParams.cat4Min;
            
            alert('Parameters reset to defaults!');
        }
        
        // ============================================
        // GOLF REPORT AUTO-APPEND FUNCTIONS
        // ============================================
        
        let golfReportData = [];
        
        function appendToGolfReport(playerData) {
            // Add player data to array
            golfReportData.push(playerData);
            
            // Update player count
            document.getElementById('golf-player-count').textContent = golfReportData.length;
        }
        
        function clearGolfReport() {
            if (golfReportData.length > 0 && !confirm(`Clear ${golfReportData.length} player(s) from the report?`)) {
                return;
            }
            golfReportData = [];
            document.getElementById('golf-player-count').textContent = '0';
        }
        
        function downloadGolfReport() {
            if (golfReportData.length === 0) {
                alert('No players calculated yet. Please calculate at least one player first.');
                return;
            }
            
            // Build TXT report in table format
            let txtContent = '';
            txtContent += '================================================================================\n';
            txtContent += 'GOLF HANDICAP CUT & INCREASE CALCULATOR REPORT\n';
            txtContent += `Season: Winter 2025-26\n`;
            txtContent += `Generated: ${new Date().toLocaleString()}\n`;
            txtContent += `Total Players: ${golfReportData.length}\n`;
            txtContent += '================================================================================\n\n';
            
            // Define column widths
            const colWidths = {
                name: 22,
                category: 10,
                prize: 8,
                stableford: 11,
                position: 11,
                teeColor: 10,
                prevIndex: 10,
                adjustment: 12,
                newIndex: 10,
                courseHcap: 12
            };
            
            // Table headers
            txtContent += 'Players Name'.padEnd(colWidths.name);
            txtContent += 'Category'.padEnd(colWidths.category);
            txtContent += 'Prize ¬£'.padEnd(colWidths.prize);
            txtContent += 'Stableford'.padEnd(colWidths.stableford);
            txtContent += 'Finishing'.padEnd(colWidths.position);
            txtContent += 'Tee Color'.padEnd(colWidths.teeColor);
            txtContent += 'Previous'.padEnd(colWidths.prevIndex);
            txtContent += 'Total'.padEnd(colWidths.adjustment);
            txtContent += 'New Index'.padEnd(colWidths.newIndex);
            txtContent += 'Course\n';
            
            // Second row of headers
            txtContent += ''.padEnd(colWidths.name);
            txtContent += ''.padEnd(colWidths.category);
            txtContent += ''.padEnd(colWidths.prize);
            txtContent += 'Points'.padEnd(colWidths.stableford);
            txtContent += 'Position'.padEnd(colWidths.position);
            txtContent += ''.padEnd(colWidths.teeColor);
            txtContent += 'Index'.padEnd(colWidths.prevIndex);
            txtContent += 'Adjustment'.padEnd(colWidths.adjustment);
            txtContent += ''.padEnd(colWidths.newIndex);
            txtContent += 'Handicap\n';
            
            // Separator line
            const totalWidth = Object.values(colWidths).reduce((a, b) => a + b, 0);
            txtContent += '-'.repeat(totalWidth) + '\n';
            
            // Add each player row
            golfReportData.forEach(player => {
                txtContent += player.name.substring(0, colWidths.name - 1).padEnd(colWidths.name);
                txtContent += `Cat ${player.category}`.padEnd(colWidths.category);
                txtContent += player.prizeMoney.toFixed(0).padEnd(colWidths.prize);
                txtContent += player.stablefordPoints.toFixed(0).padEnd(colWidths.stableford);
                const positionStr = player.finishingPosition ? player.finishingPosition.toString() : '-';
                txtContent += positionStr.padEnd(colWidths.position);
                txtContent += player.teeColor.padEnd(colWidths.teeColor);
                txtContent += player.previousIndex.toFixed(1).padEnd(colWidths.prevIndex);
                txtContent += player.totalAdjustment.toFixed(2).padEnd(colWidths.adjustment);
                txtContent += player.newIndex.toFixed(1).padEnd(colWidths.newIndex);
                txtContent += player.courseHandicap.toString() + '\n';
            });
            
            txtContent += '-'.repeat(totalWidth) + '\n';
            txtContent += `\nTotal Players Calculated: ${golfReportData.length}\n`;
            txtContent += '\nGenerated by Golf League Management System\n';
            txtContent += '================================================================================\n';
            
            // Download file
            const blob = new Blob([txtContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            a.download = `Golf_Handicap_Report_${timestamp}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`TXT report downloaded with ${golfReportData.length} player(s)!`);
        }
        
        function downloadGolfReportExcel() {
            if (golfReportData.length === 0) {
                alert('No players calculated yet. Please calculate at least one player first.');
                return;
            }
            
            // Build CSV content for Excel
            let csvContent = '';
            
            // Header rows
            csvContent += 'GOLF HANDICAP CUT & INCREASE CALCULATOR REPORT\n';
            csvContent += `Season: Winter 2025-26\n`;
            csvContent += `Generated: ${new Date().toLocaleString()}\n`;
            csvContent += `Total Players: ${golfReportData.length}\n`;
            csvContent += '\n';
            
            // Column headers
            csvContent += 'Players Name,Category,Prize ¬£,Stableford Points,Finishing Position,Tee Color,Previous Index,Total Adjustment,New Index,Course Handicap\n';
            
            // Add each player row
            golfReportData.forEach(player => {
                const positionStr = player.finishingPosition ? player.finishingPosition.toString() : '-';
                csvContent += `"${player.name}",`;
                csvContent += `"Cat ${player.category}",`;
                csvContent += `${player.prizeMoney.toFixed(0)},`;
                csvContent += `${player.stablefordPoints.toFixed(0)},`;
                csvContent += `"${positionStr}",`;
                csvContent += `"${player.teeColor}",`;
                csvContent += `${player.previousIndex.toFixed(1)},`;
                csvContent += `${player.totalAdjustment.toFixed(2)},`;
                csvContent += `${player.newIndex.toFixed(1)},`;
                csvContent += `${player.courseHandicap}\n`;
            });
            
            csvContent += '\n';
            csvContent += `Total Players Calculated: ${golfReportData.length}\n`;
            csvContent += 'Generated by Golf League Management System\n';
            
            // Download file as CSV with UTF-8 BOM for proper Excel encoding
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            a.download = `Golf_Handicap_Report_${timestamp}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            alert(`Excel CSV report downloaded with ${golfReportData.length} player(s)!`);
        }
        
        // ============================================
        // HCAP BATCH CALCULATOR TABLE (Winners tab -> Final Results)
        // ============================================
        
        let batchCalculatorDataByWeek = {}; // Stores data per week: {1: [...], 2: [...], ...}
        let currentBatchWeek = 1; // Currently selected week
        
        function initializeBatchWeekSelector() {
            const selector = document.getElementById('batchWeekSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            for (let i = 1; i <= 25; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `WK${i}`;
                if (i === currentBatchWeek) {
                    option.selected = true;
                }
                selector.appendChild(option);
            }
        }
        
        function calculateNewIndexFromData(playerIndex, prizeMoney, stablefordPoints, finishingPosition) {
            // Helper function to calculate new index from row data without DOM
            const category = calculateGolfIndexCategory(playerIndex);
            const hasPlayedRound = stablefordPoints > 0 || finishingPosition !== null;
            
            let stage1 = 0, stage2 = 0, stage3 = 0;
            
            if (hasPlayedRound) {
                if (prizeMoney > 0 && stablefordPoints > golfParams.winThreshold && finishingPosition) {
                    const baseCut = golfParams.cutBase + (category / golfParams.cutCatDivisor) + (playerIndex * golfParams.cutIndexPercent);
                    stage1 = - (baseCut / finishingPosition);
                }
                if (prizeMoney === 0 && stablefordPoints < golfParams.noWinThreshold && category > 0) {
                    stage2 = (playerIndex * golfParams.incIndexPercent) + golfParams.incAddValue + (category / golfParams.incCatDivisor);
                }
                if (stablefordPoints > golfParams.exceptionalThreshold) {
                    const pointsOver = stablefordPoints - golfParams.exceptionalThreshold;
                    stage3 = - ((category / golfParams.excCatDivisor) + (playerIndex * golfParams.excIndexPercent)) * pointsOver;
                }
            }
            
            const totalAdjustment = stage1 + stage2 + stage3;
            let newIndex = playerIndex + totalAdjustment;
            if (newIndex > golfParams.maxIndex) newIndex = golfParams.maxIndex;
            newIndex = Math.round(newIndex * 10) / 10;
            
            return newIndex;
        }
        
        function toggleResetWeeksDropdown() {
            const dropdown = document.getElementById('resetWeeksDropdown');
            const isShown = dropdown.classList.contains('show');
            
            // Close all other dropdowns first
            document.querySelectorAll('.best-scores-dropdown').forEach(d => d.classList.remove('show'));
            
            // Toggle this dropdown
            if (!isShown) {
                dropdown.classList.add('show');
            }
        }
        
        function resetBatchWeeks(mode) {
            // Close the dropdown
            document.getElementById('resetWeeksDropdown').classList.remove('show');
            
            if (mode === 'current') {
                // Reset current week only
                if (!confirm(`Reset WEEK ${currentBatchWeek}?\n\nThis will clear all data for this week only.\n\nThis action cannot be undone!`)) {
                    return;
                }
                
                // Clear current week data
                batchCalculatorDataByWeek[currentBatchWeek] = [];
                saveBatchCalculatorData();
                renderBatchCalculatorTable();
                alert(`Week ${currentBatchWeek} has been reset.`);
                
            } else if (mode === 'all') {
                // Reset all weeks
                if (!confirm('Reset ALL WEEKS (WK1-WK25)?\n\nThis will DELETE ALL batch calculator data for every week.\n\nThis action cannot be undone!')) {
                    return;
                }
                
                // Clear all weeks
                batchCalculatorDataByWeek = {};
                saveBatchCalculatorData();
                renderBatchCalculatorTable();
                alert('All weeks have been reset.');
                
            } else if (mode === 'range') {
                // Reset a range of weeks
                const startWeekStr = prompt('Enter starting week number (1-25):', '1');
                if (!startWeekStr) return;
                
                const startWeek = parseInt(startWeekStr);
                if (isNaN(startWeek) || startWeek < 1 || startWeek > 25) {
                    alert('Invalid week number. Please enter a number between 1 and 25.');
                    return;
                }
                
                const endWeekStr = prompt(`Enter ending week number (${startWeek}-25):`, startWeek.toString());
                if (!endWeekStr) return;
                
                const endWeek = parseInt(endWeekStr);
                if (isNaN(endWeek) || endWeek < startWeek || endWeek > 25) {
                    alert(`Invalid week number. Please enter a number between ${startWeek} and 25.`);
                    return;
                }
                
                if (!confirm(`Reset WEEKS ${startWeek} to ${endWeek}?\n\nThis will clear all data for these weeks.\n\nThis action cannot be undone!`)) {
                    return;
                }
                
                // Clear the specified range
                for (let week = startWeek; week <= endWeek; week++) {
                    batchCalculatorDataByWeek[week] = [];
                }
                
                saveBatchCalculatorData();
                renderBatchCalculatorTable();
                alert(`Weeks ${startWeek} to ${endWeek} have been reset.`);
            }
        }
        
        function resyncAllWeeks() {
            if (!confirm('This will update WK2-WK25 to inherit handicap indexes from previous weeks.\n\nWK1 data will be preserved.\nAll Prize/Stableford/Position data in each week will be preserved.\n\nContinue?')) {
                return;
            }
            
            console.log('=== Resyncing all weeks ===');
            
            // Start from week 2 and sync forward
            for (let week = 2; week <= 25; week++) {
                const prevWeek = week - 1;
                
                // Skip if previous week doesn't exist
                if (!batchCalculatorDataByWeek[prevWeek]) {
                    console.log(`Week ${prevWeek} doesn't exist, stopping sync at week ${week}`);
                    break;
                }
                
                // If this week doesn't exist, create it
                if (!batchCalculatorDataByWeek[week]) {
                    batchCalculatorDataByWeek[week] = [];
                }
                
                // Update each player's index from previous week's calculated new index
                batchCalculatorDataByWeek[prevWeek].forEach((prevData, idx) => {
                    // Ensure row exists
                    if (!batchCalculatorDataByWeek[week][idx]) {
                        batchCalculatorDataByWeek[week][idx] = {
                            index: '',
                            prize: 0,
                            stableford: '',
                            position: '',
                            teeWhite: true,
                            teeYellow: true
                        };
                    }
                    
                    // Calculate previous week's New Index and set as this week's starting Index
                    if (prevData.index && prevData.index !== '') {
                        const playerIndex = parseFloat(prevData.index) || 0;
                        const prizeMoney = parseFloat(prevData.prize) || 0;
                        const stablefordPoints = parseFloat(prevData.stableford) || 0;
                        const finishingPosition = parseInt(prevData.position) || null;
                        
                        const newIndex = calculateNewIndexFromData(playerIndex, prizeMoney, stablefordPoints, finishingPosition);
                        batchCalculatorDataByWeek[week][idx].index = newIndex.toString();
                    }
                });
            }
            
            saveBatchCalculatorData();
            renderBatchCalculatorTable();
            alert('All weeks resynced successfully!\n\nHandicap indexes have been updated from WK1 through to the last week with data.');
        }
        
        function changeBatchWeek() {
            const selector = document.getElementById('batchWeekSelector');
            const newWeek = parseInt(selector.value);
            
            // Save selected week to localStorage
            localStorage.setItem('currentBatchWeek', newWeek.toString());
            
            console.log(`=== Changing from week ${currentBatchWeek} to week ${newWeek} ===`);
            console.log('Current data structure:', JSON.parse(JSON.stringify(batchCalculatorDataByWeek)));
            
            // IMPORTANT: Check if week exists BEFORE changing currentBatchWeek
            // If switching to a new week that doesn't have data yet, initialize from previous week
            if (!batchCalculatorDataByWeek[newWeek] && newWeek > 1) {
                const prevWeek = newWeek - 1;
                console.log(`Week ${newWeek} not found, checking if week ${prevWeek} exists...`);
                if (batchCalculatorDataByWeek[prevWeek]) {
                    console.log(`Found week ${prevWeek} data, initializing week ${newWeek}...`);
                    // Initialize new week with empty data structure
                    batchCalculatorDataByWeek[newWeek] = [];
                    
                    // Copy data from previous week and use their calculated New Index as starting Index
                    let copiedCount = 0;
                    batchCalculatorDataByWeek[prevWeek].forEach((prevData, idx) => {
                        batchCalculatorDataByWeek[newWeek][idx] = {
                            index: '',
                            prize: 0,
                            stableford: '',
                            position: '',
                            teeWhite: prevData.teeWhite !== false,
                            teeYellow: prevData.teeYellow !== false
                        };
                        
                        // Use previous week's New Index (calculated result) as this week's starting Index
                        if (prevData.index && prevData.index !== '') {
                            const playerIndex = parseFloat(prevData.index) || 0;
                            const prizeMoney = parseFloat(prevData.prize) || 0;
                            const stablefordPoints = parseFloat(prevData.stableford) || 0;
                            const finishingPosition = parseInt(prevData.position) || null;
                            
                            // Calculate the New Index from previous week's data
                            const newIndex = calculateNewIndexFromData(playerIndex, prizeMoney, stablefordPoints, finishingPosition);
                            
                            // Set previous week's calculated New Index as this week's starting Index
                            batchCalculatorDataByWeek[newWeek][idx].index = newIndex.toString();
                            copiedCount++;
                            console.log(`  Player ${idx} (${leaguePlayers[idx].name}): WK${prevWeek} New Index ${newIndex.toFixed(1)} -> WK${newWeek} Players Index`);
                        }
                    });
                    
                    saveBatchCalculatorData();
                    console.log(`‚úì Initialized Week ${newWeek} with ${copiedCount} player indexes from Week ${prevWeek}`);
                } else {
                    console.log(`Week ${prevWeek} has no data, cannot initialize week ${newWeek}`);
                }
            } else if (batchCalculatorDataByWeek[newWeek]) {
                console.log(`Week ${newWeek} already exists with data`);
            } else {
                console.log(`Week ${newWeek} is week 1 or has no previous week`);
            }
            
            // Ensure week exists before switching (for week 1 on first load)
            if (!batchCalculatorDataByWeek[newWeek]) {
                console.log(`Initializing empty week ${newWeek}`);
                batchCalculatorDataByWeek[newWeek] = [];
            }
            
            currentBatchWeek = newWeek;
            renderBatchCalculatorTable();
            console.log('‚úì Switched to batch calculator week:', currentBatchWeek);
        }
        
        function updateBatchLastImportLabel(weekNumber, playerCount) {
            const weekLabel = document.getElementById('batch-last-import-label');
            const countLabel = document.getElementById('batch-player-count-label');
            
            if (weekLabel && weekNumber) {
                weekLabel.textContent = `Data: WK${weekNumber}`;
                weekLabel.style.display = 'inline-block';
                localStorage.setItem('batchLastImportWeek', weekNumber.toString());
            }
            
            if (countLabel && playerCount !== undefined) {
                countLabel.textContent = `${playerCount} Players`;
                countLabel.style.display = 'inline-block';
                localStorage.setItem('batchLastImportPlayerCount', playerCount.toString());
            }
        }
        
        function loadBatchLastImportLabel() {
            const savedWeek = localStorage.getItem('batchLastImportWeek');
            const savedCount = localStorage.getItem('batchLastImportPlayerCount');
            if (savedWeek) {
                updateBatchLastImportLabel(parseInt(savedWeek), savedCount ? parseInt(savedCount) : undefined);
            }
        }
        
        function loadBatchCalculatorData() {
            const saved = localStorage.getItem('batchCalculatorDataByWeek');
            if (saved) {
                try {
                    batchCalculatorDataByWeek = JSON.parse(saved);
                    console.log('Loaded batch calculator data for all weeks');
                } catch (e) {
                    console.error('Error loading batch calculator data:', e);
                    batchCalculatorDataByWeek = {};
                }
            } else {
                console.log('No saved batch calculator data found');
                batchCalculatorDataByWeek = {};
            }
            
            // Load last selected week
            const savedWeek = localStorage.getItem('currentBatchWeek');
            if (savedWeek) {
                currentBatchWeek = parseInt(savedWeek);
            }
            
            // Load the last import label
            loadBatchLastImportLabel();
            
            // Load the sort state
            loadBatchSortState();
        }
        
        function saveBatchCalculatorData() {
            try {
                localStorage.setItem('batchCalculatorDataByWeek', JSON.stringify(batchCalculatorDataByWeek));
                console.log('Saved batch calculator data for week:', currentBatchWeek);
            } catch (e) {
                console.error('Error saving batch calculator data:', e);
            }
        }
        
        function renderBatchCalculatorTable() {
            const tbody = document.getElementById('batch-calculator-body');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            // Get current week's data - it should already be initialized by changeBatchWeek or loadBatchCalculatorData
            // Don't auto-create here as it will bypass the week initialization logic
            if (!batchCalculatorDataByWeek[currentBatchWeek]) {
                console.warn(`Week ${currentBatchWeek} data not found, initializing empty array`);
                batchCalculatorDataByWeek[currentBatchWeek] = [];
            }
            
            let batchCalculatorData = batchCalculatorDataByWeek[currentBatchWeek];
            
            // Store current sort state indicator before clearing
            const currentSortIndicator = batchSortColumn >= 0 ? document.getElementById(`batch-sort-${batchSortColumn}`)?.textContent : null;
            
            // Ensure data array has 40 entries
            while (batchCalculatorData.length < leaguePlayers.length) {
                batchCalculatorData.push({
                    index: '',
                    prize: 0,
                    stableford: '',
                    position: '',
                    teeWhite: true,
                    teeYellow: true
                });
            }
            
            // Build 40 default rows from leaguePlayers
            leaguePlayers.forEach((player, idx) => {
                const rowData = batchCalculatorData[idx] || {};
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="text-align:center;">${idx + 1}</td>
                    <td style="text-align:left; padding-left:8px; font-weight:600; color:#0a3d2e;">${player.name}</td>
                    <td><input type="number" step="0.1" data-row="${idx}" data-field="index" class="batch-input" style="width:70px; text-align:center;" value="${rowData.index || ''}"></td>
                    <td id="batch-cat-${idx}" style="font-weight:700;"></td>
                    <td><input type="number" step="1" min="0" data-row="${idx}" data-field="prize" class="batch-input" style="width:70px; text-align:center;" value="${rowData.prize || 0}"></td>
                    <td><input type="number" step="1" min="0" max="50" data-row="${idx}" data-field="stableford" class="batch-input" style="width:70px; text-align:center;" value="${rowData.stableford || ''}"></td>
                    <td><input type="number" step="1" min="1" data-row="${idx}" data-field="position" class="batch-input" style="width:70px; text-align:center;" value="${rowData.position || ''}"></td>
                    <td style="text-align:center;">
                        <input type="checkbox" data-row="${idx}" data-field="teeWhite" class="batch-input" ${rowData.teeWhite !== false ? 'checked' : ''}>
                    </td>
                    <td style="text-align:center;">
                        <input type="checkbox" data-row="${idx}" data-field="teeYellow" class="batch-input" ${rowData.teeYellow !== false ? 'checked' : ''}>
                    </td>
                    <td id="batch-prev-${idx}">-</td>
                    <td id="batch-adj-${idx}">0.00</td>
                    <td id="batch-new-${idx}">-</td>
                    <td id="batch-ch-white-${idx}">-</td>
                    <td id="batch-ch-yellow-${idx}">-</td>
                `;
                tbody.appendChild(tr);
                
                // Recalculate row if it has data
                if (rowData.index && rowData.index !== '') {
                    setTimeout(() => recalcBatchRow(idx), 0);
                }
            });
            
            // Reapply sort if it was active before (including after page load)
            if (batchSortColumn >= 0) {
                // Re-sort the table after rendering
                setTimeout(() => {
                    // Restore sort indicators first
                    const indicator = document.getElementById(`batch-sort-${batchSortColumn}`);
                    if (indicator) {
                        indicator.textContent = batchSortAscending ? ' ‚ñ≤' : ' ‚ñº';
                    }
                    // Then sort the rows
                    sortBatchTableRows();
                }, 10);
            }
            
            // Attach listeners after rendering
            document.querySelectorAll('#batch-calculator-body .batch-input').forEach(el => {
                // Use both 'change' and 'input' events to catch all updates
                const updateHandler = () => {
                    const row = parseInt(el.getAttribute('data-row'));
                    const field = el.getAttribute('data-field');
                    
                    // Get current week's data
                    let batchCalculatorData = batchCalculatorDataByWeek[currentBatchWeek];
                    
                    // Ensure row exists in data array
                    if (!batchCalculatorData[row]) {
                        batchCalculatorData[row] = {
                            index: '',
                            prize: 0,
                            stableford: '',
                            position: '',
                            teeWhite: true,
                            teeYellow: true
                        };
                    }
                    
                    // Save the value
                    if (field === 'teeWhite' || field === 'teeYellow') {
                        batchCalculatorData[row][field] = el.checked;
                    } else {
                        batchCalculatorData[row][field] = el.value;
                    }
                    
                    console.log(`Saving week ${currentBatchWeek}, row ${row}, field ${field}:`, el.type === 'checkbox' ? el.checked : el.value);
                    saveBatchCalculatorData();
                    recalcBatchRow(row);
                };
                
                el.addEventListener('change', updateHandler);
                el.addEventListener('input', updateHandler);
                
                // Add Enter key navigation for input fields
                if (el.type === 'number') {
                    el.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const currentField = el.getAttribute('data-field');
                            
                            // Find current cell's parent row
                            const currentCell = el.closest('td');
                            const currentRow = currentCell.closest('tr');
                            
                            // Find the next row in the current visual order
                            const nextRow = currentRow.nextElementSibling;
                            
                            if (nextRow) {
                                // Find the input with the same field in the next row
                                const nextInput = nextRow.querySelector(`[data-field="${currentField}"]`);
                                if (nextInput) {
                                    nextInput.focus();
                                    nextInput.select();
                                }
                            }
                        }
                    });
                }
            });
        }
        
        function recalcBatchRow(idx) {
            const indexEl = document.querySelector(`#batch-calculator-body [data-row="${idx}"][data-field="index"]`);
            const prizeEl = document.querySelector(`#batch-calculator-body [data-row="${idx}"][data-field="prize"]`);
            const pointsEl = document.querySelector(`#batch-calculator-body [data-row="${idx}"][data-field="stableford"]`);
            const posEl = document.querySelector(`#batch-calculator-body [data-row="${idx}"][data-field="position"]`);
            if (!indexEl || !prizeEl || !pointsEl || !posEl) return;
            
            const playerIndex = parseFloat(indexEl.value) || 0;
            const prizeMoney = parseFloat(prizeEl.value) || 0;
            const stablefordPoints = parseFloat(pointsEl.value) || 0;
            const finishingPosition = parseInt(posEl.value) || null;
            
            // Previous index mirrors Players Index for batch calc
            document.getElementById(`batch-prev-${idx}`).textContent = playerIndex.toFixed(1);
            
            // Category
            const category = calculateGolfIndexCategory(playerIndex);
            const catCell = document.getElementById(`batch-cat-${idx}`);
            if (catCell) catCell.textContent = `Cat ${category}`;
            
            // Check if player has played (has stableford points or position entered)
            const hasPlayedRound = stablefordPoints > 0 || finishingPosition !== null;
            
            // Stage calculations (same rules as single calculator, no manual adjustment here)
            let stage1 = 0;
            let stage2 = 0;
            let stage3 = 0;
            
            // Only calculate adjustments if player has played
            if (hasPlayedRound) {
                if (prizeMoney > 0 && stablefordPoints > golfParams.winThreshold && finishingPosition) {
                    const baseCut = golfParams.cutBase + (category / golfParams.cutCatDivisor) + (playerIndex * golfParams.cutIndexPercent);
                    stage1 = - (baseCut / finishingPosition);
                }
                if (prizeMoney === 0 && stablefordPoints < golfParams.noWinThreshold && category > 0) {
                    stage2 = (playerIndex * golfParams.incIndexPercent) + golfParams.incAddValue + (category / golfParams.incCatDivisor);
                }
                if (stablefordPoints > golfParams.exceptionalThreshold) {
                    const pointsOver = stablefordPoints - golfParams.exceptionalThreshold;
                    stage3 = - ((category / golfParams.excCatDivisor) + (playerIndex * golfParams.excIndexPercent)) * pointsOver;
                }
            }
            
            const totalAdjustment = stage1 + stage2 + stage3;
            const adjCell = document.getElementById(`batch-adj-${idx}`);
            adjCell.textContent = totalAdjustment.toFixed(2);
            
            // Color formatting: negative = red (handicap cut), positive = green (handicap increase)
            if (totalAdjustment < 0) {
                adjCell.style.color = '#d32f2f';
                adjCell.style.fontWeight = '700';
            } else if (totalAdjustment > 0) {
                adjCell.style.color = '#2e7d32';
                adjCell.style.fontWeight = '700';
            } else {
                adjCell.style.color = '#333';
                adjCell.style.fontWeight = 'normal';
            }
            
            // New index (cap at max)
            let newIndex = playerIndex + totalAdjustment;
            if (newIndex > golfParams.maxIndex) newIndex = golfParams.maxIndex;
            newIndex = Math.round(newIndex * 10) / 10;
            document.getElementById(`batch-new-${idx}`).textContent = newIndex.toFixed(1);
            
            // Course handicaps - always calculate both White and Yellow
            const whiteHandicap = Math.round((newIndex * golfCourses.White.slope / 113) + (golfCourses.White.rating - golfCourses.White.par));
            const yellowHandicap = Math.round((newIndex * golfCourses.Yellow.slope / 113) + (golfCourses.Yellow.rating - golfCourses.Yellow.par));
            document.getElementById(`batch-ch-white-${idx}`).textContent = whiteHandicap.toString();
            document.getElementById(`batch-ch-yellow-${idx}`).textContent = yellowHandicap.toString();
        }
        
        function recalcAllBatchRows() {
            const rowCount = leaguePlayers.length;
            for (let i = 0; i < rowCount; i++) recalcBatchRow(i);
        }
        
        // ============================================
        // IMPORT STABLEFORD SCORES TO BATCH CALCULATOR
        // ============================================
        
        function showImportStblfdScoreDialog() {
            // Build list of available weeks
            let weekOptions = '';
            for (let i = 1; i <= 25; i++) {
                weekOptions += `<option value="${i}">Week ${i}</option>`;
            }
            
            // Create a temporary modal/dialog
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.padding = '24px';
            dialog.style.borderRadius = '8px';
            dialog.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
            dialog.style.minWidth = '400px';
            dialog.style.maxWidth = '500px';
            dialog.style.color = '#333';
            
            dialog.innerHTML = `
                <h3 style="color:#1a6b4f; margin-bottom:12px; font-size:16px;">Import Stableford Scores</h3>
                <p style="font-size:12px; margin-bottom:12px; color:#555;">Select which week to import scores from:</p>
                <select id="import-week-selector" style="width:100%; padding:12px; font-size:14px; line-height:1.6; height:48px; margin-bottom:20px; border:2px solid #1a6b4f; border-radius:4px; background-color:white; cursor:pointer; box-sizing:border-box;">
                    ${weekOptions}
                </select>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="closeImportDialog()" style="padding:8px 16px; font-size:12px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Cancel</button>
                    <button onclick="importStblfdScoresFromWeek()" style="padding:8px 16px; font-size:12px; background:#1a6b4f; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Import</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Store reference to close later
            window.batchImportOverlay = overlay;
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeImportDialog();
            });
        }
        
        function closeImportDialog() {
            if (window.batchImportOverlay) {
                document.body.removeChild(window.batchImportOverlay);
                window.batchImportOverlay = null;
            }
        }
        
        // ============================================
        // BATCH CALCULATOR TABLE SORTING
        // ============================================
        
        let batchSortColumn = -1;
        let batchSortAscending = true;
        
        function saveBatchSortState() {
            try {
                localStorage.setItem('batchSortColumn', batchSortColumn.toString());
                localStorage.setItem('batchSortAscending', batchSortAscending.toString());
            } catch (e) {
                console.error('Error saving batch sort state:', e);
            }
        }
        
        function loadBatchSortState() {
            try {
                const savedColumn = localStorage.getItem('batchSortColumn');
                const savedAscending = localStorage.getItem('batchSortAscending');
                
                if (savedColumn !== null) {
                    batchSortColumn = parseInt(savedColumn);
                }
                if (savedAscending !== null) {
                    batchSortAscending = savedAscending === 'true';
                }
                
                console.log('Loaded batch sort state:', { batchSortColumn, batchSortAscending });
            } catch (e) {
                console.error('Error loading batch sort state:', e);
            }
        }
        
        function sortBatchTable(columnIndex) {
            // Toggle sort direction if clicking same column
            if (batchSortColumn === columnIndex) {
                batchSortAscending = !batchSortAscending;
            } else {
                batchSortColumn = columnIndex;
                batchSortAscending = true;
            }
            
            // Clear all sort indicators
            for (let i = 0; i <= 13; i++) {
                const indicator = document.getElementById(`batch-sort-${i}`);
                if (indicator) indicator.textContent = '';
            }
            
            // Set current sort indicator
            const currentIndicator = document.getElementById(`batch-sort-${columnIndex}`);
            if (currentIndicator) {
                currentIndicator.textContent = batchSortAscending ? ' ‚ñ≤' : ' ‚ñº';
            }
            
            // Perform the actual sort
            sortBatchTableRows();
            
            // Save sort state to localStorage
            saveBatchSortState();
        }
        
        function sortBatchTableRows() {
            const tbody = document.getElementById('batch-calculator-body');
            if (!tbody) return;
            
            const rows = Array.from(tbody.querySelectorAll('tr'));
            if (rows.length === 0) return;
            
            // Sort rows
            rows.sort((a, b) => {
                let aVal, bVal;
                
                switch(batchSortColumn) {
                    case 0: // No
                        aVal = parseInt(a.cells[0].textContent);
                        bVal = parseInt(b.cells[0].textContent);
                        break;
                    case 1: // Player Name
                        aVal = a.cells[1].textContent.trim();
                        bVal = b.cells[1].textContent.trim();
                        return batchSortAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    case 2: // Players Index
                        aVal = parseFloat(a.cells[2].querySelector('input').value) || 0;
                        bVal = parseFloat(b.cells[2].querySelector('input').value) || 0;
                        break;
                    case 3: // Index Category
                        aVal = a.cells[3].textContent.trim();
                        bVal = b.cells[3].textContent.trim();
                        return batchSortAscending ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                    case 4: // Prize Money Won
                        aVal = parseFloat(a.cells[4].querySelector('input').value) || 0;
                        bVal = parseFloat(b.cells[4].querySelector('input').value) || 0;
                        break;
                    case 5: // Stableford Points Scored
                        aVal = parseFloat(a.cells[5].querySelector('input').value) || 0;
                        bVal = parseFloat(b.cells[5].querySelector('input').value) || 0;
                        break;
                    case 6: // Swindle Finishing Position
                        aVal = parseFloat(a.cells[6].querySelector('input').value) || 999;
                        bVal = parseFloat(b.cells[6].querySelector('input').value) || 999;
                        break;
                    case 9: // Players Previous Index
                        aVal = parseFloat(a.cells[9].textContent) || 0;
                        bVal = parseFloat(b.cells[9].textContent) || 0;
                        break;
                    case 10: // Total Adjustment
                        aVal = parseFloat(a.cells[10].textContent) || 0;
                        bVal = parseFloat(b.cells[10].textContent) || 0;
                        break;
                    case 11: // Players New Index
                        aVal = parseFloat(a.cells[11].textContent) || 0;
                        bVal = parseFloat(b.cells[11].textContent) || 0;
                        break;
                    case 12: // Course Handicap (White)
                        aVal = parseFloat(a.cells[12].textContent) || 0;
                        bVal = parseFloat(b.cells[12].textContent) || 0;
                        break;
                    case 13: // Course Handicap (Yellow)
                        aVal = parseFloat(a.cells[13].textContent) || 0;
                        bVal = parseFloat(b.cells[13].textContent) || 0;
                        break;
                    default:
                        return 0;
                }
                
                // Numeric comparison
                if (batchSortAscending) {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });
            
            // Re-append rows in sorted order
            rows.forEach(row => tbody.appendChild(row));
        }
        
        // ============================================
        // COPY WEEK DATA FUNCTIONALITY
        // ============================================
        
        function showCopyWeekDataDialog() {
            // Build list of available weeks
            let weekOptions = '';
            for (let i = 1; i <= 25; i++) {
                weekOptions += `<option value="${i}" style="color:#333;">WK${i}</option>`;
            }
            
            // Create a temporary modal/dialog
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.padding = '24px';
            dialog.style.borderRadius = '8px';
            dialog.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
            dialog.style.minWidth = '450px';
            dialog.style.maxWidth = '550px';
            dialog.style.color = '#333';
            
            dialog.innerHTML = `
                <h3 style="color:#1a6b4f; margin-bottom:16px; font-size:18px; font-weight:700;">Copy Week Data</h3>
                <p style="font-size:12px; margin-bottom:16px; color:#555; line-height:1.5;">
                    This will copy <strong>Players New Index</strong> from the source week to <strong>Players Index</strong> in the destination week.
                    This operation only affects selected weeks.
                </p>
                <div style="display:grid; grid-template-columns:1fr auto 1fr; gap:12px; align-items:center; margin-bottom:20px;">
                    <div>
                        <label style="display:block; font-weight:600; font-size:11px; margin-bottom:6px; color:#2c5530;">From Week:</label>
                        <select id="copy-from-week" style="width:100%; padding:10px; font-size:13px; border:2px solid #1a6b4f; border-radius:4px; background-color:white; color:#333; cursor:pointer;">
                            ${weekOptions}
                        </select>
                    </div>
                    <div style="text-align:center; padding-top:20px;">
                        <i class="fas fa-arrow-right" style="font-size:20px; color:#1a6b4f;"></i>
                    </div>
                    <div>
                        <label style="display:block; font-weight:600; font-size:11px; margin-bottom:6px; color:#2c5530;">Copy to Week:</label>
                        <select id="copy-to-week" style="width:100%; padding:10px; font-size:13px; border:2px solid #1a6b4f; border-radius:4px; background-color:white; color:#333; cursor:pointer;">
                            ${weekOptions}
                        </select>
                    </div>
                </div>
                <div style="background-color:#fff8e1; padding:12px; border-left:4px solid #ff9800; border-radius:4px; margin-bottom:20px; font-size:11px;">
                    <strong style="color:#e65100;">‚ö†Ô∏è Warning:</strong> This will overwrite the <strong>Players Index</strong> column in the destination week. Prize Money, Stableford Points, and Finishing Position will NOT be affected.
                </div>
                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button onclick="closeCopyWeekDialog()" style="padding:10px 20px; font-size:12px; background:#6c757d; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;">Cancel</button>
                    <button onclick="executeCopyWeekData()" style="padding:10px 20px; font-size:12px; background:#1a6b4f; color:white; border:none; border-radius:4px; cursor:pointer; font-weight:600;"><i class="fas fa-copy"></i> Copy Data</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Store reference to close later
            window.copyWeekOverlay = overlay;
            
            // Set default values with a slight delay to ensure DOM is ready
            setTimeout(() => {
                const fromWeekSelect = document.getElementById('copy-from-week');
                const toWeekSelect = document.getElementById('copy-to-week');
                
                // Default: from current week, to next week
                if (fromWeekSelect) {
                    fromWeekSelect.value = currentBatchWeek.toString();
                    console.log('Set From Week to:', currentBatchWeek);
                }
                if (toWeekSelect && currentBatchWeek < 25) {
                    toWeekSelect.value = (currentBatchWeek + 1).toString();
                    console.log('Set To Week to:', currentBatchWeek + 1);
                }
            }, 10);
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeCopyWeekDialog();
            });
        }
        
        function closeCopyWeekDialog() {
            if (window.copyWeekOverlay) {
                document.body.removeChild(window.copyWeekOverlay);
                window.copyWeekOverlay = null;
            }
        }
        
        function executeCopyWeekData() {
            const fromWeekSelect = document.getElementById('copy-from-week');
            const toWeekSelect = document.getElementById('copy-to-week');
            
            if (!fromWeekSelect || !toWeekSelect) return;
            
            const fromWeek = parseInt(fromWeekSelect.value);
            const toWeek = parseInt(toWeekSelect.value);
            
            // Validation
            if (fromWeek === toWeek) {
                alert('Source and destination weeks must be different.');
                return;
            }
            
            // Check if source week has data
            if (!batchCalculatorDataByWeek[fromWeek] || batchCalculatorDataByWeek[fromWeek].length === 0) {
                alert(`Week ${fromWeek} has no data to copy from.`);
                return;
            }
            
            // Confirm action
            if (!confirm(`Copy Players New Index from WK${fromWeek} to Players Index in WK${toWeek}?\n\nThis will overwrite the Players Index column in WK${toWeek}.`)) {
                return;
            }
            
            // Initialize destination week if needed
            if (!batchCalculatorDataByWeek[toWeek]) {
                batchCalculatorDataByWeek[toWeek] = [];
            }
            
            const sourceData = batchCalculatorDataByWeek[fromWeek];
            const destData = batchCalculatorDataByWeek[toWeek];
            
            let copiedCount = 0;
            
            // Copy Players New Index to Players Index
            leaguePlayers.forEach((player, idx) => {
                // Ensure destination row exists
                if (!destData[idx]) {
                    destData[idx] = {
                        index: '',
                        prize: 0,
                        stableford: '',
                        position: '',
                        teeWhite: true,
                        teeYellow: true
                    };
                }
                
                // Get source player's data
                const sourcePlayer = sourceData[idx];
                if (sourcePlayer && sourcePlayer.index && sourcePlayer.index !== '') {
                    // Calculate the New Index from source week
                    const playerIndex = parseFloat(sourcePlayer.index) || 0;
                    const prizeMoney = parseFloat(sourcePlayer.prize) || 0;
                    const stablefordPoints = parseFloat(sourcePlayer.stableford) || 0;
                    const finishingPosition = parseInt(sourcePlayer.position) || null;
                    
                    // Calculate new index from source data
                    const newIndex = calculateNewIndexFromData(playerIndex, prizeMoney, stablefordPoints, finishingPosition);
                    
                    // Copy to destination Players Index
                    destData[idx].index = newIndex.toString();
                    copiedCount++;
                }
            });
            
            // Save and re-render
            saveBatchCalculatorData();
            
            // Close dialog
            closeCopyWeekDialog();
            
            // Switch to destination week to show results
            const batchWeekSelector = document.getElementById('batchWeekSelector');
            if (batchWeekSelector) {
                batchWeekSelector.value = toWeek.toString();
                currentBatchWeek = toWeek;
                renderBatchCalculatorTable();
            }
            
            alert(`Successfully copied ${copiedCount} player indexes from WK${fromWeek} to WK${toWeek}.`);
        }
        
        function importStblfdScoresFromWeek() {
            const weekSelector = document.getElementById('import-week-selector');
            if (!weekSelector) return;
            
            const selectedWeek = parseInt(weekSelector.value);
            const weekKey = `week${selectedWeek}`;
            const weekScorecardData = allWeeksScorecardData[weekKey];
            
            if (!weekScorecardData || !weekScorecardData.players || weekScorecardData.players.length === 0) {
                alert(`No scorecard data found for Week ${selectedWeek}.\n\nPlease add players to the Scorecard tab first.`);
                return;
            }
            
            // Get current week's data array
            if (!batchCalculatorDataByWeek[currentBatchWeek]) {
                batchCalculatorDataByWeek[currentBatchWeek] = [];
            }
            const currentWeekData = batchCalculatorDataByWeek[currentBatchWeek];
            
            // Clear all stableford scores first, but preserve prize money and positions
            leaguePlayers.forEach((player, idx) => {
                const pointsEl = document.querySelector(`#batch-calculator-body [data-row="${idx}"][data-field="stableford"]`);
                if (pointsEl) pointsEl.value = '';
                
                if (currentWeekData[idx]) {
                    currentWeekData[idx].stableford = '';
                }
                // Recalc to update calculated fields
                recalcBatchRow(idx);
            });
            
            // Build a map of player name -> stableford score
            const stablefordMap = new Map();
            
            weekScorecardData.players.forEach(player => {
                let stablefordTotal = 0;
                
                // Calculate stableford score
                for (let hole = 0; hole < 18; hole++) {
                    const score = parseInt(player.scores[hole]) || 0;
                    if (score > 0) {
                        const par = globalParValues[hole] || 4;
                        const playerHandicap = (player.whiteTees !== undefined && player.whiteTees !== null && player.whiteTees !== '') 
                            ? parseFloat(player.whiteTees) 
                            : (parseFloat(player.handicap) || 0);
                        const holeIndex = globalIndexValues[hole] || (hole + 1);
                        
                        const strokesReceived = calculateStrokesForHole(playerHandicap, holeIndex);
                        const adjustedPar = par + strokesReceived;
                        const diff = score - adjustedPar;
                        
                        let points = 0;
                        if (diff <= -2) points = 4;
                        else if (diff === -1) points = 3;
                        else if (diff === 0) points = 2;
                        else if (diff === 1) points = 1;
                        
                        stablefordTotal += points;
                    }
                }
                
                stablefordMap.set(player.name.toLowerCase().trim(), stablefordTotal);
            });
            
            // Now populate batch calculator stableford fields for matching players
            let importedCount = 0;
            const unmatchedScorecard = [];
            const unmatchedBatch = [];
            
            // Track which scorecard players were matched
            const matchedScorecardNames = new Set();
            
            leaguePlayers.forEach((player, idx) => {
                const playerNameKey = player.name.toLowerCase().trim();
                if (stablefordMap.has(playerNameKey)) {
                    const stablefordScore = stablefordMap.get(playerNameKey);
                    const pointsEl = document.querySelector(`#batch-calculator-body [data-row="${idx}"][data-field="stableford"]`);
                    if (pointsEl) {
                        pointsEl.value = stablefordScore;
                        
                        // Save to data array
                        if (!currentWeekData[idx]) {
                            currentWeekData[idx] = {
                                index: '',
                                prize: 0,
                                stableford: '',
                                position: '',
                                teeWhite: true,
                                teeYellow: true
                            };
                        }
                        currentWeekData[idx].stableford = stablefordScore;
                        
                        importedCount++;
                        matchedScorecardNames.add(playerNameKey);
                        // Trigger recalc for this row
                        recalcBatchRow(idx);
                    }
                }
            });
            
            // Find unmatched scorecard players
            weekScorecardData.players.forEach(player => {
                const key = player.name.toLowerCase().trim();
                if (!matchedScorecardNames.has(key)) {
                    unmatchedScorecard.push(player.name);
                }
            });
            
            // Save all data to localStorage
            saveBatchCalculatorData();
            
            // Update the last import label with week and player count
            updateBatchLastImportLabel(selectedWeek, importedCount);
            
            closeImportDialog();
            
            let message = `Imported ${importedCount} Stableford scores from Week ${selectedWeek}.`;
            if (unmatchedScorecard.length > 0) {
                message += `\n\n‚ö†Ô∏è ${unmatchedScorecard.length} player(s) from Scorecard not found in Batch Calculator:\n${unmatchedScorecard.join('\n')}`;
                message += `\n\nThese names must match exactly (ignoring case) with the 40 default player names in the Batch Calculator.`;
            }
            alert(message);
        }
        
        // ============================================
        // BATCH CALCULATOR REPORT GENERATION
        // ============================================
        
        function showBatchReportDialog() {
            // Create a temporary modal/dialog
            const overlay = document.createElement('div');
            overlay.style.position = 'fixed';
            overlay.style.top = '0';
            overlay.style.left = '0';
            overlay.style.width = '100%';
            overlay.style.height = '100%';
            overlay.style.backgroundColor = 'rgba(0,0,0,0.6)';
            overlay.style.zIndex = '9999';
            overlay.style.display = 'flex';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            
            const dialog = document.createElement('div');
            dialog.style.backgroundColor = 'white';
            dialog.style.padding = '20px';
            dialog.style.borderRadius = '6px';
            dialog.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
            dialog.style.minWidth = '300px';
            dialog.style.color = '#333';
            
            dialog.innerHTML = `
                <h3 style="color:#1a6b4f; margin-bottom:12px; font-size:14px;">Generate HCAP Batch Report</h3>
                <p style="font-size:11px; margin-bottom:12px;">Select report format:</p>
                <div style="display:flex; gap:8px; justify-content:center; margin-bottom:16px;">
                    <button onclick="downloadBatchReportExcel()" style="padding:8px 16px; font-size:11px; background:#28a745; color:white; border:none; border-radius:3px; cursor:pointer; display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-file-excel"></i> Excel (CSV)
                    </button>
                    <button onclick="downloadBatchReportTXT()" style="padding:8px 16px; font-size:11px; background:#4a90e2; color:white; border:none; border-radius:3px; cursor:pointer; display:flex; align-items:center; gap:6px;">
                        <i class="fas fa-file-alt"></i> Text (TXT)
                    </button>
                </div>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button onclick="closeBatchReportDialog()" style="padding:6px 12px; font-size:10px; background:#6c757d; color:white; border:none; border-radius:3px; cursor:pointer;">Cancel</button>
                </div>
            `;
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);
            
            // Store reference to close later
            window.batchReportOverlay = overlay;
            
            // Close on overlay click
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) closeBatchReportDialog();
            });
        }
        
        function closeBatchReportDialog() {
            if (window.batchReportOverlay) {
                document.body.removeChild(window.batchReportOverlay);
                window.batchReportOverlay = null;
            }
        }
        
        function downloadBatchReportExcel() {
            // Build CSV content for Excel
            let csvContent = '';
            
            // Column headers
            csvContent += 'No,Player Name,Players Index,Index Category,Prize Money Won,Stableford Points Scored,Swindle Finishing Position,Players Previous Index,Total Adjustment,Players New Index,Course Handicap (White),Course Handicap (Yellow)\n';
            
            // Add each row
            const tbody = document.getElementById('batch-calculator-body');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, idx) => {
                    const cells = row.cells;
                    const no = cells[0].textContent;
                    const name = cells[1].textContent;
                    const index = cells[2].querySelector('input')?.value || '';
                    const category = cells[3].textContent;
                    const prize = cells[4].querySelector('input')?.value || '0';
                    const stableford = cells[5].querySelector('input')?.value || '';
                    const position = cells[6].querySelector('input')?.value || '';
                    const prevIndex = cells[9].textContent;
                    const adjustment = cells[10].textContent;
                    const newIndex = cells[11].textContent;
                    const whiteHcap = cells[12].textContent;
                    const yellowHcap = cells[13].textContent;
                    
                    csvContent += `${no},"${name}",${index},"${category}",${prize},${stableford},${position},${prevIndex},${adjustment},${newIndex},${whiteHcap},${yellowHcap}\n`;
                });
            }
            
            // Download file as CSV with UTF-8 BOM for proper Excel encoding
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            a.download = `HCAP_Batch_Report_${timestamp}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeBatchReportDialog();
            alert('Excel CSV report downloaded successfully!');
        }
        
        function downloadBatchReportTXT() {
            // Build TXT report in table format
            let txtContent = '';
            txtContent += '================================================================================\n';
            txtContent += 'HCAP BATCH CALCULATOR REPORT\n';
            txtContent += `Generated: ${new Date().toLocaleString()}\n`;
            txtContent += '================================================================================\n\n';
            
            // Define column widths
            const colWidths = {
                no: 4,
                name: 22,
                index: 8,
                category: 10,
                prize: 8,
                stableford: 11,
                position: 10,
                prevIndex: 10,
                adjustment: 12,
                newIndex: 10,
                whiteHcap: 12,
                yellowHcap: 12
            };
            
            // Table headers
            txtContent += 'No'.padEnd(colWidths.no);
            txtContent += 'Player Name'.padEnd(colWidths.name);
            txtContent += 'Index'.padEnd(colWidths.index);
            txtContent += 'Category'.padEnd(colWidths.category);
            txtContent += 'Prize ¬£'.padEnd(colWidths.prize);
            txtContent += 'Stableford'.padEnd(colWidths.stableford);
            txtContent += 'Position'.padEnd(colWidths.position);
            txtContent += 'Prev Idx'.padEnd(colWidths.prevIndex);
            txtContent += 'Adjustment'.padEnd(colWidths.adjustment);
            txtContent += 'New Idx'.padEnd(colWidths.newIndex);
            txtContent += 'White H\'cap'.padEnd(colWidths.whiteHcap);
            txtContent += 'Yellow H\'cap\n';
            
            // Separator line
            const totalWidth = Object.values(colWidths).reduce((a, b) => a + b, 0);
            txtContent += '-'.repeat(totalWidth) + '\n';
            
            // Add each row
            const tbody = document.getElementById('batch-calculator-body');
            if (tbody) {
                const rows = tbody.querySelectorAll('tr');
                rows.forEach((row, idx) => {
                    const cells = row.cells;
                    const no = cells[0].textContent;
                    const name = cells[1].textContent.substring(0, colWidths.name - 1);
                    const index = cells[2].querySelector('input')?.value || '-';
                    const category = cells[3].textContent || '-';
                    const prize = cells[4].querySelector('input')?.value || '0';
                    const stableford = cells[5].querySelector('input')?.value || '-';
                    const position = cells[6].querySelector('input')?.value || '-';
                    const prevIndex = cells[9].textContent;
                    const adjustment = cells[10].textContent;
                    const newIndex = cells[11].textContent;
                    const whiteHcap = cells[12].textContent;
                    const yellowHcap = cells[13].textContent;
                    
                    txtContent += no.padEnd(colWidths.no);
                    txtContent += name.padEnd(colWidths.name);
                    txtContent += index.padEnd(colWidths.index);
                    txtContent += category.padEnd(colWidths.category);
                    txtContent += prize.padEnd(colWidths.prize);
                    txtContent += stableford.padEnd(colWidths.stableford);
                    txtContent += position.padEnd(colWidths.position);
                    txtContent += prevIndex.padEnd(colWidths.prevIndex);
                    txtContent += adjustment.padEnd(colWidths.adjustment);
                    txtContent += newIndex.padEnd(colWidths.newIndex);
                    txtContent += whiteHcap.padEnd(colWidths.whiteHcap);
                    txtContent += yellowHcap + '\n';
                });
            }
            
            txtContent += '-'.repeat(totalWidth) + '\n';
            txtContent += '\nGenerated by PGA League System\n';
            txtContent += '================================================================================\n';
            
            // Download file
            const blob = new Blob([txtContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').substring(0, 19);
            a.download = `HCAP_Batch_Report_${timestamp}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeBatchReportDialog();
            alert('Text report downloaded successfully!');
        }
        
        function importBatchCalculatorCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const lines = csvContent.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 4) {
                        alert('Invalid batch calculator CSV format');
                        return;
                    }
                    
                    let importedCount = 0;
                    
                    // Skip header rows (first 3 lines)
                    for (let i = 3; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.trim().replace(/^"|"$/g, ''));
                        if (values.length < 12) continue;
                        
                        const playerNo = parseInt(values[0]);
                        const playerName = values[1];
                        const playersIndex = values[2];
                        const prizeMoney = values[4];
                        const stableford = values[5];
                        const position = values[6];
                        
                        // Find matching player by name
                        const playerIdx = leaguePlayers.findIndex(p => 
                            p.name.toLowerCase().trim() === playerName.toLowerCase().trim()
                        );
                        
                        if (playerIdx !== -1) {
                            // Update the input fields
                            const indexEl = document.querySelector(`#batch-calculator-body [data-row="${playerIdx}"][data-field="index"]`);
                            const prizeEl = document.querySelector(`#batch-calculator-body [data-row="${playerIdx}"][data-field="prize"]`);
                            const pointsEl = document.querySelector(`#batch-calculator-body [data-row="${playerIdx}"][data-field="stableford"]`);
                            const posEl = document.querySelector(`#batch-calculator-body [data-row="${playerIdx}"][data-field="position"]`);
                            
                            if (indexEl) indexEl.value = playersIndex || '';
                            if (prizeEl) prizeEl.value = prizeMoney || '0';
                            if (pointsEl) pointsEl.value = stableford || '';
                            if (posEl) posEl.value = position || '';
                            
                            // Get current week's data array
                            if (!batchCalculatorDataByWeek[currentBatchWeek]) {
                                batchCalculatorDataByWeek[currentBatchWeek] = [];
                            }
                            const currentWeekData = batchCalculatorDataByWeek[currentBatchWeek];
                            
                            // Save to batch data for current week
                            if (!currentWeekData[playerIdx]) {
                                currentWeekData[playerIdx] = {
                                    index: '',
                                    prize: 0,
                                    stableford: '',
                                    position: '',
                                    teeWhite: true,
                                    teeYellow: true
                                };
                            }
                            currentWeekData[playerIdx].index = playersIndex || '';
                            currentWeekData[playerIdx].prize = prizeMoney || 0;
                            currentWeekData[playerIdx].stableford = stableford || '';
                            currentWeekData[playerIdx].position = position || '';
                            
                            // Trigger recalculation
                            recalcBatchRow(playerIdx);
                            importedCount++;
                        }
                    }
                    
                    if (importedCount > 0) {
                        saveBatchCalculatorData();
                        alert(`Successfully imported data for ${importedCount} player(s)!`);
                    } else {
                        alert('No matching players found in CSV file.');
                    }
                } catch (error) {
                    console.error('Batch calculator import error:', error);
                    alert('Error importing CSV: ' + error.message);
                }
                event.target.value = '';
            };
            reader.readAsText(file);
            document.getElementById('batchCSVDropdown').classList.remove('show');
        }
        
        // ============================================
        // BATCH HANDICAP REPORT GENERATOR
        // ============================================
        
        function generateBatchHandicapReport() {
            console.log('Generate Batch Handicap Report called');
            console.log('Current week:', currentWeek);
            
            // Use the current scorecard week
            const week = currentWeek || 1;
            const weekKey = `week${week}`;
            const weekData = allWeeksScorecardData[weekKey];
            
            if (!weekData || !weekData.players || weekData.players.length === 0) {
                alert(`No scorecard data found for Week ${week}.\n\nPlease add players to the Scorecard tab first.`);
                return;
            }
            
            let reportText = '';
            reportText += '================================================================================\n';
            reportText += `PGA H/Caps: Week ${week}\n`;
            reportText += '================================================================================\n\n';
            
            // Table header
            const nameWidth = 30;
            const indexWidth = 10;
            const changeWidth = 12;
            const capWidth = 12;
            
            reportText += 'Name'.padEnd(nameWidth) + 
                         'PGA Index'.padEnd(indexWidth) + 
                         'Change'.padEnd(changeWidth) + 
                         'PGA P/H Cap'.padEnd(capWidth) + 
                         'PGA P/H Cap\n';
            reportText += ''.padEnd(nameWidth) + 
                         ''.padEnd(indexWidth) + 
                         'since last'.padEnd(changeWidth) + 
                         'White Tees'.padEnd(capWidth) + 
                         'Yellow Tees\n';
            reportText += ''.padEnd(nameWidth) + 
                         ''.padEnd(indexWidth) + 
                         'round'.padEnd(changeWidth) + 
                         ''.padEnd(capWidth) + 
                         '\n';
            reportText += '-'.repeat(76) + '\n';
            
            // Get previous week data to calculate change
            const prevWeekKey = `week${week - 1}`;
            const prevWeekData = allWeeksScorecardData[prevWeekKey];
            const prevIndexMap = {};
            if (prevWeekData && prevWeekData.players) {
                prevWeekData.players.forEach(p => {
                    prevIndexMap[p.name] = parseFloat(p.pgaIndex) || 0;
                });
            }
                
            // Get all 40 league players as base
            const allLeaguePlayers = leaguePlayers.map(lp => lp.name);
            
            // Create a map of players who played this week
            const playedPlayersMap = new Map();
            
            // Process each player who played and calculate handicaps
            const playerResults = [];
            
            weekData.players.forEach(player => {
                    const playerName = player.name;
                    const pgaIndex = parseFloat(player.pgaIndex) || 0;
                    const handicap = parseFloat(player.handicap) || 0;
                    const prizeMoney = parseFloat(player.prizeMoney) || 0;
                    
                    // Calculate Stableford score
                    let stablefordTotal = 0;
                    for (let hole = 0; hole < 18; hole++) {
                        const score = parseInt(player.scores[hole]) || 0;
                        if (score > 0) {
                            const par = globalParValues[hole] || 4;
                            const holeIndex = globalIndexValues[hole] || (hole + 1);
                            
                            const handicapStrokes = Math.floor(handicap / 18);
                            const extraStrokeHole = (handicap % 18) >= holeIndex ? 1 : 0;
                            const strokesReceived = handicapStrokes + extraStrokeHole;
                            const adjustedPar = par + strokesReceived;
                            const diff = score - adjustedPar;
                            
                            let points = 0;
                            if (diff <= -2) points = 4;
                            else if (diff === -1) points = 3;
                            else if (diff === 0) points = 2;
                            else if (diff === 1) points = 1;
                            
                            stablefordTotal += points;
                        }
                    }
                    
                // Get previous index for this player
                const previousIndex = prevIndexMap[playerName] || pgaIndex;
                
                // Calculate category
                const category = calculateGolfIndexCategory(pgaIndex);
                
                // Determine finishing position (simplified - could be enhanced)
                const finishingPosition = prizeMoney > 0 ? 1 : 4; // Assume 1st if won money, 4th otherwise
                    
                    // Calculate adjustments
                    let stage1 = 0;
                    if (prizeMoney > 0 && stablefordTotal > golfParams.winThreshold) {
                        const baseCut = golfParams.cutBase + (category / golfParams.cutCatDivisor) + (pgaIndex * golfParams.cutIndexPercent);
                        stage1 = - (baseCut / finishingPosition);
                    }
                    
                    let stage2 = 0;
                    if (prizeMoney === 0 && stablefordTotal < golfParams.noWinThreshold && category > 0) {
                        stage2 = (pgaIndex * golfParams.incIndexPercent) + golfParams.incAddValue + (category / golfParams.incCatDivisor);
                    }
                    
                    let stage3 = 0;
                    if (stablefordTotal > golfParams.exceptionalThreshold) {
                        const pointsOver = stablefordTotal - golfParams.exceptionalThreshold;
                        stage3 = - ((category / golfParams.excCatDivisor) + (pgaIndex * golfParams.excIndexPercent)) * pointsOver;
                    }
                    
                    const totalAdjustment = stage1 + stage2 + stage3;
                    let newIndex = pgaIndex + totalAdjustment;
                    if (newIndex > golfParams.maxIndex) {
                        newIndex = golfParams.maxIndex;
                    }
                    newIndex = Math.round(newIndex * 10) / 10;
                    
                    // Calculate course handicaps
                    const whiteHandicap = Math.round((newIndex * golfCourses.White.slope / 113) + (golfCourses.White.rating - golfCourses.White.par));
                    const yellowHandicap = Math.round((newIndex * golfCourses.Yellow.slope / 113) + (golfCourses.Yellow.rating - golfCourses.Yellow.par));
                    
                // Change indicator - use simple text without symbols for alignment
                const change = newIndex - previousIndex;
                let changeIndicator = '';
                if (change > 0) {
                    changeIndicator = '+' + change.toFixed(1);
                } else if (change < 0) {
                    changeIndicator = change.toFixed(1);  // Negative sign already included
                } else {
                    changeIndicator = '0.0';
                }
                
                // Store result for sorting
                playedPlayersMap.set(playerName, {
                    name: playerName,
                    index: newIndex,
                    change: changeIndicator,
                    changeNumeric: change,  // For H'CAP Calculator
                    whiteHandicap: whiteHandicap,
                    yellowHandicap: yellowHandicap
                });
            });
            
            // Now add ALL 40 league players to results
            allLeaguePlayers.forEach(leaguePlayerName => {
                if (playedPlayersMap.has(leaguePlayerName)) {
                    // Player played - use calculated values
                    playerResults.push(playedPlayersMap.get(leaguePlayerName));
                } else {
                    // Player didn't play - use handicap data if available, otherwise 0
                    let currentIndex = 0;
                    let whiteHandicap = 0;
                    let yellowHandicap = 0;
                    
                    // Try to get current handicap from handicapPlayerData
                    if (handicapPlayerData && handicapPlayerData.length > 0) {
                        const handicapInfo = handicapPlayerData.find(hp => 
                            hp.name.toLowerCase().trim() === leaguePlayerName.toLowerCase().trim()
                        );
                        if (handicapInfo) {
                            currentIndex = parseFloat(handicapInfo.pgaIndex) || 0;
                            whiteHandicap = parseInt(handicapInfo.whiteTees) || 0;
                            yellowHandicap = parseInt(handicapInfo.yellowTees) || 0;
                        }
                    }
                    
                    playerResults.push({
                        name: leaguePlayerName,
                        index: currentIndex,
                        change: '0.0',
                        changeNumeric: 0,  // For H'CAP Calculator
                        whiteHandicap: whiteHandicap,
                        yellowHandicap: yellowHandicap
                    });
                }
            });
            
            // Sort players by name
            playerResults.sort((a, b) => a.name.localeCompare(b.name));
            
            // Store results globally for H'CAP Calculator to use
            window.latestHandicapCalculations = new Map();
            playerResults.forEach(player => {
                window.latestHandicapCalculations.set(player.name, {
                    newIndex: player.index,
                    change: player.changeNumeric || 0
                });
            });
            
            // Add table rows
            playerResults.forEach(player => {
                const nameStr = player.name.substring(0, nameWidth - 1).padEnd(nameWidth);
                const indexStr = player.index.toFixed(1).padEnd(indexWidth);
                const changeStr = player.change.padEnd(changeWidth);
                const whiteStr = player.whiteHandicap.toString().padEnd(capWidth);
                const yellowStr = player.yellowHandicap.toString();
                
                reportText += nameStr + indexStr + changeStr + whiteStr + yellowStr + '\n';
            });
            
            reportText += '-'.repeat(76) + '\n';
            reportText += '\n';
            reportText += 'Generated: ' + new Date().toLocaleString() + '\n';
            
            // Create and download the file
            const blob = new Blob([reportText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `PGA_HCaps_Week${week}_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`Handicap report generated for Week ${week}!\n\nFile: PGA_HCaps_Week${week}_${new Date().toISOString().split('T')[0]}.txt`);
        }
        
        window.addEventListener('resize', function() {
            if (document.getElementById('league-tab').classList.contains('active')) {
                adjustTableWidth();
            }
        });
        
        // ============================================
        // INITIALIZATION
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date for scorecard
            const today = new Date();
            const formattedDate = today.toISOString().split('T')[0];
            document.getElementById('scorecardDate').value = formattedDate;
            scorecardData.date = formattedDate;
            
            // Initialize with league tab
            const activeTab = localStorage.getItem('activeTab') || 'league';
            switchTab(activeTab);
            
            // Initialize league data
            playerData = generatePlayerData();
            loadBestCountSetting();
            calculateAllTotals();
            
            // Populate Golf Handicap Calculator player dropdown
            populateGolfPlayerDropdown();
            
            // Load calculation parameters from localStorage
            loadCalculationParameters();
            
            // Initialize handicap data
            loadHandicapData();
            
            // Initialize scorecard data - load first, then initialize selector
            loadScorecardData();
            initializeWeekSelector();
            renderScorecard();
            
            // Initialize calculator data
            loadCalculatorData();
            initializeCalculatorWeekSelector();
            renderCalculatorTable();
            
            // Initialize winners data
            loadWinnersData();
            initializeWinnersWeekSelector();
            renderWinnersTable();
            // Initialize Profit & Loss section (always visible)
            calculateProfitLoss();
            
            // Initialize theme
            loadTheme();
            
            // Initialize season data
            loadSeasonData();
            
            // Set up league event listeners
            document.getElementById('add-player-btn').addEventListener('click', addLeaguePlayer);
            document.getElementById('calculate-btn').addEventListener('click', calculateAllTotals);
            document.getElementById('reset-btn').addEventListener('click', resetLeagueData);
            document.getElementById('adjust-weeks-btn').addEventListener('click', adjustTotalWeeks);
            
            // Season selector listeners
            document.getElementById('season-selector').addEventListener('change', function(e) {
                seasonData.season = e.target.value;
                saveSeasonData();
            });
            document.getElementById('season-start-date').addEventListener('change', function(e) {
                seasonData.startDate = e.target.value;
                saveSeasonData();
            });
            document.getElementById('season-end-date').addEventListener('change', function(e) {
                seasonData.endDate = e.target.value;
                saveSeasonData();
            });
            
            // Scorecard form field listeners
            document.getElementById('courseName').addEventListener('change', saveScorecardData);
            document.getElementById('scorecardDate').addEventListener('change', saveScorecardData);
            document.getElementById('competitionName').addEventListener('change', saveScorecardData);
            
            // Close dropdowns when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.theme-selector')) {
                    document.getElementById('themeDropdown').classList.remove('show');
                }
                if (!e.target.closest('.best-scores-selector')) {
                    document.getElementById('bestScoresDropdown').classList.remove('show');
                }
                // Close League CSV dropdown
                const leagueCSVSelector = document.querySelector('.best-scores-selector[onclick="toggleLeagueCSVDropdown()"]');
                if (leagueCSVSelector && !e.target.closest('.best-scores-selector[onclick="toggleLeagueCSVDropdown()"]')) {
                    document.getElementById('leagueCSVDropdown').classList.remove('show');
                }
                // Close Scorecard CSV dropdown
                const scorecardCSVSelector = document.querySelector('.best-scores-selector[onclick="toggleScorecardCSVDropdown()"]');
                if (scorecardCSVSelector && !e.target.closest('.best-scores-selector[onclick="toggleScorecardCSVDropdown()"]')) {
                    document.getElementById('scorecardCSVDropdown').classList.remove('show');
                }
                // Close Batch Calculator CSV dropdown
                const batchCSVSelector = document.querySelector('.best-scores-selector[onclick="toggleBatchCSVDropdown()"]');
                if (batchCSVSelector && !e.target.closest('.best-scores-selector[onclick="toggleBatchCSVDropdown()"]')) {
                    document.getElementById('batchCSVDropdown').classList.remove('show');
                }
            });
            
            // Initial table adjustment
            setTimeout(() => {
                if (document.getElementById('league-tab').classList.contains('active')) {
                    adjustTableWidth();
                }
            }, 100);
        });
        
        // ============================================
        // HOW TO GUIDE FUNCTIONS
        // ============================================
        
        function showHowToGuide() {
            document.getElementById('howToModal').classList.add('show');
        }
        
        function closeHowToGuide() {
            document.getElementById('howToModal').classList.remove('show');
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('howToModal');
            if (e.target === modal) {
                closeHowToGuide();
            }
        });
    </script>
    
    <!-- HOW TO MODAL -->
    <div id="howToModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2><i class="fas fa-book-open"></i> HOW TO USE - PGA League System</h2>
                <button class="modal-close" onclick="closeHowToGuide()">√ó</button>
            </div>
            <div class="modal-body">
                <h3><i class="fas fa-info-circle"></i> Welcome to PGA League System</h3>
                <p><strong>This guide will teach you EVERYTHING from scratch.</strong> Even if you've never used this app before, follow these instructions step-by-step and you'll become an expert.</p>
                <p>The app has <strong>6 TABS</strong> at the top: <strong>League</strong>, <strong>Handicap</strong>, <strong>Scorecard</strong>, <strong>Winners</strong>, <strong>STATS</strong>, and <strong>SWINDLE Prizes</strong>.</p>
                
                <div class="warning-box">
                    <strong>‚ö†Ô∏è FIRST TIME USER?</strong> Start by reading the "Getting Started" section below, then read each tab section in order.
                </div>
                
                <h3><i class="fas fa-play-circle"></i> GETTING STARTED (Read This First!)</h3>
                <div class="guide-section">
                    <h4>Understanding the Header Buttons</h4>
                    <p>At the very top of the screen (green header), you'll see these buttons:</p>
                    <ul>
                        <li><strong>üü° Backup Button:</strong> Click this to save ALL your data to a file on your computer
                            <ol>
                                <li>Click the "Backup" button</li>
                                <li>A file called "pga_league_backup_[date].json" will download</li>
                                <li>Save this file somewhere safe (Desktop, Documents folder, etc.)</li>
                                <li>Do this regularly to avoid losing your data!</li>
                            </ol>
                        </li>
                        <li><strong>üü¢ Restore Button:</strong> Click this to load previously saved backup data
                            <ol>
                                <li>Click the "Restore" button</li>
                                <li>A file picker will open</li>
                                <li>Find and select your backup .json file</li>
                                <li>Click "Open"</li>
                                <li>All your data will be restored instantly</li>
                            </ol>
                        </li>
                        <li><strong>‚ùì HOW TO Button:</strong> Opens this help guide (you're reading it now!)</li>
                        <li><strong>üé® Theme Button:</strong> Changes the color scheme of the app
                            <ol>
                                <li>Click the "Theme" button</li>
                                <li>A dropdown menu appears with 10 different themes</li>
                                <li>Click any theme name to apply it instantly</li>
                                <li>Your choice is saved automatically</li>
                            </ol>
                        </li>
                    </ul>
                    
                    <h4>How the Tabs Work</h4>
                    <p>Click any tab name to switch between different sections. Each tab does something different:</p>
                    <ul>
                        <li><strong>League:</strong> Track season-long standings and scores</li>
                        <li><strong>Handicap:</strong> Import handicap data and create draw groups</li>
                        <li><strong>Scorecard:</strong> Record detailed hole-by-hole scores</li>
                        <li><strong>Winners:</strong> Calculate handicaps and manage prize money</li>
                        <li><strong>STATS:</strong> View player statistics across the season</li>
                        <li><strong>SWINDLE Prizes:</strong> See prize distribution table</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3><i class="fas fa-trophy"></i> TAB 1: LEAGUE (Season Standings)</h3>
                    <h4>What Does This Tab Do?</h4>
                    <p>This tab tracks your golf league standings across the entire season. It shows each player's weekly scores and calculates their total based on their BEST scores only (not all scores count!).</p>
                    
                    <h4>What You See on Screen</h4>
                    <p>At the top, you'll see:</p>
                    <ul>
                        <li><strong>Season Selector:</strong> Choose "PGA Winter League" or "PGA Summer League"</li>
                        <li><strong>Start/End Date Boxes:</strong> Set when your season begins and ends</li>
                        <li><strong>Players Count:</strong> Shows how many players are in the league (e.g., "Players: 40")</li>
                        <li><strong>Weeks Count:</strong> Shows total weeks (e.g., "Weeks: 25")</li>
                    </ul>
                    <p>Below that, you'll see many buttons. Here's what EACH button does:</p>
                    
                    <h4>EVERY BUTTON EXPLAINED (Step-by-Step)</h4>
                    
                    <p><strong>1. "Add Player" Button (Blue with + icon):</strong></p>
                    <ol>
                        <li>Click the button</li>
                        <li>A popup box appears asking "Enter player name:"</li>
                        <li>Type the player's full name (e.g., "John Smith")</li>
                        <li>Click OK</li>
                        <li>The player now appears as a new row in the table</li>
                        <li>They start with 0 scores in all weeks</li>
                    </ol>
                    
                    <p><strong>2. "Best X" Dropdown (Gold button with star icon):</strong></p>
                    <ol>
                        <li>Click the button that says "Best 10" (or whatever number is currently shown)</li>
                        <li>A dropdown menu appears showing options: Best 5, Best 6, Best 7... Best 15</li>
                        <li>Click the number you want (e.g., if you want only their best 10 weeks to count, click "Best 10")</li>
                        <li>The table instantly updates to show which scores count (they turn GOLD/GREEN)</li>
                        <li>The "Total" column recalculates using only that many top scores</li>
                    </ol>
                    
                    <p><strong>3. "Calculate" Button (Green button with calculator icon):</strong></p>
                    <ol>
                        <li>Click this button anytime you want to refresh all totals</li>
                        <li>It recalculates every player's "PLD" (weeks played), "Best" scores, and "Total"</li>
                        <li>Use this after manually editing scores</li>
                        <li>You'll see a brief flash as numbers update</li>
                    </ol>
                    
                    <p><strong>4. "CSV" Dropdown (Gold button):</strong></p>
                    <ul>
                        <li><strong>Export CSV:</strong>
                            <ol>
                                <li>Click "CSV" button</li>
                                <li>Click "Export CSV" from the dropdown</li>
                                <li>A file named "league_standings_[date].csv" downloads to your computer</li>
                                <li>Open it in Excel to see all player data in spreadsheet format</li>
                            </ol>
                        </li>
                        <li><strong>Import CSV:</strong>
                            <ol>
                                <li>Click "CSV" button</li>
                                <li>Click "Import CSV" from the dropdown</li>
                                <li>A file picker opens - select your CSV file</li>
                                <li>The system reads the CSV and matches player names</li>
                                <li>Scores are imported into the corresponding week columns</li>
                                <li>A message tells you how many players were imported</li>
                            </ol>
                        </li>
                    </ul>
                    
                    <p><strong>5. "Reset" Button (RED button with undo icon):</strong></p>
                    <ol>
                        <li>Click this button</li>
                        <li>A warning popup appears: "Are you sure you want to reset all league data?"</li>
                        <li>Click OK to DELETE ALL league data (players, scores, everything)</li>
                        <li>Click Cancel to keep your data safe</li>
                        <li><strong>WARNING:</strong> This cannot be undone! Make a backup first!</li>
                    </ol>
                    
                    <p><strong>6. "Weeks" Button (Gray button with calendar icon):</strong></p>
                    <ol>
                        <li>Click this button</li>
                        <li>A popup asks "Enter number of weeks:"</li>
                        <li>Type a number (e.g., "25" for 25 weeks)</li>
                        <li>Click OK</li>
                        <li>The table adds or removes week columns to match</li>
                        <li>If you reduce weeks, scores in removed weeks are deleted!</li>
                    </ol>
                    
                    <p><strong>7. "Player Scores" Button (Gold button with clipboard icon):</strong></p>
                    <ol>
                        <li>First, make sure you've recorded scores in the SCORECARD tab</li>
                        <li>Click this button</li>
                        <li>A popup asks "Import scores from which week?"</li>
                        <li>Type the week number (e.g., "5" for week 5)</li>
                        <li>Click OK</li>
                        <li>The system finds all players in that week's scorecard</li>
                        <li>It copies their Stableford total scores into the league table for that week</li>
                        <li>A message confirms how many scores were imported</li>
                    </ol>
                    
                    <p><strong>8. "Capture" Button (Gray button with camera icon):</strong></p>
                    <ol>
                        <li>Click this button</li>
                        <li>Wait 2-3 seconds while the system takes a screenshot</li>
                        <li>An image file downloads to your computer (usually named "league_table.png")</li>
                        <li>You can share this image on WhatsApp, email, etc.</li>
                    </ol>
                    
                    <h4>How to Enter/Edit Scores Manually</h4>
                    <ol>
                        <li>Find the player's row in the table</li>
                        <li>Find the week column (WK1, WK2, WK3, etc.)</li>
                        <li>Click on the cell where the player and week intersect</li>
                        <li>An input box appears - the number turns blue</li>
                        <li>Type the player's score (Stableford points, e.g., "35")</li>
                        <li>Press ENTER or TAB to move to the next cell</li>
                        <li>Press ESC to cancel without saving</li>
                        <li>The score is saved automatically</li>
                    </ol>
                    
                    <h4>Understanding the Color Codes</h4>
                    <ul>
                        <li><strong>RED cells:</strong> Low score (29 or less) - not great performance</li>
                        <li><strong>LIGHT GREEN cells:</strong> This score counts toward the player's total (it's one of their "Best X" scores)</li>
                        <li><strong>WHITE cells:</strong> Score exists but doesn't count (they have better scores in other weeks)</li>
                        <li><strong>Empty cells:</strong> No score entered for that week</li>
                    </ul>
                    
                    <h4>Understanding the Table Columns</h4>
                    <ul>
                        <li><strong>#:</strong> Player's current ranking (1 = first place, 2 = second place, etc.)</li>
                        <li><strong>Player:</strong> Player's name (click header to sort A-Z or Z-A)</li>
                        <li><strong>WK1, WK2, WK3... :</strong> Each week's score</li>
                        <li><strong>PLD:</strong> "Played" - how many weeks this player has scores for</li>
                        <li><strong>B10 (or Best):</strong> How many of their scores count toward total</li>
                        <li><strong>Total:</strong> Sum of their "Best X" scores (click header to sort by ranking)</li>
                        <li><strong>Action:</strong> Red X button to delete that player</li>
                    </ul>
                    
                    <h4>Quick Start Guide for League Tab</h4>
                    <p><strong>If you're brand new, follow these steps:</strong></p>
                    <ol>
                        <li>Click the "Add Player" button 5 times and add 5 different players</li>
                        <li>Click on WK1 for the first player and type "35", press Enter</li>
                        <li>Add a few more scores for different players and weeks</li>
                        <li>Click the "Calculate" button to see totals update</li>
                        <li>Try changing "Best 10" to "Best 5" and see how totals change</li>
                        <li>Practice makes perfect!</li>
                    </ol>
                    
                    <div class="tip-box">
                        <strong>Pro Tip:</strong> Always click "Calculate" after making changes. Use "Player Scores" button to automatically import from Scorecard instead of typing scores manually!
                    </div>
                </div>
                
                <div class="guide-section">
                    <h3><i class="fas fa-file-upload"></i> TAB 2: HANDICAP (Import Data & Create Draw)</h3>
                    <h4>What Does This Tab Do?</h4>
                    <p>This tab lets you upload handicap files (Excel, CSV, etc.), track who has paid ¬£5, and create random groups (draw) for golf rounds.</p>
                    
                    <h4>SECTION 1: Upload File (Top Section)</h4>
                    <p><strong>Step-by-Step: How to Upload a Handicap File</strong></p>
                    <ol>
                        <li>You should have a CSV file exported from the Winners tab (HCAP Batch Calculator)</li>
                        <li>Look for the blue upload box that says "Click to upload handicap file"</li>
                        <li>Click anywhere inside this blue box</li>
                        <li>A file picker window opens on your computer</li>
                        <li>Find your CSV file (it might be in Downloads folder)</li>
                        <li>Click the file to select it, then click "Open"</li>
                        <li>The file name appears above the upload box</li>
                        <li>BEFORE clicking Extract, you can check these two boxes if needed:
                            <ul>
                                <li><strong>Remove quotes:</strong> Tick this if player names have " " around them</li>
                                <li><strong>Remove default names:</strong> Tick this to skip generic names like "Golfer 1"</li>
                            </ul>
                        </li>
                        <li>Click the blue "Extract" button</li>
                        <li>Wait 1-2 seconds while the data loads</li>
                        <li>A table appears below with all the player data!</li>
                    </ol>
                    
                    <p><strong>"All ¬£5" and "All ¬£0" Buttons:</strong></p>
                    <ul>
                        <li><strong>"All ¬£5" Button (Gray):</strong>
                            <ol>
                                <li>Click this button</li>
                                <li>EVERY player in the table gets set to ¬£5 paid</li>
                                <li>All names turn GREEN (showing they've paid)</li>
                                <li>Use this if everyone has paid</li>
                            </ol>
                        </li>
                        <li><strong>"All ¬£0" Button (Gray):</strong>
                            <ol>
                                <li>Click this button</li>
                                <li>EVERY player gets set to ¬£0 (not paid)</li>
                                <li>All names turn RED (showing they haven't paid)</li>
                                <li>Use this to start fresh</li>
                            </ol>
                        </li>
                    </ul>
                    
                    <h4>SECTION 2: Extracted Data (The Table)</h4>
                    <p>After extracting, you'll see a table with 7 columns. Here's what each one means:</p>
                    <ol>
                        <li><strong>Paid:</strong> How much money the player paid (¬£5, ¬£0, etc.)
                            <ul>
                                <li>Click any number to change it</li>
                                <li>Type a new amount (e.g., "5" or "0")</li>
                                <li>Press Enter to save</li>
                                <li>GREEN = They paid</li>
                                <li>RED = They haven't paid</li>
                            </ul>
                        </li>
                        <li><strong>Players Name:</strong> The player's full name</li>
                        <li><strong>Players New Index:</strong> Their current handicap index</li>
                        <li><strong>Total Adjustment:</strong> How much their handicap changed</li>
                        <li><strong>Players Previous Index:</strong> What their handicap was before</li>
                        <li><strong>Course Handicap (White):</strong> Handicap for white tees</li>
                        <li><strong>Course Handicap (Yellow):</strong> Handicap for yellow tees</li>
                    </ol>
                    
                    <p><strong>Stats at the Top:</strong></p>
                    <ul>
                        <li>Shows total money collected (e.g., "¬£145")</li>
                        <li>Shows total number of players (e.g., "35")</li>
                        <li>Shows how many have paid (e.g., "29")</li>
                    </ul>
                    
                    <p><strong>Three Buttons Below the Table:</strong></p>
                    <ul>
                        <li><strong>"CSV" Button (Green):</strong>
                            <ol>
                                <li>Click this</li>
                                <li>A CSV file downloads with all the data</li>
                                <li>Open in Excel if you want to edit offline</li>
                            </ol>
                        </li>
                        <li><strong>"¬£5 Image" Button (Gray):</strong>
                            <ol>
                                <li>Click this</li>
                                <li>System takes a screenshot of ONLY players who paid ¬£5</li>
                                <li>Image file downloads</li>
                                <li>Share this image to show who's playing</li>
                            </ol>
                        </li>
                        <li><strong>"Clear" Button (RED):</strong>
                            <ol>
                                <li>Click this</li>
                                <li>Confirmation popup: "Are you sure?"</li>
                                <li>Click OK to delete ALL extracted data</li>
                                <li>The table becomes empty</li>
                                <li>Use this to start over</li>
                            </ol>
                        </li>
                    </ul>
                    
                    <h4>SECTION 3: Draw Management (Create Groups)</h4>
                    <p>This section creates random groups of 3-4 players for your golf round.</p>
                    
                    <p><strong>"Create" Button (Blue with + icon):</strong></p>
                    <ol>
                        <li>Make sure you've extracted player data first (see above)</li>
                        <li>Make sure players who ARE playing have ¬£5 in the "Paid" column</li>
                        <li>Click the "Create" button</li>
                        <li>The system finds all players who paid ¬£5</li>
                        <li>It randomly splits them into groups of 3 or 4 players</li>
                        <li>Groups appear below as colored boxes</li>
                        <li>Each group shows:
                            <ul>
                                <li>Group number (Group 1, Group 2, etc.)</li>
                                <li>How many players (e.g., "4" in a circle)</li>
                                <li>Tee box number (editable - click to change)</li>
                                <li>All player names with their handicaps</li>
                            </ul>
                        </li>
                    </ol>
                    
                    <p><strong>"Reshuffle" Button (Gray with shuffle icon):</strong></p>
                    <ol>
                        <li>You must have created groups first</li>
                        <li>Click this button</li>
                        <li>ALL groups are deleted</li>
                        <li>The system creates NEW random groups with the same players</li>
                        <li>Use this if you don't like the first draw</li>
                        <li>You can reshuffle as many times as you want</li>
                    </ol>
                    
                    <p><strong>"Capture" Button (Gray with camera icon):</strong></p>
                    <ol>
                        <li>Make sure groups are displayed on screen</li>
                        <li>Click this button</li>
                        <li>Wait 2-3 seconds</li>
                        <li>A PNG image downloads with all the groups</li>
                        <li>Share this image on WhatsApp or print it</li>
                    </ol>
                    
                    <h4>Working with Groups (After Creating Draw)</h4>
                    <p><strong>Each Group Box Shows:</strong></p>
                    <ul>
                        <li>Group title ("Group 1", "Group 2", etc.)</li>
                        <li>Number badge showing player count</li>
                        <li>Tee box input (click to type a number 1-20)</li>
                        <li>List of players with:
                            <ul>
                                <li>Player name in bold</li>
                                <li>Their index (e.g., "8.2")</li>
                                <li>White tees handicap (e.g., "W:10")</li>
                                <li>Yellow tees handicap (e.g., "Y:8")</li>
                                <li>Red √ó button to remove them</li>
                            </ul>
                        </li>
                    </ul>
                    
                    <p><strong>How to Edit Tee Box Number:</strong></p>
                    <ol>
                        <li>Find the group you want to change</li>
                        <li>Look for the small white box labeled "Tee:"</li>
                        <li>Click inside the box</li>
                        <li>Delete the old number</li>
                        <li>Type a new number (1-20)</li>
                        <li>Click outside the box or press Enter</li>
                        <li>The tee number is saved</li>
                    </ol>
                    
                    <p><strong>How to Remove a Player from a Group:</strong></p>
                    <ol>
                        <li>Find the player in the group</li>
                        <li>Look for the red √ó next to their name</li>
                        <li>Click the √ó</li>
                        <li>Confirmation: "Remove this player?"</li>
                        <li>Click OK</li>
                        <li>The player disappears from the group</li>
                    </ol>
                    
                    <p><strong>How to Move a Player Between Groups (Drag and Drop):</strong></p>
                    <ol>
                        <li>Click and HOLD on a player's name</li>
                        <li>While holding the mouse button, drag the player</li>
                        <li>Move your mouse over a different group</li>
                        <li>The destination group will highlight</li>
                        <li>Let go of the mouse button</li>
                        <li>The player now appears in the new group</li>
                    </ol>
                    
                    <h4>SECTION 4: Add Player to Draw (Bottom Form)</h4>
                    <p>Use this if you need to manually add someone who wasn't in the uploaded file.</p>
                    <ol>
                        <li>Scroll to the bottom of the Handicap tab</li>
                        <li>You'll see 6 input boxes in a row:</li>
                        <ul>
                            <li><strong>Paid:</strong> Type "5" if they paid, "0" if not</li>
                            <li><strong>Players Name:</strong> Type their full name</li>
                            <li><strong>Players New Index:</strong> Type their handicap index (e.g., "12.4")</li>
                            <li><strong>Players Previous Index:</strong> Type their old index (can leave blank)</li>
                            <li><strong>Course Handicap (White):</strong> Their handicap on white tees</li>
                            <li><strong>Course Handicap (Yellow):</strong> Their handicap on yellow tees</li>
                        </ul>
                        <li>Below the boxes, there's a "Group" dropdown - choose "Auto" (it will put them in a random group)</li>
                        <li>Click the blue "Add to Draw" button</li>
                        <li>The player is now added to the draw</li>
                        <li>If groups exist, they'll be added to a group automatically</li>
                    </ol>
                    
                    <h4>Complete Workflow for Handicap Tab</h4>
                    <p><strong>For Complete Beginners - Follow This Order:</strong></p>
                    <ol>
                        <li>Export CSV from Winners tab (HCAP Batch Calculator)</li>
                        <li>Come to Handicap tab</li>
                        <li>Click upload box and select your CSV file</li>
                        <li>Click "Extract" button</li>
                        <li>Click "All ¬£5" to mark everyone as paid (or edit individual amounts)</li>
                        <li>Click "Create" to make the draw</li>
                        <li>Review the groups - if you don't like them, click "Reshuffle"</li>
                        <li>Adjust tee boxes if needed</li>
                        <li>Click "Capture" to take a screenshot</li>
                        <li>Share the image with players!</li>
                    </ol>
                    
                    <div class="tip-box">
                        <strong>Pro Tip:</strong> Always upload the CSV from Winners tab (after using Batch Calculator) to get the most up-to-date handicaps. Only players marked as paid (¬£5) will be included in the draw!
                    </div>
                </div>
                
                <div class="guide-section">
                    <h3><i class="fas fa-clipboard-list"></i> TAB 3: SCORECARD (Record Hole-by-Hole Scores)</h3>
                    <h4>What Does This Tab Do?</h4>
                    <p>This tab records each player's score for all 18 holes and automatically calculates Stableford points. Each week's data is saved separately - you can have up to 25 weeks of scorecards!</p>
                    
                    <h4>IMPORTANT: Understanding Weeks</h4>
                    <div class="warning-box">
                        <strong>KEY CONCEPT:</strong> Each week (WK1, WK2, WK3...) stores its own separate scorecard. Week 1's players and scores are completely separate from Week 2's. Always check which week you've selected before entering data!
                    </div>
                    
                    <h4>Top Section: Course Information & Week Selection</h4>
                    <p><strong>"Week:" Dropdown (First thing you see):</strong></p>
                    <ol>
                        <li>Look at the very top left of the Scorecard tab</li>
                        <li>You'll see a dropdown that says "Week:" followed by "WK1" (or another week number)</li>
                        <li>Click this dropdown to see all available weeks (WK1 through WK25)</li>
                        <li>Click any week to switch to it</li>
                        <li>The entire scorecard changes to show that week's data</li>
                        <li><strong>REMEMBER:</strong> Always check you're on the correct week!</li>
                    </ol>
                    
                    <p><strong>Course Information Fields:</strong></p>
                    <ul>
                        <li><strong>"Course Name" box:</strong> Type the golf course name (e.g., "Lingfield Park")</li>
                        <li><strong>"Date" box:</strong> Click to open a calendar and select the date you played</li>
                        <li><strong>"Competition" box:</strong> Type the competition name (e.g., "PGA SWINDLE")</li>
                        <li><strong>"Save Course Info" button (Green):</strong>
                            <ol>
                                <li>After filling in the boxes above</li>
                                <li>Click this button</li>
                                <li>A message says "Course information saved"</li>
                                <li>This data is saved ONLY for the current week</li>
                            </ol>
                        </li>
                    </ul>
                    
                    <h4>ALL BUTTONS EXPLAINED (The Button Row)</h4>
                    <p><strong>1. "Add Player" Button (Blue with + icon):</strong></p>
                    <ol>
                        <li>Click the button</li>
                        <li>A popup asks: "Enter player name:"</li>
                        <li>Type the player's name (e.g., "John Smith")</li>
                        <li>Click OK</li>
                        <li>Another popup asks: "Enter player handicap (default: 0):"</li>
                        <li>Type their playing handicap (e.g., "12")</li>
                        <li>Click OK</li>
                        <li>More popups ask for: Index, White Tees handicap, Yellow Tees handicap</li>
                        <li>Fill each one in or just click OK to use defaults</li>
                        <li>The player now appears as a new row in the scorecard</li>
                    </ol>
                    
                    <p><strong>2. "Retrieve Draw Data" Button (Gold button):</strong></p>
                    <ol>
                        <li>First, make sure you've created a draw in the HANDICAP tab</li>
                        <li>Click this button</li>
                        <li>The system finds all players from the draw</li>
                        <li>A popup asks if you want to REPLACE existing players or ADD to them</li>
                        <li>Click OK to replace (deletes current players and adds draw players)</li>
                        <li>Click Cancel to add (keeps current players and adds draw players without duplicates)</li>
                        <li>A message tells you how many players were added</li>
                        <li>All draw players now appear in the scorecard with their handicaps</li>
                    </ol>
                    
                    <p><strong>3. "Fix Index Data" Button (Gold with wrench icon):</strong></p>
                    <ol>
                        <li>Use this if player handicaps look wrong</li>
                        <li>Click the button</li>
                        <li>System checks the Handicap tab draw data</li>
                        <li>It updates each player's Index and Tees handicaps to match the draw</li>
                        <li>A message says "Fixed Index/Tees data for X player(s)"</li>
                        <li>Useful if handicaps changed since you first added players</li>
                    </ol>
                    
                    <p><strong>4. "Calculate" Button (Green with calculator icon):</strong></p>
                    <ol>
                        <li>Click this anytime to recalculate all totals</li>
                        <li>It recalculates: Front 9, Back 9, Gross, Stableford, Countback for ALL players</li>
                        <li>Use this if numbers look wrong</li>
                        <li>Numbers update instantly</li>
                    </ol>
                    
                    <p><strong>5. "Clear All" Button (Gray with eraser icon):</strong></p>
                    <ol>
                        <li>Click this button</li>
                        <li>Warning popup: "Clear scorecard data for WKX? This will remove all players..."</li>
                        <li>Click OK to DELETE everything (players, scores, course info) for THIS week only</li>
                        <li>Click Cancel to keep your data</li>
                        <li><strong>WARNING:</strong> This only affects the current week - other weeks are safe</li>
                    </ol>
                    
                    <p><strong>6. "CSV" Dropdown (Gold button):</strong></p>
                    <ul>
                        <li><strong>Export CSV:</strong>
                            <ol>
                                <li>Click "CSV" button, then "Export CSV"</li>
                                <li>A file downloads named "scorecard_[date].csv"</li>
                                <li>Open in Excel to see all player scores</li>
                            </ol>
                        </li>
                        <li><strong>Import CSV:</strong>
                            <ol>
                                <li>Click "CSV" button, then "Import CSV"</li>
                                <li>Select your CSV file</li>
                                <li>WARNING: This DELETES all current players first!</li>
                                <li>Players from CSV are loaded into the scorecard</li>
                                <li>A message confirms how many players were imported</li>
                            </ol>
                        </li>
                    </ul>
                    
                    <p><strong>7. "Capture" Button (Gray with camera icon):</strong></p>
                    <ol>
                        <li>Click this button</li>
                        <li>Wait 2-3 seconds</li>
                        <li>A screenshot PNG file downloads</li>
                        <li>Shows the entire scorecard table</li>
                        <li>Share this image with players</li>
                    </ol>
                    
                    <h4>How to Enter Scores (The Main Scorecard Table)</h4>
                    <p><strong>Understanding the Table Layout:</strong></p>
                    <ul>
                        <li><strong>First Row: PAR</strong> - Shows par for each hole (3, 4, or 5)</li>
                        <li><strong>Second Row: INDEX</strong> - Shows stroke index for each hole (1-18)</li>
                        <li><strong>Player Rows:</strong> Each player gets TWO rows:
                            <ul>
                                <li><strong>Top row (white):</strong> Gross scores (actual strokes taken)</li>
                                <li><strong>Bottom row (gray):</strong> Stableford points (auto-calculated)</li>
                            </ul>
                        </li>
                    </ul>
                    
                    <p><strong>Step-by-Step: Entering a Player's Score:</strong></p>
                    <ol>
                        <li>Find the player's name in the left column</li>
                        <li>Look at their TOP row (this is for gross scores)</li>
                        <li>Find the column for Hole 1</li>
                        <li>Click in the white box under Hole 1</li>
                        <li>The box turns blue and you can type</li>
                        <li>Type the player's gross score (e.g., "5" for 5 strokes)</li>
                        <li>Press ENTER or TAB to move to the next hole</li>
                        <li>The cursor automatically moves to Hole 2</li>
                        <li>Keep typing scores and pressing ENTER for all 18 holes</li>
                        <li>After you enter each score, the gray row below shows Stableford points automatically</li>
                        <li>The Front 9, Back 9, Gross, and STBLFD columns update automatically</li>
                    </ol>
                    
                    <p><strong>Understanding Stableford Colors (The Gray Row):</strong></p>
                    <ul>
                        <li><strong>BLACK background:</strong> 2 points (Par)</li>
                        <li><strong>RED background:</strong> 3 points (Birdie)</li>
                        <li><strong>BLUE background:</strong> 4 points (Eagle or better)</li>
                        <li><strong>PURPLE background:</strong> 1 point (Bogey)</li>
                        <li><strong>PINK background:</strong> 0 points (Double bogey or worse)</li>
                        <li><strong>WHITE background:</strong> No score entered yet</li>
                    </ul>
                    
                    <p><strong>How to Edit PAR Values (If Playing Different Course):</strong></p>
                    <ol>
                        <li>Find the PAR row (first row of the table)</li>
                        <li>Click on any hole's par value (it's in a small white box)</li>
                        <li>The number turns blue</li>
                        <li>Delete it and type the new par (e.g., change "4" to "5")</li>
                        <li>Press ENTER or click outside the box</li>
                        <li>ALL players' Stableford points recalculate instantly</li>
                        <li>Repeat for any other holes that need changing</li>
                    </ol>
                    
                    <p><strong>How to Edit INDEX Values (Stroke Index):</strong></p>
                    <ol>
                        <li>Find the INDEX row (second row of the table)</li>
                        <li>Click on any hole's index value</li>
                        <li>Type the new stroke index (1-18)</li>
                        <li>Press ENTER</li>
                        <li>All Stableford calculations update based on new index</li>
                    </ol>
                    
                    <p><strong>How to Delete a Player:</strong></p>
                    <ol>
                        <li>Find the player's row</li>
                        <li>Look at the far right - there's a red trash can button</li>
                        <li>Click the trash can</li>
                        <li>Popup asks: "Remove player from scorecard?"</li>
                        <li>Click OK to delete</li>
                        <li>The player and all their scores are removed</li>
                    </ol>
                    
                    <h4>What Each Column Means</h4>
                    <ul>
                        <li><strong>Player:</strong> Player name with their handicap info below</li>
                        <li><strong>1-18:</strong> Each hole's gross score (top) and Stableford points (bottom)</li>
                        <li><strong>F9:</strong> Front 9 total (holes 1-9)</li>
                        <li><strong>B9:</strong> Back 9 total (holes 10-18)</li>
                        <li><strong>GROSS:</strong> Total of all 18 holes (gross score)</li>
                        <li><strong>STBLFD:</strong> Total Stableford points (click header to sort)</li>
                        <li><strong>CB 13-18:</strong> Countback - Stableford points for holes 13-18 (used for tiebreakers)</li>
                        <li><strong>CB 16-18:</strong> Countback - Stableford points for holes 16-18 (second tiebreaker)</li>
                        <li><strong>Action:</strong> Delete button</li>
                    </ul>
                    
                    <h4>Complete Workflow for Scorecard Tab</h4>
                    <p><strong>For Complete Beginners - Do This:</strong></p>
                    <ol>
                        <li>Click on Scorecard tab</li>
                        <li>Select the correct week from the dropdown (e.g., "WK5")</li>
                        <li>Enter Course Name, Date, and Competition name</li>
                        <li>Click "Save Course Info"</li>
                        <li>Click "Retrieve Draw Data" to load all players from Handicap tab</li>
                        <li>Click on first player, Hole 1, and start entering scores</li>
                        <li>Press ENTER after each score to move to next hole</li>
                        <li>Watch the Stableford points appear in colors below</li>
                        <li>Repeat for all players</li>
                        <li>Click "Calculate" to verify all totals are correct</li>
                        <li>Click "Capture" to save a screenshot</li>
                        <li>Done!</li>
                    </ol>
                    
                    <div class="tip-box">
                        <strong>Pro Tips:</strong> 
                        <ul>
                            <li>Use "Retrieve Draw Data" instead of adding players manually - it's much faster!</li>
                            <li>Press ENTER to quickly move through holes - no need to click each box</li>
                            <li>Stableford points calculate automatically - you just enter gross scores</li>
                            <li>Each week stores its own data separately - you won't lose previous weeks</li>
                        </ul>
                    </div>
                </div>
                
                <div class="guide-section">
                    <h3><i class="fas fa-calculator"></i> 4. WINNERS TAB</h3>
                    <h4>Purpose:</h4>
                    <p>Comprehensive prize management, handicap calculations, and batch processing for all 40 players.</p>
                    
                    <h4>H'CAP Calculator Section:</h4>
                    <ul>
                        <li><strong>Week Selector:</strong> Choose week to view calculations</li>
                        <li><strong>Show All Players:</strong> Toggle to display all 40 players or only those with scorecard data</li>
                        <li><strong>Refresh Data:</strong> Sync latest handicap data from Handicap tab</li>
                        <li><strong>Generate Report:</strong> Download .txt report with current week's handicap changes</li>
                    </ul>
                    <p>Table shows: Player name, Current index, Change amount, White/Yellow handicaps</p>
                    
                    <h4>Winners - Saturday Swindle Section:</h4>
                    <ul>
                        <li><strong>Week Selector:</strong> Choose week to manage (WK1-WK52)</li>
                        <li><strong>Import Scorecard Players:</strong> Auto-import from Scorecard tab (sorted by Stableford with countback)</li>
                        <li><strong>Clear Week:</strong> Delete winners for selected week only</li>
                        <li><strong>Clear ALL Weeks:</strong> Delete all winners data across all weeks</li>
                    </ul>
                    <p><strong>Winners Table:</strong> Position, Player Name, Prize (editable)</p>
                    <ul>
                        <li>Prizes auto-populate based on SWINDLE prize matrix</li>
                        <li>Click prize amounts to edit manually</li>
                        <li>Players sorted by Stableford score (highest first)</li>
                        <li>Ties broken using official countback system (see below)</li>
                    </ul>
                    
                    <h4>Countback System for Tie-Breaking:</h4>
                    <p>When players have equal Stableford scores, positions are determined using this sequence:</p>
                    <ol>
                        <li><strong>Highest Stableford score:</strong> Compare total Stableford points</li>
                        <li><strong>Back 9 (Holes 10-18):</strong> If tied, compare Stableford points on holes 10-18</li>
                        <li><strong>Holes 13-18 (Last 6 holes):</strong> If still tied, compare holes 13-18</li>
                        <li><strong>Holes 16,17,18 (Last 3 holes):</strong> If still tied, compare holes 16,17,18</li>
                        <li><strong>Holes 17,18 (Last 2 holes):</strong> If still tied, compare holes 17,18</li>
                        <li><strong>Hole 18 (Last 1 hole):</strong> If still tied, compare hole 18 only</li>
                        <li><strong>Front 9 (Holes 1-9):</strong> If still tied, compare holes 1-9</li>
                        <li><strong>Holes 4,5,6,7,8,9 (Last 6 holes):</strong> If still tied, compare holes 4-9</li>
                        <li><strong>Holes 7,8,9 (Last 3 holes):</strong> If still tied, compare holes 7,8,9</li>
                        <li><strong>Holes 8,9 (Last 2 holes):</strong> If still tied, compare holes 8,9</li>
                        <li><strong>Hole 9 (Last 1 hole):</strong> If still tied, compare hole 9 only</li>
                    </ol>
                    <p>At each step, the player with the higher Stableford points wins the tiebreaker.</p>
                    
                    <h4>Profit & Loss Section:</h4>
                    <p>Comprehensive financial tracking across entire season:</p>
                    <ul>
                        <li><strong>Weeks Played:</strong> Total weeks each player participated</li>
                        <li><strong>Total Loss:</strong> ¬£5 √ó weeks played</li>
                        <li><strong>Total Won:</strong> Sum of all prizes won across all weeks</li>
                        <li><strong>Profit/Loss:</strong> Net result (green = profit, red = loss)</li>
                        <li><strong>Download CSV:</strong> Export for Excel analysis</li>
                    </ul>
                    
                    <h4>Golf Handicap Cut & Increase Calculator (Individual):</h4>
                    <p>Single-player calculator with inputs:</p>
                    <ul>
                        <li><strong>Player Dropdown:</strong> Select from 40 default players</li>
                        <li><strong>Players Index:</strong> Current handicap index</li>
                        <li><strong>Index Category:</strong> Auto-calculated (0-5 based on index)</li>
                        <li><strong>Prize Money Won:</strong> Amount won in swindle</li>
                        <li><strong>Stableford Points:</strong> Total points scored</li>
                        <li><strong>Finishing Position:</strong> 1st, 2nd, 3rd, or 4th+</li>
                        <li><strong>Tee Selection:</strong> White or Yellow (affects course handicap)</li>
                    </ul>
                    <p><strong>Calculate Button:</strong> Computes Stage 1 (cut), Stage 2 (increase), Stage 3 (exceptional), Total Adjustment, New Index, and Course Handicaps</p>
                    
                    <h4>üìê HANDICAP CALCULATION FORMULAS (Detailed):</h4>
                    <div class="warning-box">
                        <strong>Understanding the Math:</strong> These formulas determine how your handicap changes after each round.
                    </div>
                    
                    <p><strong>INDEX CATEGORIES:</strong></p>
                    <ul style="margin-bottom: 15px;">
                        <li><strong>Cat 1:</strong> Index ‚â§ -0.1 (plus handicaps)</li>
                        <li><strong>Cat 2:</strong> Index 0.0 to 4.9</li>
                        <li><strong>Cat 3:</strong> Index 5.0 to 9.9</li>
                        <li><strong>Cat 4:</strong> Index 10.0 and above</li>
                    </ul>
                    
                    <p><strong>STAGE 1 - HANDICAP CUT (When you win money AND score > 29):</strong></p>
                    <p><code>Base Cut = 0.8 + (Category √∑ 40) + (Index √ó 0.02)</code></p>
                    <p><code>Stage 1 = -(Base Cut √∑ Finishing Position)</code></p>
                    <ul>
                        <li>1st place: Gets full cut</li>
                        <li>2nd place: Gets half the cut</li>
                        <li>3rd place: Gets one-third the cut</li>
                        <li>4th place: Gets one-quarter the cut</li>
                    </ul>
                    <p><em>Example: Index 8.2, Cat 3, 1st place ‚Üí Base Cut = 0.8 + (3√∑40) + (8.2√ó0.02) = 1.039 ‚Üí Stage 1 = -1.039</em></p>
                    
                    <p><strong>STAGE 2 - HANDICAP INCREASE (When you don't win AND score < 31):</strong></p>
                    <p><code>Stage 2 = (Index √ó 0.02) + 0.2 + (Category √∑ 30)</code></p>
                    <ul>
                        <li>Only applies if Category > 0 (Cat 1 excluded)</li>
                        <li>Only applies if player has played (stableford > 0)</li>
                        <li>Higher handicaps get bigger increases</li>
                    </ul>
                    <p><em>Example: Index 13.8, Cat 4, scored 29 ‚Üí Stage 2 = (13.8√ó0.02) + 0.2 + (4√∑30) = 0.61</em></p>
                    
                    <p><strong>STAGE 3 - EXCEPTIONAL CUT (When you score > 36):</strong></p>
                    <p><code>Stage 3 = -[((Category √∑ 10) + (Index √ó 0.0225)) √ó Points Over 36]</code></p>
                    <ul>
                        <li>Extra cut for exceptional performance</li>
                        <li>Multiplied by points scored over 36</li>
                    </ul>
                    <p><em>Example: Index 9.5, Cat 3, scored 42 ‚Üí Points Over = 6 ‚Üí Stage 3 = -[((3√∑10) + (9.5√ó0.0225)) √ó 6] = -2.58</em></p>
                    
                    <p><strong>TOTAL ADJUSTMENT:</strong></p>
                    <p><code>Total = Stage 1 + Stage 2 + Stage 3</code></p>
                    <p><code>New Index = Current Index + Total Adjustment (capped at 54.0)</code></p>
                    
                    <p><strong>COURSE HANDICAP CALCULATION:</strong></p>
                    <p><code>Course Handicap = Round[(New Index √ó Slope √∑ 113) + (Course Rating - Par)]</code></p>
                    <ul>
                        <li><strong>White Tees:</strong> Slope 128, Rating 71.5, Par 71</li>
                        <li><strong>Yellow Tees:</strong> Slope 123, Rating 70.1, Par 71</li>
                    </ul>
                    <p><em>Example: New Index 14.4, White Tees ‚Üí (14.4 √ó 128 √∑ 113) + (71.5 - 71) = 16.82 ‚Üí Rounds to 17</em></p>
                    
                    <div class="tip-box">
                        <strong>üí° Quick Summary:</strong>
                        <ul>
                            <li><strong>Win + Score > 29:</strong> Handicap goes DOWN (cut)</li>
                            <li><strong>No Win + Score < 31:</strong> Handicap goes UP (increase)</li>
                            <li><strong>Score > 36:</strong> Extra cut applied</li>
                            <li><strong>Didn't Play:</strong> No change (0.00 adjustment)</li>
                        </ul>
                    </div>
                    
                    <h4>HCAP Batch Calculator Section:</h4>
                    <p>Process all 40 players simultaneously with full data tracking across multiple weeks:</p>
                    <p><strong>Top Controls:</strong></p>
                    <ul>
                        <li><strong>Week Selector:</strong> Choose week WK1-WK25 (each week stores data independently)
                            <ul>
                                <li>Week data persists - switching weeks preserves all entered data</li>
                                <li>When switching to a NEW week, it automatically inherits the previous week's "Players New Index" as starting "Players Index"</li>
                                <li>All other fields (Prize Money, Stableford, Position) start blank for each new week</li>
                            </ul>
                        </li>
                        <li><strong>Import STBLFD Score:</strong> Import Stableford scores from any week's scorecard into current selected week</li>
                        <li><strong>Calculate Batch:</strong> Recalculate all 40 rows at once</li>
                        <li><strong>CSV Dropdown:</strong>
                            <ul>
                                <li><strong>Export CSV:</strong> Download complete batch data for current week (no header/footer text, direct to columns)</li>
                                <li><strong>Import CSV:</strong> Upload CSV to populate batch calculator fields by matching player names</li>
                            </ul>
                        </li>
                        <li><strong>Generate Report:</strong> Create Excel CSV or TXT format report for current week</li>
                    </ul>
                    <p><strong>Batch Calculator Table - 14 Columns:</strong></p>
                    <ol>
                        <li><strong>No:</strong> Player number (1-40)</li>
                        <li><strong>Player Name:</strong> Pre-populated with 40 default players</li>
                        <li><strong>Players Index:</strong> Editable input field</li>
                        <li><strong>Index Category:</strong> Auto-calculated (0-5)</li>
                        <li><strong>Prize Money Won:</strong> Editable input (triggers recalc)</li>
                        <li><strong>Stableford Points Scored:</strong> Editable input or imported</li>
                        <li><strong>Swindle Finishing Position:</strong> Editable input (1-4)</li>
                        <li><strong>Tee (White):</strong> Checkbox selection</li>
                        <li><strong>Tee (Yellow):</strong> Checkbox selection</li>
                        <li><strong>Players Previous Index:</strong> Auto-calculated</li>
                        <li><strong>Total Adjustment:</strong> Auto-calculated (Stage 1+2+3)</li>
                        <li><strong>Players New Index:</strong> Auto-calculated (capped at 54.0)</li>
                        <li><strong>Course Handicap (White):</strong> Auto-calculated</li>
                        <li><strong>Course Handicap (Yellow):</strong> Auto-calculated</li>
                    </ol>
                    <p><strong>Special Features:</strong></p>
                    <ul>
                        <li><strong>Sortable Columns:</strong> Click any column header (except tee checkboxes) to sort ascending/descending</li>
                        <li><strong>Enter Key Navigation:</strong> Press Enter in input fields to move cursor down to next row (same column)</li>
                        <li><strong>Auto-Save:</strong> All changes saved to localStorage immediately</li>
                        <li><strong>Persistent Data:</strong> Batch calculator data persists across sessions</li>
                    </ul>
                    
                    <div class="tip-box">
                        <strong>üí° Workflow Tip:</strong> Select correct week (e.g., WK2) ‚Üí Import Stableford scores from Scorecard ‚Üí Fill in prize money and positions ‚Üí Calculate Batch ‚Üí Export CSV ‚Üí Import CSV to Handicap tab for next week's draw creation. The next week (WK3) will automatically inherit WK2's calculated "Players New Index" values.
                    </div>
                </div>
                
                <div class="guide-section">
                    <h3><i class="fas fa-pound-sign"></i> 5. SWINDLE PRIZES TAB</h3>
                    <h4>Purpose:</h4>
                    <p>View the prize distribution matrix for different player counts.</p>
                    
                    <h4>How It Works:</h4>
                    <ul>
                        <li>Shows prize breakdown for 2-50 players</li>
                        <li>Each player contributes ¬£5 to the pot</li>
                        <li>Prizes distributed among top finishers (1st, 2nd, 3rd, 4th, 5th depending on player count)</li>
                        <li>This matrix is used automatically when importing players to Winners tab</li>
                    </ul>
                    
                    <p><strong>Example:</strong> With 17 players:</p>
                    <ul>
                        <li>Total pot = ¬£85</li>
                        <li>1st place = ¬£43</li>
                        <li>2nd place = ¬£26</li>
                        <li>3rd place = ¬£16</li>
                    </ul>
                </div>
                
                <div class="guide-section">
                    <h3><i class="fas fa-tools"></i> GENERAL FEATURES</h3>
                    
                    <h4>Data Management:</h4>
                    <ul>
                        <li><strong>Backup:</strong> Click the "Backup" button in the header to download all data as JSON</li>
                        <li><strong>Restore:</strong> Click "Restore" to upload a previously saved backup file</li>
                        <li><strong>Theme:</strong> Click "Theme" to choose from 10 different color schemes</li>
                    </ul>
                    
                    <div class="warning-box">
                        <strong>‚ö†Ô∏è Data Storage:</strong> All data is stored in your browser's local storage. Regular backups are recommended to prevent data loss!
                    </div>
                </div>
                
                <div class="guide-section">
                    <h3><i class="fas fa-lightbulb"></i> WORKFLOW RECOMMENDATIONS</h3>
                    
                    <h4>Weekly Process:</h4>
                    <ol>
                        <li><strong>Before the Round:</strong>
                            <ul>
                                <li>Go to Handicap tab</li>
                                <li>Upload latest handicap Excel file</li>
                                <li>Extract data and verify all players</li>
                                <li>Create draw for the day</li>
                                <li>Capture and share draw image</li>
                            </ul>
                        </li>
                        <li><strong>During/After the Round:</strong>
                            <ul>
                                <li>Go to Scorecard tab</li>
                                <li>Select current week</li>
                                <li>Add all players and enter their scores</li>
                                <li>Verify Stableford totals</li>
                                <li>Backup scorecard data</li>
                            </ul>
                        </li>
                        <li><strong>After the Round:</strong>
                            <ul>
                                <li>Go to Winners tab</li>
                                <li>Import players from Scorecard (auto-sorted by score)</li>
                                <li>Verify prize amounts (auto-populated)</li>
                                <li>Adjust prizes if needed</li>
                                <li>View Profit & Loss for season overview</li>
                            </ul>
                        </li>
                        <li><strong>League Update:</strong>
                            <ul>
                                <li>Go to League tab</li>
                                <li>Enter top Stableford scores for each player</li>
                                <li>Update standings</li>
                                <li>Export CSV if needed for sharing</li>
                            </ul>
                        </li>
                    </ol>
                </div>
                
                <div class="tip-box" style="margin-top: 30px;">
                    <strong>üéØ Need More Help?</strong><br>
                    If you encounter any issues or have questions, refer to this guide or contact the system administrator.
                </div>
            </div>
        </div>
    </div>
</body>
</html>
